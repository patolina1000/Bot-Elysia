<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Wizard - Multi-Bot Telegram</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 24px;
      color: #111827;
      display: flex;
      justify-content: center;
    }

    .layout {
      width: 100%;
      max-width: 960px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 25px 70px rgba(17, 24, 39, 0.35);
      padding: 28px 28px 40px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    header.top {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    header.top h1 {
      font-size: 32px;
      margin: 0 0 4px;
    }

    header.top p {
      margin: 0;
      color: #4b5563;
      font-size: 15px;
    }

    .token-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .token-card label {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
    }

    .token-input {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .token-input input {
      flex: 1 1 220px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #cbd5f5;
      font-size: 14px;
    }

    .as-readonly {
      cursor: not-allowed;
      opacity: 0.85;
      background-color: #f9fafb;
    }

    button,
    select,
    textarea,
    input {
      font-family: inherit;
    }

    .mono {
      font-family: 'SFMono-Regular', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
    }

    button {
      border: none;
      border-radius: 8px;
      background: #6366f1;
      color: #ffffff;
      font-weight: 600;
      padding: 10px 16px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    button:hover {
      background: #4f46e5;
    }

    button:disabled {
      background: #c7c9d6;
      cursor: not-allowed;
    }

    #media-cache-table {
      margin-top: 8px;
      font-size: 13px;
      overflow-x: auto;
    }

    #media-cache-table table {
      width: 100%;
      border-collapse: collapse;
      min-width: 420px;
    }

    #media-cache-table th,
    #media-cache-table td {
      text-align: left;
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
      word-break: break-all;
    }

    #media-cache-table th {
      background: #f9fafb;
      font-weight: 600;
      color: #111827;
    }

    #media-cache-table tbody tr:nth-child(even) td {
      background: #f3f4f6;
    }

    #media-cache-table .placeholder {
      color: #6b7280;
      font-style: italic;
      padding: 8px 4px;
    }

    .simple-card {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    main.card {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .muted {
      color: #6b7280;
    }

    .tiny {
      font-size: 12px;
    }

    .text-xs {
      font-size: 12px;
    }

    .opacity-70 {
      opacity: 0.7;
    }

    .mt-2 {
      margin-top: 8px;
    }

    #plans-card {
      margin-top: 24px;
    }

    #plans-card h2 {
      margin: 0;
      font-size: 22px;
      color: #111827;
    }

    #plans-card p.description {
      margin: 0;
      color: #4b5563;
      font-size: 14px;
    }

    #plans-card .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
    }

    #plans-card .form-row .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1 1 220px;
      min-width: 200px;
    }

    #plans-card .form-row .field.grow-2 {
      flex: 2 1 260px;
    }

    #plans-card input {
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 10px 12px;
      font-size: 14px;
      background: #ffffff;
      color: inherit;
    }

    #plans-card input[type='hidden'] {
      display: none;
    }

    #plans-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #plans-list .placeholder {
      border: 1px dashed #cbd5f5;
      border-radius: 10px;
      padding: 12px;
      font-size: 14px;
      color: #6b7280;
      background: #f8fafc;
    }

    #plans-list .plan-item {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    #plans-list .plan-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #plans-list .plan-info .plan-price {
      color: #6b7280;
      font-size: 13px;
    }

    #plans-list .plan-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    #plans-card .plan-hint {
      font-size: 12px;
      color: #6b7280;
    }

    /* Downsells */
    #downsells-card {
      margin-top: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
    }

    #downsells-card .downsells-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    #downsells-card .downsells-header h2 {
      margin: 0;
      font-size: 22px;
      color: #111827;
    }

    #downsells-card .downsells-header p {
      margin: 4px 0 0;
      color: #6b7280;
      font-size: 14px;
      max-width: 520px;
    }

    .downsells-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-gradient {
      background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
      color: #ffffff;
      padding: 10px 16px;
      border-radius: 12px;
      font-weight: 600;
      border: none;
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.35);
      transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
    }

    .btn-gradient:hover {
      filter: brightness(0.95);
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(59, 130, 246, 0.42);
    }

    .btn-outline {
      background: #f9fafb;
      color: #1f2937;
      border: 1px solid #d1d5db;
      padding: 9px 14px;
      border-radius: 12px;
      font-weight: 600;
      transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
    }

    .btn-outline:hover {
      background: #eef2ff;
      border-color: #6366f1;
      color: #111827;
    }

    #downsells-card .current-slug {
      font-size: 13px;
      color: #4b5563;
      display: flex;
      gap: 4px;
      align-items: center;
    }

    #downsells-card .current-slug strong {
      color: #111827;
    }

    #downsells-card #downsells-empty {
      border: 1px dashed #cbd5f5;
      border-radius: 14px;
      padding: 18px;
      text-align: center;
      font-size: 14px;
      color: #6b7280;
      background: #f8fafc;
    }

    #downsells-list {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .downsells-item {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .downsells-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 28px rgba(15, 23, 42, 0.12);
    }

    .downsells-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .downsells-item-price {
      font-weight: 600;
      color: #0f172a;
      font-size: 16px;
    }

    .downsells-item-moment {
      font-size: 12px;
      color: #6b7280;
    }

    .downsells-badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #1f2937;
    }

    .downsells-badge.active {
      border-color: #86efac;
      background: #dcfce7;
      color: #166534;
    }

    .downsells-image {
      width: 100%;
      max-height: 180px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
    }

    .downsells-item-copy {
      font-size: 13px;
      color: #374151;
      line-height: 1.5;
      white-space: pre-wrap;
      margin: 0;
    }

    .downsells-item-intro {
      display: inline-block;
      margin-top: 8px;
      font-size: 13px;
      color: #4b5563;
      background: #eef2ff;
      border-radius: 999px;
      padding: 4px 10px;
    }

    .downsells-item-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn-danger {
      background: #ef4444;
      color: #ffffff;
      padding: 8px 12px;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      transition: background 0.15s ease;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-soft {
      background: #ffffff;
      border: 1px solid #d1d5db;
      color: #1f2937;
      padding: 8px 12px;
      border-radius: 10px;
      font-weight: 600;
      transition: background 0.15s ease, border-color 0.15s ease;
    }

    .btn-soft:hover {
      background: #f1f5f9;
      border-color: #94a3b8;
    }

    .downsells-modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 48px 16px;
      z-index: 2000;
    }

    .downsells-modal .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
    }

    .downsells-modal .modal-content {
      position: relative;
      width: min(720px, 100%);
      background: #ffffff;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      box-shadow: 0 30px 60px rgba(15, 23, 42, 0.25);
      z-index: 1;
    }

    .downsells-modal .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .downsells-modal .modal-header h3 {
      margin: 0;
      font-size: 20px;
      color: #111827;
    }

    .downsells-modal .modal-body {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .downsells-modal .form-row {
      display: grid;
      gap: 12px;
    }

    .downsells-modal .form-row.double {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .downsells-modal .ds-additional-plans {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .downsells-modal .ds-additional-plans__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .downsells-modal .ds-additional-plans__actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .downsells-modal .ds-additional-plans__counter {
      font-size: 12px;
      color: #6b7280;
    }

    .downsells-modal .ds-additional-plans__title {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
    }

    .downsells-modal .ds-plans-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .downsells-modal .ds-plan-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 160px) auto;
      gap: 12px;
      align-items: end;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: #f9fafb;
    }

    .downsells-modal .ds-plan-row__field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-weight: 600;
      font-size: 14px;
      color: #1f2937;
    }

    .downsells-modal .ds-plan-row__field--price {
      width: min(100%, 160px);
    }

    .downsells-modal .ds-plan-row__label {
      font-size: 13px;
      font-weight: 600;
      color: #374151;
    }

    .downsells-modal .ds-plan-row__actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      align-items: center;
      flex-wrap: wrap;
    }

    @media (max-width: 520px) {
      .downsells-modal .ds-plan-row {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }

      .downsells-modal .ds-plan-row__actions {
        justify-content: flex-start;
      }
    }

    .downsells-modal label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-weight: 600;
      font-size: 14px;
      color: #1f2937;
    }

    .downsells-modal textarea,
    .downsells-modal select,
    .downsells-modal input[type="text"],
    .downsells-modal input[type="number"] {
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 10px 12px;
      font-size: 14px;
      background: #ffffff;
      color: inherit;
    }

    .downsells-modal textarea {
      resize: vertical;
      min-height: 120px;
    }

    .downsells-modal .file-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .downsells-modal .footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }

    .downsells-modal .footer button {
      min-width: 120px;
    }

    .downsells-modal .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #1f2937;
    }

    .downsells-modal .checkbox-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    @media (max-width: 640px) {
      #downsells-card {
        padding: 18px;
      }

      .downsells-modal {
        padding: 32px 12px;
      }

      .downsells-modal .modal-content {
        padding: 20px;
      }
    }

    @media (prefers-color-scheme: dark) {
      #downsells-card {
        background: #0f172a;
        border-color: #1e293b;
        box-shadow: 0 20px 45px rgba(2, 6, 23, 0.6);
      }

      #downsells-card .downsells-header h2 {
        color: #f8fafc;
      }

      #downsells-card .downsells-header p,
      #downsells-card .current-slug,
      #downsells-card .current-slug strong {
        color: #cbd5f5;
      }

      #downsells-card #downsells-empty {
        background: rgba(30, 41, 59, 0.6);
        border-color: rgba(99, 102, 241, 0.45);
        color: #e2e8f0;
      }

      .btn-outline {
        background: rgba(30, 41, 59, 0.6);
        border-color: #334155;
        color: #e2e8f0;
      }

      .btn-outline:hover {
        background: rgba(59, 130, 246, 0.15);
        border-color: #6366f1;
        color: #ffffff;
      }

      .downsells-item {
        background: rgba(15, 23, 42, 0.75);
        border-color: #1e293b;
        box-shadow: 0 20px 35px rgba(2, 6, 23, 0.65);
      }

      .downsells-item-price {
        color: #f8fafc;
      }

      .downsells-item-moment {
        color: #94a3b8;
      }

      .downsells-badge {
        background: rgba(15, 23, 42, 0.8);
        border-color: #334155;
        color: #e2e8f0;
      }

      .downsells-badge.active {
        background: rgba(22, 101, 52, 0.25);
        border-color: rgba(34, 197, 94, 0.65);
        color: #bbf7d0;
      }

      .downsells-image {
        border-color: #1e293b;
        background: rgba(15, 23, 42, 0.6);
      }

      .downsells-item-copy {
        color: #e2e8f0;
      }

      .btn-soft {
        background: rgba(30, 41, 59, 0.65);
        border-color: #334155;
        color: #e2e8f0;
      }

      .btn-soft:hover {
        background: rgba(59, 130, 246, 0.15);
        border-color: #475569;
        color: #ffffff;
      }

      .btn-danger {
        background: #ef4444;
      }

      .downsells-modal .modal-content {
        background: #0b1220;
        border-color: #1e293b;
        box-shadow: 0 35px 60px rgba(2, 6, 23, 0.7);
      }

      .downsells-modal .modal-header h3,
      .downsells-modal label,
      .downsells-modal .checkbox-row {
        color: #e2e8f0;
      }

      .downsells-modal textarea,
      .downsells-modal select,
      .downsells-modal input[type="text"] {
        background: rgba(15, 23, 42, 0.7);
        border-color: #334155;
        color: #e2e8f0;
      }

      .downsells-modal textarea::placeholder,
      .downsells-modal input::placeholder {
        color: #94a3b8;
      }
    }

    #plans-card hr {
      border: none;
      border-top: 1px solid #e5e7eb;
      margin: 8px 0 12px;
    }

    #pix-modal {
      max-width: 520px;
      width: 100%;
      padding: 24px;
    }

    #pix-modal h3 {
      margin: 0 0 12px;
      font-size: 20px;
    }

    #pix-modal textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 10px 12px;
      font-size: 13px;
      font-family: 'SFMono-Regular', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      resize: vertical;
      min-height: 90px;
    }

    #pix-modal img {
      max-width: 260px;
      width: 100%;
      height: auto;
      display: block;
      margin: 0 auto 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      padding: 8px;
    }

    #pix-modal .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
    }

    #pix-modal .pix-notice {
      font-size: 12px;
      color: #6b7280;
      margin-top: 12px;
      line-height: 1.5;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
    }

    .card-header h2 {
      margin: 0;
      font-size: 22px;
      color: #111827;
    }

    .card-header p {
      margin: 4px 0 0;
      color: #6b7280;
      font-size: 14px;
    }

    #tabs {
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid #e5e7eb;
    }

    #tabs-scroll {
      display: flex;
      overflow-x: auto;
      gap: 6px;
      padding: 6px 0;
      flex: 1 1 auto;
    }

    #tabs-scroll::-webkit-scrollbar {
      height: 6px;
    }

    #tabs-scroll::-webkit-scrollbar-thumb {
      background: rgba(79, 70, 229, 0.35);
      border-radius: 999px;
    }

    .tab {
      padding: 8px 12px;
      border-radius: 10px;
      background: #f3f4f6;
      cursor: pointer;
      white-space: nowrap;
      user-select: none;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .tab.active {
      background: #111827;
      color: #ffffff;
    }

    .tab .dirty {
      margin-left: 6px;
      color: #f59e0b;
      font-weight: 700;
    }

    #bot-actions {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }

    #bot-actions button {
      padding: 8px 12px;
      border-radius: 8px;
      background: #e5e7eb;
      color: #111827;
      font-size: 16px;
    }

    #bot-actions button:first-child {
      background: #6366f1;
      color: #ffffff;
    }

    #bot-actions button:first-child:hover {
      background: #4f46e5;
    }

    #bot-actions button:hover {
      background: #d1d5db;
    }

    #pane {
      padding-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .hidden {
      display: none !important;
    }

    #no-bots {
      border: 1px dashed #cbd5f5;
      border-radius: 12px;
      padding: 20px;
      color: #4b5563;
      background: #f8fafc;
      text-align: center;
      font-size: 14px;
    }

    #bot-header {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      font-size: 14px;
      color: #1f2937;
    }

    #bot-header > div {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    #bot-header code,
    #bot-header input {
      background: #11182710;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #cbd5f5;
      font-family: 'SFMono-Regular', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      font-size: 13px;
      color: #111827;
    }

    #bot-header input {
      flex: 1 1 auto;
      min-width: 140px;
      border: 1px solid #d1d5db;
      background: #ffffff;
    }

    #bot-header button {
      padding: 6px 10px;
      font-size: 14px;
      background: #e5e7eb;
      color: #1f2937;
    }

    #bot-header button:hover {
      background: #d1d5db;
    }

    .form-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
    }

    select,
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 10px 12px;
      font-size: 14px;
      background: #ffffff;
      color: inherit;
    }

    textarea {
      resize: vertical;
      min-height: 160px;
      line-height: 1.5;
    }

    #media-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #media-empty {
      border: 1px dashed #cbd5f5;
      border-radius: 10px;
      padding: 16px;
      text-align: center;
      color: #6b7280;
      font-size: 14px;
      background: #f8fafc;
    }

    .media-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      border: 1px solid #e5e5f7;
      border-radius: 12px;
      background: #f5f5ff;
    }

    .media-row select.media-type {
      width: 140px;
    }

    .media-row input.media-url {
      flex: 1 1 220px;
      min-width: 180px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }

    .media-file-btn {
      background: #eef2ff;
      border: 1px solid #c7d2fe;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      white-space: nowrap;
      font-size: 14px;
      color: #312e81;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 150px;
    }

    .media-file-btn:hover {
      background: #e0e7ff;
    }

    .dropzone {
      border: 1px dashed #c7d2fe;
      border-radius: 10px;
      padding: 12px;
      color: #4b5563;
      text-align: center;
      margin-top: 4px;
      font-size: 13px;
      transition: all 0.2s ease;
      width: 100%;
      flex-basis: 100%;
      background: #f8fafc;
    }

    .dropzone.dragover {
      background: #eef2ff;
      border-color: #6366f1;
      color: #1f2937;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #1f2937;
      padding: 8px 12px;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .actions {
      display: flex;
      justify-content: flex-end;
    }

    #save-start {
      padding: 12px 20px;
      font-size: 15px;
    }

    /* Repeater de mensagens iniciais */
    .start-msg-item {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
      background: #f9fafb;
    }
    .start-msg-item .msg-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .start-msg-item .msg-header strong {
      font-size: 14px;
      color: #374151;
    }
    .start-msg-item .msg-actions {
      display: flex;
      gap: 6px;
    }
    .start-msg-item .msg-actions button {
      padding: 4px 10px;
      font-size: 13px;
      background: #ffffff;
      border: 1px solid #d1d5db;
      color: #374151;
      border-radius: 6px;
      cursor: pointer;
    }
    .start-msg-item .msg-actions button:hover {
      background: #f3f4f6;
    }
    .start-msg-item .msg-actions button.remove {
      color: #dc2626;
      border-color: #fecaca;
    }
    .start-msg-item .msg-actions button.remove:hover {
      background: #fee2e2;
    }
    .start-msg-item textarea {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-family: inherit;
      resize: vertical;
    }

    dialog {
      border: none;
      border-radius: 12px;
      padding: 0;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 25px 70px rgba(17, 24, 39, 0.35);
    }

    dialog::backdrop {
      background: rgba(15, 23, 42, 0.45);
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 22px 26px 26px;
      min-width: 320px;
    }

    .modal-form h3 {
      margin: 0 0 8px;
      font-size: 20px;
      color: #111827;
    }

    .modal-form label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
    }

    .modal-form > button {
      align-self: flex-start;
    }

    .modal-form input[type='text'],
    .modal-form input[type='password'],
    .modal-form input[type='url'] {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    .modal-form menu {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin: 12px 0 0;
      padding: 0;
    }

    .modal-form menu button[value='cancel'] {
      background: #e5e7eb;
      color: #1f2937;
    }

    .modal-form menu button[value='cancel']:hover {
      background: #d1d5db;
    }

    #toast {
      position: fixed;
      top: 24px;
      right: 24px;
      background: #111827;
      color: #ffffff;
      padding: 12px 16px;
      border-radius: 10px;
      box-shadow: 0 15px 45px rgba(17, 24, 39, 0.4);
      font-size: 14px;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      pointer-events: none;
      z-index: 1000;
    }

    #toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .status {
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
    }

    .status.success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .status.info {
      background: #e0f2fe;
      color: #075985;
      border: 1px solid #bae6fd;
    }

    @media (max-width: 720px) {
      body {
        padding: 16px;
      }

      .layout {
        padding: 20px;
      }

      header.top {
        align-items: stretch;
      }

      .card-header {
        flex-direction: column;
        align-items: stretch;
      }

      #bot-header {
        grid-template-columns: 1fr;
      }

      .token-input {
        flex-direction: column;
        align-items: stretch;
      }

      .token-input input,
      .token-input button {
        width: 100%;
      }
    }
    /* Elysia theme overrides */
    :root{
      /* base */
      --bg:#0d1117;
      --card-dark:#121826;
      --on-dark:#e8eef7;
      --on-light:#0b1220;
      --muted-dark:#9fb2c8;
      --muted-light:#5b6b81;
      --primary1:#19c3ff;
      --primary2:#4b7cff;
      --ring: rgba(73,140,255,.45);
      --radius:14px;
      /* modal claro */
      --modal-bg:#ffffff;
      --modal-text:#0b1220;
      --modal-border:#e8edf7;
    }

    /* fundo da página é escuro, texto claro por padrão */
    body{ background:var(--bg); color:var(--on-dark) }

    /* === SUPERFÍCIES (contraste alto) === */
    /* Card CLARO (padrão): fundo branco, texto preto */
    .card{
      background:#ffffff;
      color:var(--on-light);
      border:1px solid #e8edf7;
      border-radius:var(--radius);
    }
    .card .muted{ color:var(--muted-light); }
    /* TÍTULOS/SEÇÕES: sempre alto contraste */
    .card h1,
    .card h2,
    .card h3,
    .card h4,
    .card h5,
    .card h6{
      color:var(--on-light);
      letter-spacing:-.015em;
    }
    .card.dark h1,
    .card.dark h2,
    .card.dark h3,
    .card.dark h4,
    .card.dark h5,
    .card.dark h6{
      color:var(--on-dark);
    }
    /* Labels e textos auxiliares */
    .card label,
    .card .label{ color:#0f172a; font-weight:600; }
    .card.dark label,
    .card.dark .label{ color:#e2e8f0; }
    .card .muted{ color:#334155; }
    .card .tiny.muted{ color:#475569; font-size:13px; }

    /* Card ESCURO (opcional): use class="card dark" onde quiser escuro */
    .card.dark{
      background:var(--card-dark);
      color:var(--on-dark);
      border:1px solid rgba(255,255,255,.06);
    }
    .card.dark .muted{ color:var(--muted-dark); }

    /* Inputs se adaptam à superfície do card onde estão */
    .card input,
    .card textarea,
    .card select{
      background:#ffffff;
      color:var(--on-light);
      border:1px solid #d0d7e2;
      border-radius:10px;
      padding:10px;
    }
    /* Placeholders legíveis */
    .card ::placeholder{ color:#64748b; opacity:1 }
    .card.dark ::placeholder{ color:#b6c2d3; opacity:1 }
    /* Desabilitados com contraste */
    .card input[disabled],
    .card textarea[disabled],
    .card select[disabled]{
      background:#f1f5f9;
      color:#475569;
      border-color:#e2e8f0;
    }
    .card.dark input,
    .card.dark textarea,
    .card.dark select{
      background:#0b1220;
      color:var(--on-dark);
      border:1px solid #263246;
    }
    .card input:focus,
    .card textarea:focus,
    .card select:focus{
      outline:none;
      box-shadow:0 0 0 3px var(--ring), 0 0 0 1px #2b3b57;
    }
    .card.dark input:focus,
    .card.dark textarea:focus,
    .card.dark select:focus{
      outline:none;
      box-shadow:0 0 0 3px var(--ring), 0 0 0 1px #2b3b57;
    }
    /* linhas divisórias visíveis */
    .card hr{ border:0; height:1px; background:#e2e8f0; margin:16px 0 }
    .card.dark hr{ background:#273244 }

    /* Botões */
    button{
      background:linear-gradient(135deg,var(--primary1),var(--primary2));
      color:#081018;
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:800;
    }
    button.secondary,
    .btn-secondary{
      background:#eef2f9;
      color:#0b1220;
      border:1px solid #d0d7e2;
    }

    /* Modal CLARO (força contraste) */
    .modal,
    dialog{
      background:var(--modal-bg)!important;
      color:var(--modal-text)!important;
      border:1px solid var(--modal-border)!important;
      border-radius:20px!important;
      box-shadow:0 20px 70px rgba(2,19,48,.35), 0 2px 8px rgba(2,19,48,.12)!important;
    }
    .modal h3,
    dialog h3{ font-weight:900; color:var(--modal-text)!important }
    dialog label{ color:#334155 }
    dialog input,
    dialog textarea,
    dialog select{
      background:#ffffff;
      color:var(--modal-text);
      border:1px solid #d0d7e2;
      border-radius:10px;
      padding:10px;
    }
    dialog input:focus,
    dialog textarea:focus,
    dialog select:focus{
      outline:none;
      box-shadow:0 0 0 3px rgba(47,128,237,.18), 0 0 0 1px #3b82f6;
      border-color:#3b82f6;
    }
    dialog .secondary{ background:#eef2f9; color:#0b1220; border:1px solid #d0d7e2 }
  </style>
  <!-- High-contrast fixes para o Admin Wizard -->
  <style id="aw-contrast-fixes">
    :root {
      --aw-fg: #111;
      --aw-muted: #444;
      --aw-bg: #fff;
    }

    /* Escopo: apenas elementos dentro do body desta página */
    #admin-wizard,
    #admin-wizard * {
      text-shadow: none !important;
    }

    /* Títulos, rótulos e textos principais */
    #admin-wizard h1,
    #admin-wizard h2,
    #admin-wizard h3,
    #admin-wizard h4,
    #admin-wizard h5,
    #admin-wizard h6,
    #admin-wizard label,
    #admin-wizard .form-label,
    #admin-wizard legend,
    #admin-wizard .section-title,
    #admin-wizard .field-title,
    #admin-wizard .card-title,
    #admin-wizard .text,
    #admin-wizard .title,
    #admin-wizard .text-body,
    #admin-wizard .subtitle {
      color: var(--aw-fg) !important;
    }

    /* Textos de apoio e placeholders */
    #admin-wizard small,
    #admin-wizard .form-text,
    #admin-wizard .help,
    #admin-wizard .hint,
    #admin-wizard .text-muted {
      color: var(--aw-muted) !important;
    }

    #admin-wizard ::placeholder {
      color: var(--aw-muted) !important;
      opacity: 1;
    }

    /* Inputs e campos com fundo claro */
    #admin-wizard input,
    #admin-wizard textarea,
    #admin-wizard select {
      color: var(--aw-fg) !important;
      background: var(--aw-bg) !important;
    }

    #admin-wizard .input-group-text {
      color: var(--aw-fg) !important;
      background: var(--aw-bg) !important;
    }

    /* Cards, painéis e modais */
    #admin-wizard .card,
    #admin-wizard .panel,
    #admin-wizard .modal-content {
      background: var(--aw-bg) !important;
      color: var(--aw-fg) !important;
    }

    #admin-wizard .modal-header,
    #admin-wizard .modal-body,
    #admin-wizard .modal-footer {
      background: var(--aw-bg) !important;
      color: var(--aw-fg) !important;
      border-color: #e5e7eb !important;
    }

    /* ====== Lista de planos ====== */
    /* Garante legibilidade do nome e do preço do plano */
    #admin-wizard #plans-list .plan-info,
    #admin-wizard #plans-list .plan-info * {
      color: var(--aw-fg) !important;   /* preto */
      opacity: 1 !important;            /* sem desbotar */
      text-shadow: none !important;
      filter: none !important;
    }
    /* Preço e status (ex.: "R$ 9,90 • ativo") */
    #admin-wizard #plans-list .plan-info .plan-price {
      color: var(--aw-fg) !important;
      opacity: 1 !important;
    }
    /* Nome do plano em leve destaque sem perder contraste */
    #admin-wizard #plans-list .plan-info > div:first-child {
      color: var(--aw-fg) !important;
      font-weight: 600; /* opcional, melhora leitura */
    }
    /* Não interferir nos botões da linha */
    #admin-wizard #plans-list .plan-actions .btn { opacity: 1 !important; }

    /* ===== Planos por bot: força o nome do plano a ficar visível ===== */
    /* Muitos templates usam text-muted/opacidade para o título do item. */
    #admin-wizard .list-group-item {
      color: var(--aw-fg) !important;
    }
    /* Qualquer texto do item que não seja botão deve ficar preto e 100% opaco */
    #admin-wizard .list-group-item :not(.btn) {
      color: var(--aw-fg) !important;
      opacity: 1 !important;
      filter: none !important;
    }
    /* Coberturas comuns para nomes/títulos */
    #admin-wizard .list-group-item .plan-name,
    #admin-wizard .list-group-item .plan-title,
    #admin-wizard .list-group-item .title,
    #admin-wizard .list-group-item .name,
    #admin-wizard .list-group-item strong,
    #admin-wizard .list-group-item b {
      color: var(--aw-fg) !important;
      opacity: 1 !important;
    }
    /* Classes de “texto fraco” muito usadas em UI libs */
    #admin-wizard .list-group-item .text-muted,
    #admin-wizard .list-group-item .text-secondary,
    #admin-wizard .list-group-item [class*="text-gray"],
    #admin-wizard .list-group-item [class*="text-slate"] {
      color: var(--aw-fg) !important;
      opacity: 1 !important;
    }
    /* Itens marcados como disabled devem continuar legíveis */
    #admin-wizard .list-group-item.disabled,
    #admin-wizard .list-group-item [aria-disabled="true"] {
      opacity: 1 !important;
      color: var(--aw-fg) !important;
    }
    /* Não mexer nos botões (mantém contraste original do tema) */
    #admin-wizard .list-group-item .btn {
      opacity: 1 !important;
    }

    /* ========== Nova seção: Envio & Cache de mídias ========== */
    .metrics-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .metrics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .metrics-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
    }

    .metrics-controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .metrics-controls select {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      font-size: 13px;
      background: #fff;
      cursor: pointer;
    }

    .metrics-controls button {
      padding: 6px 14px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
    }

    .metrics-controls button:hover {
      background: #5a67d8;
    }

    .metrics-controls button:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    @media (min-width: 768px) {
      .metrics-grid {
        grid-template-columns: 2fr 1fr;
      }
    }

    .metrics-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
    }

    .metrics-card h4 {
      margin: 0 0 12px;
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
    }

    .chart-container {
      position: relative;
      height: 280px;
    }

    .kpi-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .kpi-route {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
    }

    .kpi-route-name {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .kpi-stats {
      display: flex;
      gap: 12px;
      justify-content: space-around;
    }

    .kpi-stat {
      text-align: center;
    }

    .kpi-label {
      font-size: 11px;
      color: #9ca3af;
      font-weight: 500;
    }

    .kpi-value {
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
      margin-top: 2px;
    }

    /* Tabela de cache melhorada */
    .cache-table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .cache-table-header h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }

    .cache-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .cache-actions .btn-secondary {
      font-size: 13px;
      padding: 6px 12px;
    }

    .cache-filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .cache-filters input,
    .cache-filters select {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      font-size: 13px;
    }

    .cache-filters input {
      min-width: 180px;
    }

    .table-wrap {
      max-height: 520px;
      overflow: auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .cache-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 720px;
    }

    .cache-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #f9fafb;
      backdrop-filter: blur(8px);
    }

    .cache-table th {
      text-align: left;
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 600;
      color: #374151;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e5e7eb;
    }

    .cache-table td {
      padding: 10px 12px;
      font-size: 13px;
      color: #1f2937;
      border-bottom: 1px solid #f3f4f6;
      vertical-align: middle;
    }

    .cache-table tbody tr:hover {
      background: #f9fafb;
    }

    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .pill.warm {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }

    .pill.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 6px;
    }

    .badge.stale {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }

    .btn-warmup {
      padding: 4px 10px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      font-weight: 500;
      white-space: nowrap;
    }

    .btn-warmup:hover {
      background: #5a67d8;
    }

    .btn-warmup:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
    }

    .route-used {
      font-size: 11px;
      color: #6b7280;
      font-style: italic;
    }

    @media (max-width: 720px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }
      
      .chart-container {
        height: 220px;
      }
      
      .kpi-stats {
        flex-direction: column;
        gap: 8px;
      }
      
      .table-wrap {
        max-height: 400px;
      }
    }
  </style>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Adapter de datas para Chart.js (compatível com v4) -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <!-- (opcional) locale pt-BR -->
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2/locale/pt-BR/index.min.js"></script>
  <style>
    /* Melhorar contraste da seção Downsells (beta) */
    #downsells-card .downsells-header h2,
    #downsells-card .downsells-header p,
    #downsells-card .current-slug {
      color: #fff !important;
    }
  </style>
</head>
<body id="admin-wizard">
  <div class="layout">
    <header class="top">
      <div>
        <h1>🤖 Admin Wizard</h1>
        <p>Gerencie múltiplos bots do Telegram sem precisar de código.</p>
      </div>
      <div class="token-card">
        <label for="admin-token">Admin Token</label>
        <div class="token-input">
          <input id="admin-token" type="password" placeholder="Cole aqui o ADMIN_API_TOKEN" autocomplete="off">
          <button id="apply-token" type="button">Usar token</button>
        </div>
        <small style="color:#6b7280;">O token fica salvo apenas neste navegador.</small>
      </div>
    </header>

    <main class="card">
      <div class="card-header">
        <div>
          <h2>Templates /start</h2>
          <p>Escolha um bot para editar mensagem inicial, mídias e parse mode.</p>
        </div>
      </div>

      <div id="tabs">
        <div id="tabs-scroll"></div>
        <div id="bot-actions">
          <button id="btn-new-bot" type="button">+ Novo bot</button>
          <button id="btn-refresh-bots" type="button" title="Recarregar bots">↻</button>
        </div>
      </div>

      <div id="no-bots" class="hidden">
        Nenhum bot encontrado. Informe o token de admin e clique em ↻ para carregar os bots cadastrados.
      </div>

      <div id="pane" class="hidden">
        <div id="bot-header" class="card-section">
          <div>Bot ID: <code id="hdr-bot-id"></code></div>
          <div>Slug: <code id="hdr-bot-slug"></code></div>
          <div>
            <span>Token:</span>
            <input id="hdr-bot-token" type="password" readonly class="mono" value="">
            <button id="reveal-token" type="button" title="Mostrar token">👁</button>
          </div>
          <div>
            <span>Webhook:</span>
            <code id="hdr-webhook" class="mono"></code>
            <button id="copy-webhook" type="button">Copiar</button>
          </div>
          <div>
            <span>Warmup chat ID:</span>
            <input id="warmup-chat-id" type="text" placeholder="-1001234567890" class="mono" />
            <button id="save-warmup" type="button">Salvar</button>
            <button id="do-warmup" type="button">Aquecer agora</button>
          </div>
        </div>

        <div class="form-section metrics-section">
          <!-- Header com título e controles -->
          <div class="metrics-header">
            <h3>📊 Envio &amp; Cache de mídias</h3>
            <div class="metrics-controls">
              <select id="metrics-bot-select" aria-label="Selecionar bot">
                <option value="">Selecione um bot</option>
              </select>
              <select id="metrics-limit-select" aria-label="Janela de eventos">
                <option value="100">Últimos 100</option>
                <option value="500">Últimos 500</option>
                <option value="1000">Últimos 1000</option>
              </select>
              <button id="btn-refresh-metrics" type="button" aria-label="Atualizar métricas">Atualizar</button>
            </div>
          </div>

          <!-- Grid: Gráfico + KPIs -->
          <div class="metrics-grid">
            <!-- Card: Gráfico de latência -->
            <div class="metrics-card">
              <h4>Latência de envios (ms)</h4>
              <div class="chart-container">
                <canvas id="send-latency-chart" aria-label="Gráfico de latência de envios"></canvas>
              </div>
            </div>

            <!-- Card: KPIs p50/p95/p99 por rota -->
            <div class="metrics-card">
              <h4>Percentis por rota</h4>
              <div id="kpi-container" class="kpi-grid">
                <div class="placeholder" style="text-align:center; color:#9ca3af; padding:24px; font-style:italic;">
                  Selecione um bot e clique em Atualizar
                </div>
              </div>
            </div>
          </div>

          <!-- Tabela de cache com filtros -->
          <div>
            <div class="cache-table-header">
              <h4>Cache de mídias</h4>
              <div class="cache-actions">
                <button id="btn-warmup-all" type="button" class="btn-secondary hidden">Aquecer tudo</button>
                <div class="cache-filters">
                  <input id="cache-search" type="text" placeholder="Buscar por key..." aria-label="Buscar cache por key">
                  <select id="cache-type-filter" aria-label="Filtrar por tipo de mídia">
                    <option value="">Todos os tipos</option>
                    <option value="photo">photo</option>
                    <option value="video">video</option>
                    <option value="audio">audio</option>
                    <option value="document">document</option>
                    <option value="voice">voice</option>
                  </select>
                  <select id="cache-status-filter" aria-label="Filtrar por status">
                    <option value="">Todos os status</option>
                    <option value="warm">warm</option>
                    <option value="error">error</option>
                  </select>
                </div>
              </div>
            </div>
            <div id="media-cache-table-container">
              <div class="placeholder" style="padding:24px; text-align:center; color:#9ca3af; font-style:italic;">
                Selecione um bot para visualizar o cache.
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <label for="parse-mode">Parse Mode</label>
          <select id="parse-mode">
            <option value="Markdown">Markdown</option>
            <option value="HTML">HTML</option>
          </select>
        </div>

        <div class="form-section">
          <label>Mensagens iniciais (/start)</label>
          <div id="start-messages-list" style="display: flex; flex-direction: column; gap: 12px; margin-top: 8px;"></div>
          <div style="margin-top: 12px; display: flex; align-items: center; gap: 12px;">
            <button type="button" id="add-start-message" class="btn-secondary">+ Adicionar mensagem /start</button>
            <small style="color: #6b7280;">Máx. 3 mensagens. Serão enviadas após as mídias e antes dos planos.</small>
          </div>
          <!-- Campo legado mantido oculto para retrocompatibilidade -->
          <textarea id="start-text" style="display: none;"></textarea>
        </div>

        <div class="form-section">
          <div style="display:flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
            <label style="margin:0;">Mídias (foto, vídeo ou áudio)</label>
            <button id="add-media" type="button" class="btn-secondary">➕ Adicionar mídia</button>
          </div>
          <div id="media-empty">Nenhuma mídia adicionada.</div>
          <div id="media-list"></div>
        </div>

        <div class="actions">
          <button id="save-start" type="button">Salvar Template /start</button>
        </div>

        <div id="status" class="status hidden"></div>
      </div>
    </main>

    <section id="plans-card" class="simple-card">
      <div>
        <h2>Planos por bot</h2>
        <p class="description">Cadastre planos (nome e preço) por <strong>slug</strong> de bot e gere pagamentos PIX instantâneos para testes.</p>
      </div>
      <div class="form-row">
        <div class="field">
          <label for="plans-bot-slug">Bot slug</label>
          <input id="plans-bot-slug" type="text" placeholder="ex.: hadrielle-maria" autocomplete="off" readonly title="Este slug é sincronizado automaticamente pela aba selecionada." />
        </div>
        <button id="btn-load-plans" type="button">Carregar planos</button>
      </div>
      <div id="plans-list">
        <div class="placeholder">Informe o slug do bot e clique em "Carregar planos".</div>
      </div>
      <hr />
      <h3>Imagem para o PIX</h3>
      <p class="muted tiny">URL pública (ex.: do seu R2). Esta imagem será enviada no Telegram ao gerar o PIX.</p>
      <div class="form-row" style="gap:12px; align-items:flex-end; flex-wrap:wrap;">
        <div class="field" style="flex:1 1 240px;">
          <label for="pix-img-url">URL da imagem</label>
          <input id="pix-img-url" type="url" placeholder="https://.../uploads/pix-help.png" autocomplete="off" />
        </div>
        <input type="file" id="pix-img-file" accept="image/*" style="display:none" />
        <button id="btn-pix-upload" type="button" class="btn-secondary">Enviar arquivo…</button>
        <button id="btn-pix-preview" type="button" class="btn-secondary">Pré-visualizar</button>
        <button id="btn-pix-save" type="button">Salvar imagem</button>
      </div>
      <div id="pix-img-preview" class="mt-2"></div>
      <hr />
      <h3>Texto que acompanha as ofertas (/start)</h3>
      <p class="muted tiny">Este texto aparece acima dos botões dos planos.</p>
      <div class="form-row" style="gap:12px; flex-wrap:wrap;">
        <textarea id="offers-text" rows="3" style="flex:1 1 300px; min-width:200px" placeholder="Escolha uma oferta abaixo:"></textarea>
        <div style="display:flex; flex-direction:column; gap:8px">
          <button id="btn-offers-save" type="button">Salvar texto</button>
        </div>
      </div>
      <hr />
      <h3>Cadastro de plano</h3>
      <div class="form-row">
        <input type="hidden" id="plan-id" />
        <div class="field grow-2">
          <label for="plan-name">Nome do plano</label>
          <input id="plan-name" type="text" placeholder="ex.: 1 Semana" autocomplete="off" />
        </div>
        <div class="field">
          <label for="plan-price">Preço (R$)</label>
          <input id="plan-price" type="text" placeholder="ex.: 9,90" inputmode="decimal" autocomplete="off" />
        </div>
        <button id="btn-save-plan" type="button">Salvar plano</button>
      </div>
      <p class="plan-hint">* Valores são convertidos para centavos; mínimo R$ 0,50.</p>
    </section>

    <section id="downsells-card">
      <div class="downsells-header">
        <div>
          <h2>Downsells (beta)</h2>
          <p>Crie ofertas de recuperação específicas por bot. Salvas diretamente no backend.</p>
        </div>
        <div class="downsells-actions">
          <button type="button" id="btn-downsell-add" class="btn-gradient">+ Novo downsell</button>
          <button type="button" id="btn-downsell-refresh" class="btn-outline">Recarregar</button>
        </div>
      </div>
      <div class="current-slug">
        Bot atual: <strong id="downsells-current-slug">—</strong>
      </div>
      <div id="downsells-empty" class="hidden">Nenhum downsell cadastrado para este bot.</div>
      <div id="downsells-list"></div>
    </section>
  </div>

  <div id="downsells-modal" class="downsells-modal hidden" role="dialog" aria-modal="true" aria-labelledby="downsells-modal-title">
    <div class="modal-backdrop" data-dismiss="downsells-modal"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="downsells-modal-title">Novo downsell</h3>
        <button type="button" id="downsells-modal-close" class="btn-outline">Fechar</button>
      </div>
      <div class="modal-body">
        <div class="form-row double">
          <label>Plano (texto no botão)
            <input id="ds-plan-label" type="text" placeholder="ex.: Acesso VIP 1 semana" autocomplete="off">
          </label>
          <label>Preço (R$)
            <input id="ds-price" type="text" placeholder="ex.: 19,90" autocomplete="off">
          </label>
        </div>
        <!-- Planos adicionais (visual somente nesta etapa) -->
        <div class="form-row">
          <div class="ds-additional-plans">
            <div class="ds-additional-plans__header">
              <span class="ds-additional-plans__title">Planos adicionais (opcional)</span>
              <div class="ds-additional-plans__actions">
                <span id="ds-plans-count" class="ds-additional-plans__counter">0/8</span>
                <button type="button" id="ds-add-plan" class="btn-soft">+ Adicionar plano</button>
              </div>
            </div>
            <div id="ds-plans-list" class="ds-plans-list"></div>
            <template id="tpl-ds-plan-row">
              <div class="ds-plan-row">
                <label class="ds-plan-row__field">
                  <span class="ds-plan-row__label">Texto no botão</span>
                  <input type="text" placeholder="Ex.: 1 Semana VIP">
                </label>
                <label class="ds-plan-row__field ds-plan-row__field--price">
                  <span class="ds-plan-row__label">Preço (R$)</span>
                  <input type="text" class="ds-price-input" inputmode="decimal" placeholder="19,90">
                </label>
                <div class="ds-plan-row__actions">
                  <button type="button" class="btn-soft" data-move-up title="Mover para cima">↑</button>
                  <button type="button" class="btn-soft" data-move-down title="Mover para baixo">↓</button>
                  <button type="button" class="btn-danger" data-remove title="Remover">Remover</button>
                </div>
              </div>
            </template>
          </div>
        </div>
        <div class="form-row double">
          <label>Momento
            <select id="ds-moment">
              <option value="after_start">Após /start</option>
              <option value="after_pix">Após gerar PIX</option>
            </select>
          </label>
          <label>Atraso (min)
            <input id="ds-delay-min" type="number" inputmode="numeric" min="0" max="10080" step="1" placeholder="ex.: 20">
          </label>
        </div>
        <div class="form-row">
          <label>Copy (mensagem)
            <textarea id="ds-copy" placeholder="Escreva a mensagem do downsell..."></textarea>
          </label>
        </div>
        <div class="form-row">
          <label for="downsell-button-intro">Texto acima do botão
            <input id="downsell-button-intro"
                   class="form-control"
                   type="text"
                   placeholder="Clique abaixo para continuar:"
                   maxlength="200">
            <small class="form-text">Opcional. Se vazio, usamos o padrão.</small>
          </label>
        </div>
        <div class="form-row">
          <label>URL da mídia (foto/vídeo/áudio)
            <input id="ds-media-url" type="text" placeholder="https://..." autocomplete="off">
          </label>
          <div class="file-actions">
            <input type="file" id="ds-media-file" class="hidden" accept="image/*,video/*,audio/*">
            <button type="button" id="ds-media-upload" class="btn-soft">Enviar arquivo…</button>
            <button type="button" id="ds-media-preview" class="btn-soft">Pré-visualizar</button>
          </div>
        </div>
        <label class="checkbox-row">
          <input id="ds-active" type="checkbox">
          <span>Ativo</span>
        </label>
      </div>
      <div class="footer">
        <button type="button" id="downsells-save" class="btn-gradient">Salvar</button>
      </div>
    </div>
  </div>

  <dialog id="pix-modal">
    <h3 id="pix-title">Pagamento PIX</h3>
    <div>
      <img id="pix-qr" alt="QR Code PIX" src="" />
      <textarea id="pix-code" readonly placeholder="Copia e cola do PIX"></textarea>
      <div id="pix-notice"
           class="pix-notice"
           data-default="<strong>Entrega garantida <span style='background:none;color:#22c55e;-webkit-text-fill-color:#22c55e'>✅</span></strong>"
           style="text-align:center;font-weight:900;font-size:16px;background:linear-gradient(135deg,#19c3ff,#4b7cff);-webkit-background-clip:text;color:transparent">
        Entrega garantida <span style="background:none;color:#22c55e;-webkit-text-fill-color:#22c55e">✅</span>
      </div>
    </div>
    <div class="modal-actions">
      <button type="button" id="btn-copy-code" class="btn-secondary">Copiar código</button>
      <button type="button" id="btn-close-pix">Fechar</button>
    </div>
  </dialog>

  <dialog id="new-bot-modal">
    <form method="dialog" id="new-bot-form" class="modal-form">
      <h3>Novo bot</h3>
      <label>Slug*
        <input id="nb-slug" required pattern="^[a-z0-9]+(?:-[a-z0-9]+)*$" />
      </label>
      <label>Token do Telegram*
        <input id="nb-token" required type="password" autocomplete="off" />
      </label>
      <button type="button" id="nb-test-token">Testar token</button>
      <label>Nome/Título
        <input id="nb-title" />
      </label>
      <label>Secret webhook
        <input id="nb-secret" placeholder="(opcional)" />
      </label>
      <label><input type="checkbox" id="nb-sethook" checked /> Setar webhook automaticamente</label>
      <label><input type="checkbox" id="nb-empty" checked /> Criar template /start vazio</label>
      <menu>
        <button value="cancel">Cancelar</button>
        <button id="nb-create" value="default">Criar</button>
      </menu>
    </form>
  </dialog>

  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    (() => {
      const tokenInput = document.getElementById('admin-token');
      const applyTokenBtn = document.getElementById('apply-token');
      const refreshBtn = document.getElementById('btn-refresh-bots');
      const newBotBtn = document.getElementById('btn-new-bot');
      const newBotModal = document.getElementById('new-bot-modal');
      const newBotForm = document.getElementById('new-bot-form');
      const paneEl = document.getElementById('pane');
      const noBotsEl = document.getElementById('no-bots');
      const tabsScroll = document.getElementById('tabs-scroll');
      const toastEl = document.getElementById('toast');
      const warmupChatInput = document.getElementById('warmup-chat-id');
      const saveWarmupBtn = document.getElementById('save-warmup');
      const doWarmupBtn = document.getElementById('do-warmup');
      
      // metrics: new UI elements
      const metricsBotSelect = document.getElementById('metrics-bot-select');
      const metricsLimitSelect = document.getElementById('metrics-limit-select');
      const btnRefreshMetrics = document.getElementById('btn-refresh-metrics');
      const kpiContainer = document.getElementById('kpi-container');
      const mediaCacheTableContainer = document.getElementById('media-cache-table-container');
      const warmupAllBtn = document.getElementById('btn-warmup-all');
      const cacheSearch = document.getElementById('cache-search');
      const cacheTypeFilter = document.getElementById('cache-type-filter');
      const cacheStatusFilter = document.getElementById('cache-status-filter');
      let mediaCacheRequestId = 0;

      if (warmupAllBtn && !warmupAllBtn.getAttribute('data-default-label')) {
        warmupAllBtn.setAttribute('data-default-label', warmupAllBtn.textContent?.trim() || 'Aquecer tudo');
      }
      
      // metrics: state
      let latencyChartInstance = null;
      let latencyChartNeedsResize = false;
      let cachedSendMetrics = [];
      let cachedCacheItems = [];

      function getLatencyCanvas() {
        return document.getElementById('send-latency-chart');
      }

      function destroyLatencyChart() {
        if (latencyChartInstance) {
          latencyChartInstance.destroy();
          latencyChartInstance = null;
        }

        const canvas = getLatencyCanvas();
        const zombieInstance = canvas ? Chart.getChart(canvas) : null;
        zombieInstance?.destroy();

        if (canvas) {
          const ctx = canvas.getContext('2d');
          if (ctx) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
          }
        }

        latencyChartNeedsResize = false;
        cachedSendMetrics = [];
      }

      function upsertLatencyChart({ datasets = [] } = {}) {
        const canvas = getLatencyCanvas();
        if (!canvas) {
          return null;
        }

        const options = {
          responsive: true,
          maintainAspectRatio: false,
          parsing: { xAxisKey: 'ts', yAxisKey: 'tg_ms' },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 10,
                font: { size: 11 },
              },
            },
            tooltip: {
              mode: 'nearest',
              intersect: false,
            },
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'minute',
                tooltipFormat: 'dd/MM HH:mm:ss',
              },
              adapters: {
                date: { locale: window.dateFnsLocalePtBR || undefined },
              },
              title: {
                display: true,
                text: 'Horário',
                font: { size: 11 },
              },
              ticks: {
                font: { size: 10 },
              },
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'ms',
                font: { size: 11 },
              },
              ticks: {
                font: { size: 10 },
              },
            },
          },
        };

        let chart = latencyChartInstance || (canvas ? Chart.getChart(canvas) : null);
        if (chart) {
          latencyChartInstance = chart;
          chart.data.datasets = datasets;
          chart.options.responsive = options.responsive;
          chart.options.maintainAspectRatio = options.maintainAspectRatio;
          chart.options.parsing = options.parsing;
          chart.options.plugins = {
            ...(chart.options.plugins || {}),
            legend: { ...options.plugins.legend },
            tooltip: { ...options.plugins.tooltip },
          };
          chart.options.scales = {
            x: { ...options.scales.x },
            y: { ...options.scales.y },
          };
          chart.update('none');
          const computed = window.getComputedStyle(canvas);
          const hidden = canvas.offsetParent === null || computed.display === 'none' || computed.visibility === 'hidden';
          if (hidden) {
            latencyChartNeedsResize = true;
          } else {
            chart.resize();
            latencyChartNeedsResize = false;
          }
          return chart;
        }

        const existing = canvas ? Chart.getChart(canvas) : null;
        existing?.destroy();

        const ctx = canvas.getContext('2d');
        const config = {
          type: 'line',
          data: { datasets },
          options,
        };
        chart = new Chart(ctx, config);

        latencyChartInstance = chart;

        const computed = window.getComputedStyle(canvas);
        const hidden = canvas.offsetParent === null || computed.display === 'none' || computed.visibility === 'hidden';
        if (hidden) {
          latencyChartNeedsResize = true;
        } else {
          latencyChartInstance.resize();
          latencyChartNeedsResize = false;
        }

        return chart;
      }

      function ensureLatencyChartVisible() {
        if (!latencyChartNeedsResize || !latencyChartInstance) {
          return;
        }

        const canvas = getLatencyCanvas();
        if (!canvas) {
          latencyChartNeedsResize = false;
          return;
        }

        const computed = window.getComputedStyle(canvas);
        const hidden = canvas.offsetParent === null || computed.display === 'none' || computed.visibility === 'hidden';
        if (!hidden) {
          latencyChartInstance.resize();
          latencyChartNeedsResize = false;
        }
      }
      function getSelectedMetricsLimit() {
        return Number.parseInt(metricsLimitSelect?.value || '100', 10);
      }
      const nbSlugInput = document.getElementById('nb-slug');
      const nbTokenInput = document.getElementById('nb-token');
      const nbTitleInput = document.getElementById('nb-title');
      const nbSecretInput = document.getElementById('nb-secret');
      const nbSetHookInput = document.getElementById('nb-sethook');
      const nbEmptyInput = document.getElementById('nb-empty');
      const nbTestTokenBtn = document.getElementById('nb-test-token');
      const nbCreateBtn = document.getElementById('nb-create');
      const plansBotSlugInput = document.getElementById('plans-bot-slug');
      const plansList = document.getElementById('plans-list');
      const plansLoadBtn = document.getElementById('btn-load-plans');
      const planIdInput = document.getElementById('plan-id');
      const planNameInput = document.getElementById('plan-name');
      const planPriceInput = document.getElementById('plan-price');
      const planSaveBtn = document.getElementById('btn-save-plan');
      const pixImageUrlInput = document.getElementById('pix-img-url');
      const pixPreviewBtn = document.getElementById('btn-pix-preview');
      const pixSaveBtn = document.getElementById('btn-pix-save');
      const pixPreviewBox = document.getElementById('pix-img-preview');
      const pixModal = document.getElementById('pix-modal');
      const pixTitle = document.getElementById('pix-title');
      const pixQr = document.getElementById('pix-qr');
      const pixCode = document.getElementById('pix-code');
      const pixNotice = document.getElementById('pix-notice');
      const pixCopyBtn = document.getElementById('btn-copy-code');
      const pixCloseBtn = document.getElementById('btn-close-pix');
      const pixNoticeDefault = pixNotice ? pixNotice.innerHTML : '';
      const pixFile = document.getElementById('pix-img-file');
      const btnPixUpload = document.getElementById('btn-pix-upload');
      const offersText = document.getElementById('offers-text');
      const btnOffersSave = document.getElementById('btn-offers-save');
      const downsellsCard = document.getElementById('downsells-card');
      const downsellsList = document.getElementById('downsells-list');
      const downsellsEmpty = document.getElementById('downsells-empty');
      const downsellsSlugLabel = document.getElementById('downsells-current-slug');
      const downsellsAddBtn = document.getElementById('btn-downsell-add');
      const downsellsRefreshBtn = document.getElementById('btn-downsell-refresh');
      const downsellsModal = document.getElementById('downsells-modal');
      const downsellsModalTitle = document.getElementById('downsells-modal-title');
      const downsellsModalClose = document.getElementById('downsells-modal-close');
      const downsellsSaveBtn = document.getElementById('downsells-save');
      const dsPlanLabelInput = document.getElementById('ds-plan-label');
      const dsPriceInput = document.getElementById('ds-price');
      const dsMomentSelect = document.getElementById('ds-moment');
      const dsDelayInput = document.getElementById('ds-delay-min');
      const dsCopyTextarea = document.getElementById('ds-copy');
      const dsButtonIntroInput = document.getElementById('downsell-button-intro');
      const dsMediaUrlInput = document.getElementById('ds-media-url');
      const dsMediaFileInput = document.getElementById('ds-media-file');
      const dsMediaUploadBtn = document.getElementById('ds-media-upload');
      const dsMediaPreviewBtn = document.getElementById('ds-media-preview');
      const dsActiveCheckbox = document.getElementById('ds-active');

      let downsellsItems = [];
      let downsellsEditing = null;
      let downsellsLoading = false;

      if (plansBotSlugInput) {
        // lock manual slug: read-only + input prevention
        plansBotSlugInput.readOnly = true;
        plansBotSlugInput.classList.add('as-readonly');
        if (!plansBotSlugInput.title) {
          plansBotSlugInput.title = 'Este slug é sincronizado automaticamente pela aba selecionada.';
        }
        const preventManualInput = (event) => {
          event.preventDefault();
          event.stopPropagation();
        };
        ['beforeinput', 'paste', 'drop'].forEach((type) => {
          plansBotSlugInput.addEventListener(type, preventManualInput);
        });
        plansBotSlugInput.addEventListener('keydown', (event) => {
          const allowedKeys = [
            'Tab',
            'Shift',
            'Meta',
            'Alt',
            'Control',
            'ArrowLeft',
            'ArrowRight',
            'ArrowUp',
            'ArrowDown',
            'Home',
            'End',
            'PageUp',
            'PageDown',
            'Escape',
          ];
          if (allowedKeys.includes(event.key)) {
            return;
          }
          if (event.key.length === 1 || ['Backspace', 'Delete', 'Enter'].includes(event.key)) {
            preventManualInput(event);
          }
        });
      }

      renderPixPreview();

      let ADMIN_TOKEN = localStorage.getItem('admin_token') || '';
      if (ADMIN_TOKEN) {
        tokenInput.value = ADMIN_TOKEN;
      }

      const state = {
        bots: [],
        currentBotId: null,
        dirty: new Set(),
        cache: new Map(),
      };

      let toastTimer = null;

      function getAdminToken() {
        return (ADMIN_TOKEN || '').trim();
      }

      function showToast(message) {
        if (!message) return;
        if (!toastEl) {
          alert(message);
          return;
        }
        toastEl.textContent = message;
        toastEl.classList.add('show');
        if (toastTimer) {
          clearTimeout(toastTimer);
        }
        toastTimer = setTimeout(() => {
          toastEl.classList.remove('show');
        }, 3000);
      }

      function escapeHtml(value) {
        return String(value ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function updateDownsellsSlugLabel(slug) {
        if (downsellsSlugLabel) {
          downsellsSlugLabel.textContent = slug ? slug : '—';
        }
      }

      function renderDownsellPlaceholder(message) {
        if (downsellsEmpty) {
          downsellsEmpty.textContent = message;
          downsellsEmpty.classList.remove('hidden');
        }
        if (downsellsList) {
          downsellsList.innerHTML = '';
        }
      }

      function renderDownsellItems(list) {
        if (!downsellsList || !downsellsEmpty) {
          return;
        }

        downsellsList.innerHTML = '';

        if (!Array.isArray(list) || list.length === 0) {
          renderDownsellPlaceholder('Nenhum downsell cadastrado para este bot.');
          return;
        }

        downsellsEmpty.classList.add('hidden');

        list.forEach((item) => {
          const card = document.createElement('article');
          card.className = 'downsells-item';

          const header = document.createElement('div');
          header.className = 'downsells-item-header';

          const info = document.createElement('div');
          const price = document.createElement('div');
          price.className = 'downsells-item-price';
          const label =
            (typeof item?.plan_label === 'string' && item.plan_label.trim()) ||
            (typeof item?.plan_name === 'string' && item.plan_name.trim()) ||
            'Plano';
          const hasPriceCents =
            item?.price_cents !== undefined &&
            item?.price_cents !== null &&
            item.price_cents !== '';
          const numericPriceCents = hasPriceCents ? Number(item.price_cents) : Number.NaN;
          const formattedPrice = Number.isFinite(numericPriceCents)
            ? (numericPriceCents / 100).toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL',
              })
            : null;
          if (formattedPrice) {
            price.textContent = `${label} — ${formattedPrice}`;
          } else if (item?.price_brl) {
            price.textContent = `${label} — R$ ${item.price_brl}`;
          } else {
            price.textContent = label;
          }
          const moment = document.createElement('div');
          moment.className = 'downsells-item-moment';
          const triggerValue =
            item?.trigger === 'after_pix' || item?.moment === 'after_pix' ? 'after_pix' : 'after_start';
          const delayValue = (() => {
            const rawDelay = item?.delay_minutes;
            const numericDelay = typeof rawDelay === 'number' ? rawDelay : Number(rawDelay ?? 0);
            if (!Number.isFinite(numericDelay) || numericDelay <= 0) {
              return 0;
            }
            return Math.min(Math.max(Math.round(numericDelay), 0), 10080);
          })();
          const delayText = delayValue > 0 ? ` (após ${delayValue} min)` : '';
          moment.textContent =
            (triggerValue === 'after_pix' ? 'Após gerar PIX' : 'Após /start') + delayText;
          info.appendChild(price);
          info.appendChild(moment);
          const introText =
            typeof item?.button_intro_text === 'string' ? item.button_intro_text.trim() : '';
          if (introText) {
            const introChip = document.createElement('span');
            introChip.className = 'downsells-item-intro';
            introChip.textContent = `Intro: ${introText}`;
            info.appendChild(introChip);
          }

          const badge = document.createElement('span');
          badge.className = 'downsells-badge' + (item?.active ? ' active' : '');
          badge.textContent = item?.active ? 'Ativo' : 'Inativo';

          header.appendChild(info);
          header.appendChild(badge);
          card.appendChild(header);

          if (item?.media_url) {
            const media = document.createElement('img');
            media.className = 'downsells-image';
            media.src = item.media_url;
            media.alt = '';
            media.loading = 'lazy';
            card.appendChild(media);
          }

          if (item?.copy) {
            const copy = document.createElement('p');
            copy.className = 'downsells-item-copy';
            copy.textContent = item.copy;
            card.appendChild(copy);
          }

          const actions = document.createElement('div');
          actions.className = 'downsells-item-actions';

          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'btn-soft';
          editBtn.textContent = 'Editar';
          editBtn.dataset.action = 'edit';
          if (item?.id !== undefined && item?.id !== null) {
            editBtn.dataset.id = String(item.id);
          } else {
            editBtn.disabled = true;
          }

          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.className = 'btn-danger';
          deleteBtn.textContent = 'Excluir';
          deleteBtn.dataset.action = 'delete';
          if (item?.id !== undefined && item?.id !== null) {
            deleteBtn.dataset.id = String(item.id);
          } else {
            deleteBtn.disabled = true;
          }

          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);
          card.appendChild(actions);

          downsellsList.appendChild(card);
        });
      }

      async function fetchDownsells(botSlug) {
        const url = `/admin/api/downsells?bot_slug=${encodeURIComponent(botSlug)}&ts=${Date.now()}`;
        return fetchJSON(url, { cache: 'no-store' });
      }

      async function loadDownsells(options = {}) {
        if (!downsellsList || !downsellsEmpty) {
          return;
        }

        const slug = (plansBotSlugInput?.value || '').trim();
        updateDownsellsSlugLabel(slug);

        if (!slug) {
          downsellsItems = [];
          renderDownsellPlaceholder('Informe o slug do bot para listar downsells.');
          return;
        }

        renderDownsellPlaceholder('Carregando downsells...');

        downsellsLoading = true;
        try {
          const response = await fetchDownsells(slug);
          const items = Array.isArray(response)
            ? response
            : Array.isArray(response?.items)
            ? response.items
            : [];
          downsellsItems = items;
          renderDownsellItems(downsellsItems);
        } catch (error) {
          console.error('[downsells] erro ao carregar', error);
          downsellsItems = [];
          const message = error instanceof Error ? error.message : 'Erro ao carregar downsells.';
          renderDownsellPlaceholder(message);
          if (!options?.silent) {
            showToast(message);
          }
        } finally {
          downsellsLoading = false;
        }
      }

      const DS_EXTRA_PLANS_MAX = 8;

      function isValidBRL(str) {
        if (!str) return false;
        const normalized = str.replace(/\./g, '').replace(',', '.');
        const n = Number(normalized);
        return Number.isFinite(n) && n > 0;
      }

      function collectExtraPlans(modalEl) {
        if (!modalEl) {
          return [];
        }
        const list = modalEl.querySelector('#ds-plans-list');
        if (!list) {
          return [];
        }
        const rows = Array.from(list.querySelectorAll('.ds-plan-row'));
        return rows.map((r) => {
          const [labelEl, priceEl] = r.querySelectorAll('input');
          const label = (labelEl?.value || '').trim();
          const price = (priceEl?.value || '').trim();
          if (price && !isValidBRL(price)) {
            r.scrollIntoView({ behavior: 'smooth', block: 'center' });
            priceEl?.focus();
            throw new Error('Preço inválido. Use ex.: 19,90');
          }
          return { label, price };
        });
      }

      function initDownsellPlansRepeater(modalEl) {
        if (!modalEl) {
          return;
        }

        const list = modalEl.querySelector('#ds-plans-list');
        const addBtn = modalEl.querySelector('#ds-add-plan');
        const tpl = modalEl.querySelector('#tpl-ds-plan-row');
        const counterEl = modalEl.querySelector('#ds-plans-count');

        if (!list || !addBtn || !tpl) {
          return;
        }

        list.innerHTML = '';

        function updateCounter() {
          if (!counterEl) {
            return;
          }
          const count = list.querySelectorAll('.ds-plan-row').length;
          counterEl.textContent = `${count}/${DS_EXTRA_PLANS_MAX}`;
        }

        function canAddMore() {
          return list.querySelectorAll('.ds-plan-row').length < DS_EXTRA_PLANS_MAX;
        }

        function addRow(data) {
          const fragment = tpl.content.firstElementChild;
          if (!fragment) {
            return;
          }
          const node = fragment.cloneNode(true);
          const inputs = node.querySelectorAll('input');
          const labelInput = inputs[0];
          const priceInput = inputs[1];

          if (data && typeof data === 'object') {
            if (labelInput && data.label) {
              labelInput.value = data.label;
            }
            if (priceInput && data.price) {
              priceInput.value = data.price;
            }
          }

          const removeBtn = node.querySelector('[data-remove]');
          if (removeBtn) {
            removeBtn.addEventListener('click', () => {
              if (confirm('Remover este plano?')) {
                node.remove();
                updateCounter();
              }
            });
          }

          const moveUpBtn = node.querySelector('[data-move-up]');
          if (moveUpBtn) {
            moveUpBtn.addEventListener('click', () => {
              const prev = node.previousElementSibling;
              if (prev) {
                list.insertBefore(node, prev);
              }
            });
          }

          const moveDownBtn = node.querySelector('[data-move-down]');
          if (moveDownBtn) {
            moveDownBtn.addEventListener('click', () => {
              const next = node.nextElementSibling;
              if (next) {
                list.insertBefore(next, node);
              }
            });
          }

          const priceEl = node.querySelector('.ds-price-input');
          if (priceEl) {
            priceEl.addEventListener('blur', () => {
              priceEl.value = priceEl.value.replace(/\./g, ',');
            });
          }

          const actions = node.querySelector('.ds-plan-row__actions');
          if (actions) {
            const dupBtn = document.createElement('button');
            dupBtn.type = 'button';
            dupBtn.className = 'px-2 py-2 rounded-md border';
            dupBtn.textContent = 'Duplicar';
            dupBtn.title = 'Duplicar plano';
            dupBtn.addEventListener('click', () => {
              if (!canAddMore()) {
                alert(`Limite de ${DS_EXTRA_PLANS_MAX} planos atingido.`);
                return;
              }
              const [l, p] = node.querySelectorAll('input');
              addRow({
                label: l?.value || '',
                price: p?.value || '',
              });
            });
            const removeAnchor = actions.querySelector('[data-remove]');
            if (removeAnchor) {
              actions.insertBefore(dupBtn, removeAnchor);
            } else {
              actions.appendChild(dupBtn);
            }
          }

          list.appendChild(node);
          updateCounter();
        }

        if (modalEl.__dsAddPlanHandler) {
          addBtn.removeEventListener('click', modalEl.__dsAddPlanHandler);
        }

        const handleAdd = () => {
          if (!canAddMore()) {
            alert(`Limite de ${DS_EXTRA_PLANS_MAX} planos atingido.`);
            return;
          }
          addRow();
        };
        modalEl.__dsAddPlanHandler = handleAdd;
        addBtn.addEventListener('click', handleAdd);

        modalEl.__getExtraPlans = () => collectExtraPlans(modalEl);

        const existingExtras = Array.isArray(downsellsEditing?.extra_plans)
          ? downsellsEditing.extra_plans
          : [];
        if (existingExtras.length > 0) {
          existingExtras.forEach((plan) => {
            if (!canAddMore()) {
              return;
            }
            const label = typeof plan?.label === 'string' ? plan.label : '';
            const cents = Number(plan?.price_cents);
            const formatted =
              Number.isFinite(cents) && cents > 0
                ? (cents / 100).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                  })
                : '';
            addRow({ label, price: formatted });
          });
        }

        updateCounter();
      }

      function openDownsellModal(item = null) {
        downsellsEditing = item && typeof item === 'object' ? { ...item } : null;
        if (downsellsModal) {
          if (downsellsEditing?.id) {
            downsellsModal.dataset.downsellId = String(downsellsEditing.id);
            downsellsModal.dataset.mode = 'edit';
          } else {
            delete downsellsModal.dataset.downsellId;
            downsellsModal.dataset.mode = 'create';
          }
        }
        if (downsellsModalTitle) {
          downsellsModalTitle.textContent = downsellsEditing ? 'Editar downsell' : 'Novo downsell';
        }
        if (downsellsSaveBtn) {
          downsellsSaveBtn.textContent = downsellsEditing ? 'Salvar alterações' : 'Salvar';
        }
        if (dsPlanLabelInput && !downsellsEditing) {
          dsPlanLabelInput.value = '';
        }
        if (dsPriceInput) {
          const editPrice = (() => {
            if (!downsellsEditing) {
              return '';
            }
            if (downsellsEditing?.price_brl) {
              return String(downsellsEditing.price_brl);
            }
            const hasCents =
              downsellsEditing?.price_cents !== undefined &&
              downsellsEditing?.price_cents !== null &&
              downsellsEditing?.price_cents !== '';
            const cents = hasCents ? Number(downsellsEditing?.price_cents) : Number.NaN;
            if (!Number.isFinite(cents)) {
              return '';
            }
            const reais = cents / 100;
            return reais.toLocaleString('pt-BR', {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            });
          })();
          dsPriceInput.value = editPrice;
        }
        if (dsMomentSelect) {
          const triggerValue =
            downsellsEditing?.trigger === 'after_pix' || downsellsEditing?.moment === 'after_pix'
              ? 'after_pix'
              : 'after_start';
          dsMomentSelect.value = triggerValue;
        }
        if (dsDelayInput) {
          const rawDelay = downsellsEditing?.delay_minutes;
          const numericDelay = typeof rawDelay === 'number' ? rawDelay : Number(rawDelay ?? 0);
          if (Number.isFinite(numericDelay) && numericDelay > 0) {
            const clamped = Math.min(Math.max(numericDelay, 0), 10080);
            dsDelayInput.value = String(Math.round(clamped));
          } else {
            dsDelayInput.value = '';
          }
        }
        if (dsCopyTextarea) {
          dsCopyTextarea.value = downsellsEditing?.copy ?? '';
        }
        if (dsButtonIntroInput) {
          const introValue =
            typeof downsellsEditing?.button_intro_text === 'string'
              ? downsellsEditing.button_intro_text.trim()
              : '';
          dsButtonIntroInput.value = introValue;
        }
        if (dsMediaUrlInput) {
          dsMediaUrlInput.value = downsellsEditing?.media_url ?? '';
        }
        if (dsActiveCheckbox) {
          dsActiveCheckbox.checked = Boolean(downsellsEditing?.active);
        }
        if (dsMediaFileInput) {
          dsMediaFileInput.value = '';
        }

        if (dsPlanLabelInput) {
          const existingLabel =
            typeof downsellsEditing?.plan_label === 'string' && downsellsEditing.plan_label.trim()
              ? downsellsEditing.plan_label
              : typeof downsellsEditing?.plan_name === 'string' && downsellsEditing.plan_name.trim()
              ? downsellsEditing.plan_name
              : '';
          dsPlanLabelInput.value = existingLabel;
        }

        if (downsellsModal) {
          initDownsellPlansRepeater(downsellsModal);
        }

        downsellsModal?.classList.remove('hidden');
      }

      function closeDownsellModal() {
        downsellsModal?.classList.add('hidden');
        if (dsMediaFileInput) {
          dsMediaFileInput.value = '';
        }
        if (dsDelayInput) {
          dsDelayInput.value = '';
        }
        if (dsButtonIntroInput) {
          dsButtonIntroInput.value = '';
        }
        if (dsPlanLabelInput) {
          dsPlanLabelInput.value = '';
        }
        downsellsEditing = null;
        if (downsellsModal) {
          delete downsellsModal.dataset.downsellId;
          delete downsellsModal.dataset.mode;
        }
        if (downsellsSaveBtn) {
          downsellsSaveBtn.textContent = 'Salvar';
        }
      }

      async function saveDownsell() {
        const slug = (plansBotSlugInput?.value || '').trim();
        if (!slug) {
          alert('Informe o slug do bot.');
          return;
        }

        const rawPrice = String(dsPriceInput?.value ?? '').trim();
        const parsedPriceCents = (() => {
          if (!rawPrice) {
            return Number.NaN;
          }
          const cleaned = rawPrice.replace(/\s+/g, '').replace(/[^0-9,.-]/g, '');
          if (!cleaned) {
            return Number.NaN;
          }
          const hasComma = cleaned.includes(',');
          let normalized = cleaned.replace(',', '.');
          if (hasComma) {
            normalized = normalized.replace(/\.(?=.*\.)/g, '');
          } else {
            const parts = normalized.split('.');
            if (parts.length > 2) {
              const decimals = parts.pop() ?? '';
              normalized =
                parts.join('') +
                (decimals.length > 2 ? decimals : decimals ? `.${decimals}` : '');
            }
          }
          const value = Number(normalized);
          return Number.isFinite(value) ? Math.round(value * 100) : Number.NaN;
        })();
        const priceProvided = rawPrice.length > 0;
        const priceCents = Number.isFinite(parsedPriceCents) ? parsedPriceCents : null;

        const planLabelRaw = (dsPlanLabelInput?.value || '').trim();
        const planLabelValue = planLabelRaw.length > 0 ? planLabelRaw : null;
        const existingPlanLabel =
          typeof downsellsEditing?.plan_label === 'string' && downsellsEditing.plan_label.trim()
            ? downsellsEditing.plan_label.trim()
            : typeof downsellsEditing?.plan_name === 'string' && downsellsEditing.plan_name.trim()
            ? downsellsEditing.plan_name.trim()
            : '';
        const hasExistingPlan = downsellsEditing?.plan_id ? true : existingPlanLabel.length > 0;
        const needsPrice = planLabelValue !== null || !hasExistingPlan;

        if ((priceProvided || needsPrice) && (priceCents === null || priceCents < 0)) {
          alert('Preço inválido. Use formato 19,90.');
          return;
        }

        let delayMinutes = Number(dsDelayInput?.value ?? 0);
        if (!Number.isFinite(delayMinutes) || delayMinutes < 0) {
          delayMinutes = 0;
        }
        if (delayMinutes > 10080) {
          delayMinutes = 10080;
        }
        delayMinutes = Math.round(delayMinutes);

        const trigger = dsMomentSelect?.value === 'after_pix' ? 'after_pix' : 'after_start';
        const buttonIntroValue = (dsButtonIntroInput?.value || '').trim();

        let extra_plans = [];
        try {
          const extraPlansUI = collectExtraPlans(downsellsModal);
          extra_plans = Array.isArray(extraPlansUI)
            ? extraPlansUI.filter((plan) => (plan.label || plan.price))
            : [];
        } catch (e) {
          alert(e instanceof Error ? e.message : String(e));
          return;
        }

        const payload = {
          bot_slug: slug,
          copy: (dsCopyTextarea?.value || '').trim(),
          button_intro_text: buttonIntroValue,
          plan_label: planLabelValue,
          price_cents: priceCents,
          media_url: (dsMediaUrlInput?.value || '').trim() || null,
          moment: trigger,
          trigger,
          delay_minutes: delayMinutes,
          active: Boolean(dsActiveCheckbox?.checked),
          extra_plans,
        };

        try {
          const currentId = downsellsModal?.dataset.downsellId || (downsellsEditing?.id ? String(downsellsEditing.id) : '');
          const isEdit = Boolean(currentId);
          const url = isEdit
            ? `/admin/api/downsells/${encodeURIComponent(currentId)}`
            : '/admin/api/downsells';
          await fetchJSON(url, {
            method: isEdit ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          closeDownsellModal();
          showToast(isEdit ? 'Downsell atualizado!' : 'Downsell salvo!');
          await loadDownsells({ silent: true });
        } catch (error) {
          console.error('[downsells] erro ao salvar', error);
          const isEdit = Boolean(downsellsModal?.dataset.downsellId || downsellsEditing?.id);
          const actionLabel = isEdit ? 'atualizar' : 'salvar';
          alert(error instanceof Error ? error.message : `Erro ao ${actionLabel} downsell.`);
        }
      }

      async function removeDownsell(id) {
        if (!id) {
          return;
        }
        try {
          await fetchJSON(`/admin/api/downsells/${encodeURIComponent(id)}`, { method: 'DELETE' });
          showToast('Downsell removido.');
          await loadDownsells({ silent: true });
        } catch (error) {
          console.error('[downsells] erro ao excluir', error);
          alert(error instanceof Error ? error.message : 'Erro ao excluir downsell.');
        }
      }

      async function uploadDownsellMedia(file) {
        const token = getAdminToken();
        if (!token) {
          throw new Error('Informe o token de admin para enviar arquivos.');
        }

        const formData = new FormData();
        formData.append('file', file);

        // usa a mesma rota de upload já utilizada por PIX e Mensagem Inicial
        const response = await fetch('/api/admin/upload', {
          method: 'POST',
          headers: { Authorization: `Bearer ${token}` },
          body: formData,
        });

        const data = await response.json().catch(() => null);

        if (!response.ok) {
          const message = data?.error || 'Falha no upload da mídia.';
          throw new Error(message);
        }

        if (!data?.url) {
          throw new Error('Upload concluído, mas sem URL retornada.');
        }

        return data.url;
      }

      function priceToCents(value) {
        if (value === null || value === undefined) {
          return Number.NaN;
        }
        const normalized = String(value).trim().replace(/\./g, '').replace(',', '.');
        const number = Number(normalized);
        return Number.isFinite(number) ? Math.round(number * 100) : Number.NaN;
      }

      function centsToBRL(cents) {
        const number = Number(cents);
        if (!Number.isFinite(number)) {
          return 'R$ 0,00';
        }
        return (number / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      }

      function resetWarmupAllButton() {
        if (!warmupAllBtn) return;
        const defaultLabel = warmupAllBtn.getAttribute('data-default-label') || 'Aquecer tudo';
        warmupAllBtn.disabled = false;
        warmupAllBtn.textContent = defaultLabel;
      }

      function setWarmupAllButtonVisibility(shouldShow) {
        if (!warmupAllBtn) return;
        if (!shouldShow) {
          resetWarmupAllButton();
        }
        warmupAllBtn.classList.toggle('hidden', !shouldShow);
      }

      function renderMediaCachePlaceholder(message = 'Selecione um bot para visualizar o cache.', options = {}) {
        if (!mediaCacheTableContainer) {
          return;
        }
        const { state = 'idle' } = options;
        const safeMessage = escapeHtml(message);
        mediaCacheTableContainer.innerHTML =
          `<div class="placeholder" data-state="${escapeHtml(state)}" style="padding:24px; text-align:center; color:#9ca3af; font-style:italic;">${safeMessage}</div>`;

        if (state === 'empty') {
          resetWarmupAllButton();
          setWarmupAllButtonVisibility(true);
        } else {
          setWarmupAllButtonVisibility(false);
        }
      }


      function setPlansPlaceholder(message) {
        if (!plansList) {
          return;
        }
        const placeholder = document.createElement('div');
        placeholder.className = 'placeholder';
        placeholder.textContent = message;
        plansList.innerHTML = '';
        plansList.appendChild(placeholder);
      }

      function resetPlanForm() {
        if (planIdInput) {
          planIdInput.value = '';
        }
        if (planNameInput) {
          planNameInput.value = '';
        }
        if (planPriceInput) {
          planPriceInput.value = '';
        }
      }

      function fillPlanForm(plan) {
        if (!plan) {
          return;
        }
        if (planIdInput) {
          planIdInput.value = plan.id != null ? String(plan.id) : '';
        }
        if (planNameInput) {
          planNameInput.value = typeof plan.plan_name === 'string' ? plan.plan_name : '';
        }
        if (planPriceInput) {
          const cents = Number(plan.price_cents);
          planPriceInput.value = Number.isFinite(cents)
            ? (cents / 100).toFixed(2).replace('.', ',')
            : '';
        }
        planNameInput?.focus();
      }

      function renderPixPreview() {
        if (!pixPreviewBox) {
          return;
        }

        const url = (pixImageUrlInput?.value || '').trim();
        pixPreviewBox.innerHTML = '';

        if (!url) {
          const empty = document.createElement('span');
          empty.className = 'muted tiny';
          empty.textContent = 'Nenhuma imagem configurada.';
          pixPreviewBox.appendChild(empty);
          return;
        }

        const img = document.createElement('img');
        img.src = url;
        img.alt = 'Imagem do PIX';
        img.style.maxWidth = '420px';
        img.style.borderRadius = '12px';
        img.style.border = '1px solid #e5e7eb';
        img.style.boxShadow = '0 12px 24px rgba(15, 23, 42, 0.18)';
        img.loading = 'lazy';
        pixPreviewBox.appendChild(img);
      }

      async function loadPixSettings(slug) {
        if (!pixImageUrlInput) {
          return;
        }

        try {
          const settings = await fetchJSON(`/api/bots/${encodeURIComponent(slug)}/settings`);
          const value = typeof settings?.pix_image_url === 'string' ? settings.pix_image_url : '';
          pixImageUrlInput.value = value;
          if (offersText) {
            offersText.value = typeof settings?.offers_text === 'string' ? settings.offers_text : '';
          }
          renderPixPreview();
        } catch (error) {
          console.warn('[pix] falha ao carregar imagem', error);
          pixImageUrlInput.value = '';
          if (offersText) {
            offersText.value = '';
          }
          renderPixPreview();
        }
      }

      async function loadPlans(options = {}) {
        if (!plansList) {
          return;
        }

        const { autoload = false } = options;
        const slug = (plansBotSlugInput?.value || '').trim();

        if (!slug) {
          if (!autoload) {
            alert('Informe o slug do bot.');
          }
          setPlansPlaceholder('Informe o slug do bot para listar planos.');
          return;
        }

        if (!getAdminToken()) {
          if (!autoload) {
            alert('Informe o token de admin para continuar.');
          }
          setPlansPlaceholder('Informe o token de admin para listar planos.');
          return;
        }

        setPlansPlaceholder('Carregando planos...');

        await loadPixSettings(slug);

        try {
          const data = await fetchJSON(`/api/bots/${encodeURIComponent(slug)}/plans`);
          const items = Array.isArray(data?.items) ? data.items : [];

          plansList.innerHTML = '';

          if (!items.length) {
            setPlansPlaceholder('Nenhum plano cadastrado para este bot.');
            return;
          }

          const fragment = document.createDocumentFragment();

          items.forEach((item) => {
            const row = document.createElement('div');
            row.className = 'plan-item';

            const info = document.createElement('div');
            info.className = 'plan-info';

            const title = document.createElement('div');
            title.textContent = typeof item.plan_name === 'string' ? item.plan_name : '';

            const price = document.createElement('div');
            price.className = 'plan-price';
            const statusLabel = item.is_active ? 'ativo' : 'inativo';
            price.textContent = `${centsToBRL(item.price_cents)} • ${statusLabel}`;

            info.appendChild(title);
            info.appendChild(price);

            const actions = document.createElement('div');
            actions.className = 'plan-actions';

            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'btn-secondary';
            editBtn.textContent = 'Editar';
            editBtn.addEventListener('click', () => fillPlanForm(item));

            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn-secondary';
            deleteBtn.textContent = 'Excluir';
            deleteBtn.addEventListener('click', () => removePlan(item));

            const pixBtn = document.createElement('button');
            pixBtn.type = 'button';
            pixBtn.textContent = 'Gerar PIX';
            pixBtn.disabled = !item.is_active;
            if (!item.is_active) {
              pixBtn.title = 'Plano inativo';
            }
            pixBtn.addEventListener('click', () => generatePlanPix(item));

            actions.append(editBtn, deleteBtn, pixBtn);

            row.append(info, actions);
            fragment.appendChild(row);
          });

          plansList.appendChild(fragment);
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao carregar planos.';
          setPlansPlaceholder(message);
          showToast(message);
        }
      }

      async function savePixImage() {
        const slug = (plansBotSlugInput?.value || '').trim();
        if (!slug) {
          alert('Informe o slug do bot.');
          return;
        }

        const url = (pixImageUrlInput?.value || '').trim();

        try {
          await fetchJSON(`/api/bots/${encodeURIComponent(slug)}/settings`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              pix_image_url: url || null,
              offers_text: offersText?.value || null
            }),
          });
          renderPixPreview();
          showToast('Imagem do PIX salva!');
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao salvar imagem do PIX.';
          alert(message);
        }
      }

      async function savePlan() {
        const slug = (plansBotSlugInput?.value || '').trim();
        const name = (planNameInput?.value || '').trim();
        const cents = priceToCents(planPriceInput?.value ?? '');
        const currentId = planIdInput?.value ? Number(planIdInput.value) : null;

        if (!slug || !name || !Number.isFinite(cents)) {
          alert('Preencha slug, nome e preço válidos.');
          return;
        }

        if (cents < 50) {
          alert('Valor mínimo é R$ 0,50.');
          return;
        }

        const payload = {
          plan_name: name,
          price_cents: cents,
          is_active: true,
        };

        if (Number.isFinite(currentId) && currentId) {
          payload.id = currentId;
        }

        try {
          await fetchJSON(`/api/bots/${encodeURIComponent(slug)}/plans`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          resetPlanForm();
          showToast(currentId ? 'Plano atualizado.' : 'Plano criado.');
          await loadPlans({ autoload: true });
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao salvar plano.';
          alert(message);
        }
      }

      async function removePlan(plan) {
        if (!plan) {
          return;
        }

        const slug = typeof plan.bot_slug === 'string' ? plan.bot_slug : (plansBotSlugInput?.value || '').trim();
        if (!slug) {
          alert('Não foi possível identificar o bot do plano.');
          return;
        }

        if (!confirm(`Excluir plano "${plan.plan_name}"?`)) {
          return;
        }

        try {
          await fetchJSON(`/api/bots/${encodeURIComponent(slug)}/plans/${plan.id}`, {
            method: 'DELETE',
          });
          showToast('Plano removido.');
          await loadPlans({ autoload: true });
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao excluir plano.';
          alert(message);
        }
      }

      async function generatePlanPix(plan) {
        if (!plan) {
          return;
        }

        const extra = window.prompt('Opcional: informe "telegram_id,payload_id" ou deixe vazio', '');
        let telegramId = null;
        let payloadId = null;

        if (extra && typeof extra === 'string') {
          const trimmed = extra.trim();
          if (trimmed.includes(',')) {
            const parts = trimmed.split(',');
            const maybeTelegram = Number(parts[0].trim());
            telegramId = Number.isFinite(maybeTelegram) ? maybeTelegram : null;
            const maybePayload = parts[1] ? parts[1].trim() : '';
            payloadId = maybePayload || null;
          } else if (trimmed.length) {
            const maybeTelegram = Number(trimmed);
            if (Number.isFinite(maybeTelegram)) {
              telegramId = maybeTelegram;
            } else {
              payloadId = trimmed;
            }
          }
        }

        const body = { plan_id: plan.id };
        if (telegramId !== null) {
          body.telegram_id = telegramId;
        }
        if (payloadId) {
          body.payload_id = payloadId;
        }

        try {
          const data = await fetchJSON('/api/payments/pushinpay/cash-in/by-plan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });

          if (pixTitle) {
            pixTitle.textContent = `${plan.plan_name} — ${centsToBRL(plan.price_cents)}`;
          }
          if (pixQr) {
            pixQr.src = typeof data.qr_code_base64 === 'string' ? data.qr_code_base64 : '';
            pixQr.style.display = pixQr.src ? 'block' : 'none';
          }
          if (pixCode) {
            pixCode.value = typeof data.qr_code === 'string' ? data.qr_code : '';
          }
          if (pixNotice) {
            const fallback = pixNoticeDefault || pixNotice.getAttribute('data-default') || pixNotice.innerHTML;
            pixNotice.innerHTML = typeof data.notice_html === 'string' && data.notice_html
              ? data.notice_html
              : fallback;
          }

          if (pixModal && typeof pixModal.showModal === 'function') {
            pixModal.showModal();
          } else {
            alert('Seu navegador não suporta o modal. Código PIX: ' + (pixCode ? pixCode.value : ''));
          }
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao gerar PIX.';
          alert(message);
        }
      }

      // map last route by key: find which route was last used for each media_key
      function mapRouteUsedByKey(sendMetrics) {
        const routeByKey = {};
        // iterate in reverse (newest first) to get the most recent usage
        for (let i = sendMetrics.length - 1; i >= 0; i--) {
          const item = sendMetrics[i];
          const key = item.media_key;
          if (key && !routeByKey[key]) {
            routeByKey[key] = item.route || '';
          }
        }
        return routeByKey;
      }

      async function refreshMediaCache(slug) {
        if (!mediaCacheTableContainer) {
          return;
        }
        if (!slug) {
          renderMediaCachePlaceholder('Selecione um bot para visualizar o cache.', { state: 'idle' });
          return;
        }

        const requestId = ++mediaCacheRequestId;
        renderMediaCachePlaceholder('Carregando cache…', { state: 'loading' });

        try {
          const data = await fetchJSON(`/admin/api/bots/${encodeURIComponent(slug)}/media-cache`);
          if (requestId !== mediaCacheRequestId) {
            return;
          }
          const items = Array.isArray(data?.items) ? data.items : [];
          cachedCacheItems = items;

          if (items.length === 0) {
            renderMediaCachePlaceholder('Sem itens no cache ainda. Sugestão: clique Aquecer tudo.', { state: 'empty' });
            return;
          }

          renderCacheTable(items);
        } catch (error) {
          if (requestId !== mediaCacheRequestId) {
            return;
          }
          const detail = error instanceof Error ? error.message : 'falha inesperada.';
          renderMediaCachePlaceholder(`Erro ao carregar cache: ${detail}`, { state: 'error' });
        }
      }

      function renderCacheTable(items) {
        if (!mediaCacheTableContainer) return;

        setWarmupAllButtonVisibility(false);

        // map last route used by key
        const routeByKey = mapRouteUsedByKey(cachedSendMetrics);
        
        const table = document.createElement('table');
        table.className = 'cache-table';
        
        const thead = document.createElement('thead');
        const headRow = document.createElement('tr');
        ['Key', 'Type', 'Status', 'Em uso via', 'File ID', 'Last Warmed', 'Ações'].forEach((label) => {
          const th = document.createElement('th');
          th.textContent = label;
          th.setAttribute('aria-label', label);
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        items.forEach((item) => {
          const row = document.createElement('tr');
          row.dataset.key = item.media_key || '';
          row.dataset.type = item.media_type || '';
          row.dataset.status = item.status || '';

          // key
          const keyCell = document.createElement('td');
          keyCell.textContent = item.media_key || '';
          keyCell.style.fontFamily = 'monospace';
          keyCell.style.fontSize = '12px';
          keyCell.style.wordBreak = 'break-all';
          row.appendChild(keyCell);

          // type
          const typeCell = document.createElement('td');
          typeCell.textContent = item.media_type || '';
          row.appendChild(typeCell);

          // status pill
          const statusCell = document.createElement('td');
          const statusPill = document.createElement('span');
          statusPill.className = `pill ${item.status === 'warm' ? 'warm' : 'error'}`;
          statusPill.textContent = item.status || '';
          statusCell.appendChild(statusPill);
          row.appendChild(statusCell);

          // em uso via (route)
          const routeCell = document.createElement('td');
          const route = routeByKey[item.media_key] || '';
          if (route) {
            const routeSpan = document.createElement('span');
            routeSpan.className = 'route-used';
            routeSpan.textContent = route;
            routeCell.appendChild(routeSpan);
          } else {
            routeCell.textContent = '-';
            routeCell.style.color = '#d1d5db';
          }
          row.appendChild(routeCell);

          // file_id
          const fileCell = document.createElement('td');
          fileCell.textContent = item.file_id || '';
          fileCell.style.fontFamily = 'monospace';
          fileCell.style.fontSize = '11px';
          fileCell.style.wordBreak = 'break-all';
          row.appendChild(fileCell);

          // last_warmed with badge if stale (> 7 days)
          const warmedCell = document.createElement('td');
          const warmedValue = item.last_warmed_at ? String(item.last_warmed_at) : '';
          warmedCell.textContent = warmedValue;
          warmedCell.style.fontSize = '12px';
          
          // check if stale (>7 days)
          if (item.last_warmed_at) {
            const warmedDate = new Date(item.last_warmed_at);
            const now = new Date();
            const diffDays = (now - warmedDate) / (1000 * 60 * 60 * 24);
            if (diffDays > 7) {
              const staleBadge = document.createElement('span');
              staleBadge.className = 'badge stale';
              staleBadge.textContent = '7d+';
              staleBadge.title = 'Cache desatualizado (mais de 7 dias)';
              warmedCell.appendChild(staleBadge);
            }
          }
          row.appendChild(warmedCell);

          // warmup action button
          const actionCell = document.createElement('td');
          const warmupBtn = document.createElement('button');
          warmupBtn.className = 'btn-warmup';
          warmupBtn.textContent = 'Aquecer';
          warmupBtn.setAttribute('aria-label', `Aquecer mídia ${item.media_key}`);
          warmupBtn.onclick = async () => {
            // warmup action: call POST /admin/api/bots/:slug/warmup?key=...
            await handleWarmupSingle(item.media_key);
          };
          actionCell.appendChild(warmupBtn);
          row.appendChild(actionCell);

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        
        const wrapper = document.createElement('div');
        wrapper.className = 'table-wrap';
        wrapper.appendChild(table);
        
        mediaCacheTableContainer.innerHTML = '';
        mediaCacheTableContainer.appendChild(wrapper);
      }

      // warmup action: single key
      async function handleWarmupSingle(key) {
        const bot = state.bots.find(b => b.id === state.currentBotId);
        if (!bot || !bot.slug) {
          showToast('Nenhum bot selecionado.');
          return;
        }
        
        try {
          const url = `/admin/api/bots/${encodeURIComponent(bot.slug)}/warmup?key=${encodeURIComponent(key)}`;
          const response = await fetchJSON(url, { method: 'POST' });
          showToast(`Aquecimento de "${key}" concluído!`);

          // refresh cache and metrics
          const limit = getSelectedMetricsLimit();
          await Promise.all([
            refreshMediaCache(bot.slug),
            scheduleMetricsRefresh({ slug: bot.slug, limit, silent: true }),
          ]);
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao aquecer mídia.';
          showToast(message);
        }
      }

      async function handleWarmupAll() {
        const bot = state.bots.find(b => b.id === state.currentBotId);
        if (!bot || !bot.slug) {
          showToast('Nenhum bot selecionado.');
          return;
        }
        if (!warmupAllBtn) {
          return;
        }

        const limit = getSelectedMetricsLimit();
        if (!bot.warmup_chat_id) {
          showToast('Configure o chat de warmup antes de aquecer.');
          return;
        }
        warmupAllBtn.disabled = true;
        warmupAllBtn.textContent = 'Aquecendo…';

        try {
          await fetchJSON(`/admin/api/bots/${encodeURIComponent(bot.slug)}/warmup`, { method: 'POST' });
          showToast('Aquecer tudo concluído!');
          await Promise.all([
            refreshMediaCache(bot.slug),
            scheduleMetricsRefresh({ slug: bot.slug, limit, silent: true }),
          ]);
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao aquecer mídias.';
          showToast(message);
        } finally {
          resetWarmupAllButton();
        }
      }

      // metrics: load send metrics from API
      async function loadSendMetrics({ slug, limit }) {
        const params = new URLSearchParams();
        if (limit) params.set('limit', String(limit));
        const url = `/admin/api/metrics/telegram-sends?${params.toString()}`;
        const data = await fetchJSON(url);
        let items = Array.isArray(data?.items) ? data.items : [];
        
        // filter by slug if provided (server-side may not support it)
        if (slug) {
          items = items.filter(item => item.bot_slug === slug);
        }
        
        cachedSendMetrics = items;
        return items;
      }

      // metrics: load send stats (p50/p95/p99 by route)
      async function loadSendStats({ slug }) {
        const data = await fetchJSON('/admin/api/metrics/telegram-sends/stats');
        const stats = data?.stats || {};
        const routeStats = stats.routes || {};
        
        // filter routes by slug if needed (server may not support it)
        // for now, return all routes; UI will show only relevant ones
        return routeStats;
      }

      // metrics: render KPIs (p50/p95/p99 by route)
      function renderKPIs(routeStats) {
        if (!kpiContainer) return;
        
        const routes = Object.keys(routeStats);
        if (routes.length === 0) {
          kpiContainer.innerHTML = '<div class="placeholder" style="text-align:center; color:#9ca3af; padding:24px; font-style:italic;">Nenhuma métrica disponível ainda.</div>';
          return;
        }
        
        // main routes to show
        const priorityRoutes = ['file_id', 'url_fallback', 'file_id_after_warm'];
        const displayRoutes = priorityRoutes.filter(r => routes.includes(r));
        const otherRoutes = routes.filter(r => !priorityRoutes.includes(r));
        const finalRoutes = [...displayRoutes, ...otherRoutes].slice(0, 5); // max 5 routes
        
        const html = finalRoutes.map(route => {
          const info = routeStats[route] || {};
          const p50 = info.p50_ms ?? '-';
          const p95 = info.p95_ms ?? '-';
          const p99 = info.p99_ms ?? '-';
          
          return `
            <div class="kpi-route">
              <div class="kpi-route-name">${escapeHtml(route)}</div>
              <div class="kpi-stats">
                <div class="kpi-stat">
                  <div class="kpi-label">p50</div>
                  <div class="kpi-value">${escapeHtml(p50)}<span style="font-size:11px; font-weight:400;">ms</span></div>
                </div>
                <div class="kpi-stat">
                  <div class="kpi-label">p95</div>
                  <div class="kpi-value">${escapeHtml(p95)}<span style="font-size:11px; font-weight:400;">ms</span></div>
                </div>
                <div class="kpi-stat">
                  <div class="kpi-label">p99</div>
                  <div class="kpi-value">${escapeHtml(p99)}<span style="font-size:11px; font-weight:400;">ms</span></div>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        kpiContainer.innerHTML = html;
      }

      // metrics: main refresh handler
      async function fetchAndRenderMetrics({ slug, limit, silent = false }) {
        if (!slug) {
          if (!silent) {
            showToast('Selecione um bot primeiro.');
          }
          return;
        }

        if (!silent && btnRefreshMetrics) {
          btnRefreshMetrics.disabled = true;
        }

        try {
          const [sendMetrics, routeStats] = await Promise.all([
            loadSendMetrics({ slug, limit }),
            loadSendStats({ slug }),
          ]);

          renderSendMetricsChart(sendMetrics);
          renderKPIs(routeStats);
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao carregar métricas.';
          if (!silent) {
            showToast(message);
          } else {
            console.error('Erro ao atualizar métricas automaticamente:', error);
          }
        } finally {
          if (!silent && btnRefreshMetrics) {
            btnRefreshMetrics.disabled = false;
          }
        }
      }

      const scheduleMetricsRefresh = debounceAsync(fetchAndRenderMetrics, 250);

      async function onRefreshMetrics() {
        const slug = metricsBotSelect?.value || '';
        const limit = getSelectedMetricsLimit();
        await scheduleMetricsRefresh({ slug, limit, silent: false });
      }

      function renderLatencyPlaceholder(message = 'Nenhum envio registrado ainda.') {
        const canvas = getLatencyCanvas();
        if (!canvas) {
          return;
        }

        destroyLatencyChart();

        const ctx = canvas.getContext('2d');
        if (!ctx) {
          return;
        }

        const width = canvas.width || canvas.clientWidth || 0;
        const height = canvas.height || canvas.clientHeight || 0;
        ctx.clearRect(0, 0, width, height);
        ctx.fillStyle = '#9ca3af';
        ctx.font = '13px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(message, width / 2, height / 2);
      }

      // metrics: build datasets for chart
      function renderSendMetricsChart(items) {
        const canvas = getLatencyCanvas();
        if (!canvas) return;

        if (!Array.isArray(items) || items.length === 0) {
          renderLatencyPlaceholder();
          if (cachedCacheItems.length > 0) {
            renderCacheTable(cachedCacheItems);
          }
          return;
        }

        cachedSendMetrics = items;

        // group by route
        const routeMap = {};
        items.forEach(item => {
          const route = item.route || 'unknown';
          if (!routeMap[route]) routeMap[route] = [];
          routeMap[route].push(item);
        });

        // colors for routes
        const colorPalette = {
          file_id: '#10b981',
          url_fallback: '#f59e0b',
          file_id_after_warm: '#3b82f6',
          warmup_to_channel: '#8b5cf6',
          keepalive_ping: '#ef4444',
        };
        const defaultColors = ['#64748b', '#06b6d4', '#ec4899', '#84cc16'];

        const datasets = Object.keys(routeMap).map((route, idx) => {
          const color = colorPalette[route] || defaultColors[idx % defaultColors.length];
          const data = routeMap[route]
            .map(item => {
              if (!item || !item.ts) {
                return null;
              }
              const value = Number(item.tg_ms);
              return {
                ts: item.ts,
                tg_ms: Number.isFinite(value) ? value : 0,
              };
            })
            .filter(Boolean)
            .sort((a, b) => new Date(a.ts).getTime() - new Date(b.ts).getTime());

          if (data.length === 0) {
            return null;
          }

          return {
            label: route,
            data,
            borderColor: color,
            backgroundColor: color + '33',
            borderWidth: 2,
            pointRadius: 3,
            pointHoverRadius: 5,
            tension: 0.2,
          };
        }).filter(Boolean);

        upsertLatencyChart({ datasets });
        ensureLatencyChartVisible();
        if (cachedCacheItems.length > 0) {
          renderCacheTable(cachedCacheItems);
        }
      }

      async function fetchJSON(url, opts = {}) {
        const headers = new Headers(opts.headers || {});
        const token = getAdminToken();
        if (!token) {
          throw new Error('Informe o token de admin para continuar.');
        }
        if (!headers.has('Authorization')) {
          headers.set('Authorization', `Bearer ${token}`);
        }
        const response = await fetch(url, { ...opts, headers });
        const text = await response.text();
        let data = null;
        if (text) {
          try {
            data = JSON.parse(text);
          } catch (err) {
            data = text;
          }
        }
        if (!response.ok) {
          const message = typeof data === 'object' && data !== null && 'error' in data
            ? data.error
            : data || response.statusText || 'Erro desconhecido';
          throw new Error(typeof message === 'string' ? message : 'Erro ao carregar dados');
        }
        return data;
      }

      function updateNoBotsVisibility() {
        const hasBots = state.bots.length > 0;
        if (!hasBots) {
          state.currentBotId = null;
        }
        noBotsEl.classList.toggle('hidden', hasBots);
        paneEl.classList.toggle('hidden', !hasBots || !state.currentBotId);
        if (paneEl && !paneEl.classList.contains('hidden')) {
          requestAnimationFrame(() => ensureLatencyChartVisible());
        }
        if (!hasBots || !state.currentBotId) {
          renderMediaCachePlaceholder('Selecione um bot para visualizar o cache.', { state: 'idle' });
          if (plansBotSlugInput) {
            plansBotSlugInput.value = '';
          }
          if (plansList) {
            setPlansPlaceholder('Informe o slug do bot e clique em "Carregar planos".');
          }
          downsellsItems = [];
          updateDownsellsSlugLabel('');
          renderDownsellPlaceholder('Selecione um bot para visualizar os downsells.');
          destroyLatencyChart();
        }
      }

      function deepClone(value) {
        return value == null ? value : JSON.parse(JSON.stringify(value));
      }

      function getCurrentBot() {
        if (!state.currentBotId) {
          return null;
        }
        return state.bots.find((bot) => bot.id === state.currentBotId) || null;
      }

      function getBotIdFromHash() {
        const match = new URL(window.location.href).hash.match(/bot=([a-f0-9-]+)/i);
        return match ? match[1] : null;
      }

      async function loadBots({ preserveSelection = true, selectBotId = null } = {}) {
        try {
          const bots = await fetchJSON('/admin/bots');
          const previousId = preserveSelection ? state.currentBotId : null;
          state.bots = Array.isArray(bots) ? bots : [];

          const ids = new Set(state.bots.map((b) => b.id));
          Array.from(state.cache.keys()).forEach((key) => {
            if (!ids.has(key)) {
              state.cache.delete(key);
            }
          });
          Array.from(state.dirty).forEach((key) => {
            if (!ids.has(key)) {
              state.dirty.delete(key);
            }
          });

          let targetId = null;
          if (typeof selectBotId === 'string' && ids.has(selectBotId)) {
            targetId = selectBotId;
          }
          if (!targetId) {
            const hashId = getBotIdFromHash();
            if (hashId && ids.has(hashId)) {
              targetId = hashId;
            }
          }
          if (!targetId && previousId && ids.has(previousId)) {
            targetId = previousId;
          }
          if (!targetId && state.bots[0]) {
            targetId = state.bots[0].id;
          }

          renderTabs();
          updateNoBotsVisibility();
          
          // metrics: populate bot select
          populateMetricsBotSelect();

          if (targetId) {
            await selectBot(targetId);
          }
        } catch (err) {
          alert(err instanceof Error ? err.message : 'Erro ao carregar bots.');
          state.bots = [];
          renderTabs();
          updateNoBotsVisibility();
        }
      }

      function renderTabs() {
        tabsScroll.innerHTML = '';
        state.bots.forEach((bot) => {
          const tab = document.createElement('div');
          tab.className = 'tab' + (bot.id === state.currentBotId ? ' active' : '');
          tab.dataset.id = bot.id;
          const label = bot.slug || bot.name || bot.id.slice(0, 8);
          tab.textContent = label;
          if (state.dirty.has(bot.id)) {
            const badge = document.createElement('span');
            badge.className = 'dirty';
            badge.textContent = '*';
            tab.appendChild(badge);
          }
          tab.onclick = () => selectBot(bot.id);
          tabsScroll.appendChild(tab);
        });
      }

      async function selectBot(botId) {
        const targetBot = state.bots.find((bot) => bot.id === botId);
        if (!targetBot) {
          return;
        }
        if (state.currentBotId === botId) {
          history.replaceState(null, '', `#bot=${botId}`);
          updateNoBotsVisibility();
          return;
        }

        if (state.currentBotId && state.dirty.has(state.currentBotId)) {
          state.cache.set(state.currentBotId, pane.read());
        }

        state.currentBotId = botId;
        if (plansBotSlugInput) {
          plansBotSlugInput.value = targetBot.slug || '';
        }
        void loadDownsells({ silent: true });
        resetPlanForm();
        if (targetBot.slug) {
          void loadPlans({ autoload: true });
        } else if (plansList) {
          setPlansPlaceholder('Informe o slug do bot e clique em "Carregar planos".');
        }
        history.replaceState(null, '', `#bot=${botId}`);
        renderTabs();
        updateNoBotsVisibility();

        // metrics: sync bot select
        if (metricsBotSelect && targetBot.slug) {
          metricsBotSelect.value = targetBot.slug;
        }

        destroyLatencyChart();
        await loadBotPane(botId);
      }

      async function loadBotPane(botId) {
        try {
          let data = state.cache.get(botId);
          if (!data) {
            const fresh = await fetchJSON(`/admin/bots/${botId}/templates/start`);
            data = normalizeTemplate(fresh);
            state.cache.set(botId, deepClone(data));
          }
          const keepDirty = state.dirty.has(botId);
          pane.fill(botId, normalizeTemplate(data), { keepDirty });
          paneEl.classList.remove('hidden');
          requestAnimationFrame(() => ensureLatencyChartVisible());
        } catch (err) {
          alert(err instanceof Error ? err.message : 'Erro ao carregar template.');
        }
      }

      function normalizeTemplate(raw) {
        const fallback = { parse_mode: 'Markdown', text: '', start_messages: [], medias: [] };
        if (!raw || typeof raw !== 'object') {
          return fallback;
        }
        const parseMode = typeof raw.parse_mode === 'string' ? raw.parse_mode : fallback.parse_mode;
        const text = typeof raw.text === 'string' ? raw.text : fallback.text;
        
        // Normaliza start_messages: preferência pelo array, fallback para text
        let startMessages = [];
        if (Array.isArray(raw.start_messages) && raw.start_messages.length > 0) {
          startMessages = raw.start_messages.map(s => String(s)).filter(Boolean);
        } else if (text) {
          startMessages = [text];
        }
        
        const list = Array.isArray(raw.medias)
          ? raw.medias
          : Array.isArray(raw.media)
          ? raw.media.map((item) => ({ type: item.type, url: item.media }))
          : [];
        const medias = list
          .filter((item) => item && typeof item === 'object')
          .map((item) => ({
            type: item.type === 'video' || item.type === 'audio' ? item.type : 'photo',
            url: typeof item.url === 'string' ? item.url : typeof item.media === 'string' ? item.media : '',
          }));
        return { parse_mode: parseMode, text, start_messages: startMessages, medias };
      }

      const pane = (() => {
        const parseSel = document.getElementById('parse-mode');
        const textArea = document.getElementById('start-text');
        const mediaList = document.getElementById('media-list');
        const mediaEmpty = document.getElementById('media-empty');
        const addMediaBtn = document.getElementById('add-media');
        const saveBtn = document.getElementById('save-start');
        const statusEl = document.getElementById('status');
        const revealTokenBtn = document.getElementById('reveal-token');
        const copyWebhookBtn = document.getElementById('copy-webhook');
        const tokenField = document.getElementById('hdr-bot-token');
        
        // Start messages repeater
        const startMessagesList = document.getElementById('start-messages-list');
        const addStartMessageBtn = document.getElementById('add-start-message');

        function clearStatus() {
          statusEl.textContent = '';
          statusEl.className = 'status hidden';
        }

        function showStatus(type, message) {
          statusEl.textContent = message;
          statusEl.className = `status ${type}`;
        }

        // Start messages repeater functions
        function getStartMessagesValues() {
          return Array.from(startMessagesList.querySelectorAll('.start-msg-text'))
            .map(textarea => textarea.value.trim())
            .filter(Boolean)
            .slice(0, 3);
        }

        function refreshAddMessageButton() {
          const count = startMessagesList.querySelectorAll('.start-msg-item').length;
          addStartMessageBtn.disabled = count >= 3;
        }

        function createStartMessageItem(value = '') {
          const wrapper = document.createElement('div');
          wrapper.className = 'start-msg-item';
          wrapper.innerHTML = `
            <div class="msg-header">
              <strong>Mensagem /start</strong>
              <div class="msg-actions">
                <button type="button" class="up" title="Mover para cima">↑</button>
                <button type="button" class="down" title="Mover para baixo">↓</button>
                <button type="button" class="remove" title="Remover">Excluir</button>
              </div>
            </div>
            <textarea class="start-msg-text" placeholder="Texto em Markdown/HTML conforme Parse Mode selecionado"></textarea>
          `;
          
          const textarea = wrapper.querySelector('.start-msg-text');
          textarea.value = value || '';
          textarea.addEventListener('input', () => notifyChange());
          
          wrapper.querySelector('.remove').addEventListener('click', () => {
            wrapper.remove();
            refreshAddMessageButton();
            notifyChange();
          });
          
          wrapper.querySelector('.up').addEventListener('click', () => {
            if (wrapper.previousElementSibling) {
              startMessagesList.insertBefore(wrapper, wrapper.previousElementSibling);
              notifyChange();
            }
          });
          
          wrapper.querySelector('.down').addEventListener('click', () => {
            if (wrapper.nextElementSibling) {
              startMessagesList.insertBefore(wrapper.nextElementSibling, wrapper);
              notifyChange();
            }
          });
          
          return wrapper;
        }

        addStartMessageBtn.addEventListener('click', () => {
          if (startMessagesList.querySelectorAll('.start-msg-item').length >= 3) return;
          startMessagesList.appendChild(createStartMessageItem(''));
          refreshAddMessageButton();
          notifyChange();
        });

        function updateMediaEmptyState() {
          const hasRows = mediaList.querySelector('.media-row');
          mediaEmpty.classList.toggle('hidden', Boolean(hasRows));
        }

        function serializeRow(row) {
          const typeSel = row.querySelector('.media-type');
          const urlInput = row.querySelector('.media-url');
          return {
            type: (typeSel?.value || 'photo'),
            url: (urlInput?.value || '').trim(),
          };
        }

        function notifyChange() {
          if (!state.currentBotId) return;
          clearStatus();
          state.dirty.add(state.currentBotId);
          state.cache.set(state.currentBotId, read());
          renderTabs();
        }

        function attachUpload(row) {
          const removeBtn = row.querySelector('.media-del');
          const fileInput = row.querySelector('.media-file');
          const urlInput = row.querySelector('.media-url');
          const typeSelect = row.querySelector('.media-type');
          const dropzone = row.querySelector('.dropzone');

          if (removeBtn) {
            removeBtn.addEventListener('click', () => {
              row.remove();
              updateMediaEmptyState();
              notifyChange();
            });
          }

          if (urlInput) {
            urlInput.addEventListener('input', () => notifyChange());
          }

          if (typeSelect) {
            typeSelect.addEventListener('change', () => notifyChange());
          }

          async function uploadFile(file) {
            if (!file) return;
            if (!/^(image|video|audio)\//.test(file.type || '')) {
              alert('Tipo de arquivo não suportado. Selecione imagem, vídeo ou áudio.');
              return;
            }
            if (file.size > 20 * 1024 * 1024) {
              alert('Arquivo maior que 20MB. Selecione um arquivo menor.');
              return;
            }

            const formData = new FormData();
            formData.append('file', file);

            const buttonLabel = row.querySelector('.media-file-btn span');
            const originalLabel = buttonLabel ? buttonLabel.textContent : '';
            if (buttonLabel) {
              buttonLabel.textContent = 'Enviando…';
            }

            try {
              const headers = new Headers();
              const token = getAdminToken();
              if (token) {
                headers.set('Authorization', `Bearer ${token}`);
              }
              const response = await fetch('/api/admin/upload', {
                method: 'POST',
                body: formData,
                headers,
              });
              const data = await response.json().catch(() => ({}));
              if (!response.ok || !data?.ok || !data?.url) {
                const reason = data?.error || response.statusText || 'Falha no upload.';
                alert(`Erro no upload: ${reason}`);
                return;
              }
              if (urlInput) {
                urlInput.value = data.url;
              }
              notifyChange();
            } catch (error) {
              console.error(error);
              alert('Erro ao enviar arquivo.');
            } finally {
              if (buttonLabel) {
                buttonLabel.textContent = originalLabel || 'Enviar arquivo…';
              }
              if (fileInput) {
                fileInput.value = '';
              }
            }
          }

          if (fileInput) {
            fileInput.addEventListener('change', (event) => {
              const file = event?.target?.files?.[0];
              void uploadFile(file);
            });
          }

          if (dropzone) {
            dropzone.addEventListener('dragover', (event) => {
              event.preventDefault();
              dropzone.classList.add('dragover');
            });
            dropzone.addEventListener('dragleave', () => {
              dropzone.classList.remove('dragover');
            });
            dropzone.addEventListener('drop', (event) => {
              event.preventDefault();
              dropzone.classList.remove('dragover');
              const file = event?.dataTransfer?.files?.[0];
              void uploadFile(file);
            });
          }
        }

        function addMediaRow(initial) {
          const row = document.createElement('div');
          row.className = 'media-row';
          row.innerHTML = `
            <select class="media-type">
              <option value="photo">Foto</option>
              <option value="video">Vídeo</option>
              <option value="audio">Áudio</option>
            </select>
            <input type="url" class="media-url" placeholder="https://...">
            <label class="media-file-btn">
              <input type="file" class="media-file" accept="image/*,video/*,audio/*" hidden>
              <span>Enviar arquivo…</span>
            </label>
            <button type="button" class="btn-secondary media-del" title="Remover">🗑️</button>
            <div class="dropzone">Arraste e solte aqui ou clique em “Enviar arquivo…”</div>
          `;

          mediaList.appendChild(row);
          if (initial && typeof initial === 'object') {
            const typeSel = row.querySelector('.media-type');
            const urlInput = row.querySelector('.media-url');
            if (typeSel && initial.type) {
              typeSel.value = initial.type;
            }
            if (urlInput && initial.url) {
              urlInput.value = initial.url;
            }
          }

          attachUpload(row);
          updateMediaEmptyState();
          return row;
        }

        addMediaBtn.addEventListener('click', () => {
          addMediaRow();
          notifyChange();
        });

        parseSel.addEventListener('change', () => notifyChange());
        textArea.addEventListener('input', () => notifyChange());

        revealTokenBtn.addEventListener('click', () => {
          if (!tokenField.value) return;
          const isPassword = tokenField.type === 'password';
          tokenField.type = isPassword ? 'text' : 'password';
          revealTokenBtn.textContent = isPassword ? '🙈' : '👁';
        });

        copyWebhookBtn.addEventListener('click', async () => {
          const webhook = document.getElementById('hdr-webhook').textContent || '';
          if (!webhook || webhook === '—') {
            return;
          }
          try {
            await navigator.clipboard.writeText(webhook);
            showStatus('info', 'Webhook copiado para a área de transferência.');
            setTimeout(clearStatus, 2500);
          } catch (err) {
            console.warn(err);
            window.prompt('Copie o webhook manualmente:', webhook);
          }
        });

        saveBtn.addEventListener('click', async () => {
          if (!state.currentBotId) return;
          try {
            showStatus('info', 'Salvando…');
            const botId = state.currentBotId;
            const payload = read();
            const body = {
              parse_mode: payload.parse_mode,
              text: payload.text,
              start_messages: payload.start_messages || [],
              media: payload.medias.map((item) => ({ type: item.type, media: item.url })),
            };
            await fetchJSON(`/admin/bots/${botId}/templates/start`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body),
            });
            state.cache.set(botId, deepClone(payload));
            state.dirty.delete(botId);
            renderTabs();
            showStatus('success', 'Template /start salvo com sucesso!');
            setTimeout(clearStatus, 3500);
          } catch (err) {
            showStatus('error', err instanceof Error ? err.message : 'Erro ao salvar template.');
          }
        });

        function fill(botId, data, options = {}) {
          const normalized = normalizeTemplate(data);
          clearStatus();
          parseSel.value = normalized.parse_mode || 'Markdown';
          textArea.value = normalized.text || '';

          // Populate start messages repeater
          startMessagesList.innerHTML = '';
          const messages = Array.isArray(normalized.start_messages) && normalized.start_messages.length > 0
            ? normalized.start_messages
            : (normalized.text ? [normalized.text] : ['']);
          messages.slice(0, 3).forEach(msg => {
            startMessagesList.appendChild(createStartMessageItem(msg));
          });
          refreshAddMessageButton();

          mediaList.innerHTML = '';
          (normalized.medias || []).forEach((item) => addMediaRow(item));
          updateMediaEmptyState();

          fillBotHeader(botId);

          if (!options.keepDirty) {
            state.dirty.delete(botId);
          }
          renderTabs();
        }

        function read() {
          const medias = Array.from(mediaList.querySelectorAll('.media-row'))
            .map((row) => serializeRow(row))
            .filter((item) => item.url);
          const startMessages = getStartMessagesValues();
          return {
            parse_mode: parseSel.value || 'Markdown',
            text: startMessages[0] || '',
            start_messages: startMessages,
            medias,
          };
        }

        return { fill, read, showStatus, clearStatus };
      })();

      function fillBotHeader(botId) {
        const bot = state.bots.find((b) => b.id === botId);
        if (!bot) return;
        const idEl = document.getElementById('hdr-bot-id');
        const slugEl = document.getElementById('hdr-bot-slug');
        const tokenEl = document.getElementById('hdr-bot-token');
        const webhookEl = document.getElementById('hdr-webhook');
        const copyBtn = document.getElementById('copy-webhook');
        const revealBtn = document.getElementById('reveal-token');

        idEl.textContent = bot.id;
        slugEl.textContent = bot.slug || '(sem slug)';
        tokenEl.type = 'password';
        revealBtn.textContent = '👁';
        if (bot.token) {
          tokenEl.value = bot.token;
        } else {
          tokenEl.value = '*****';
        }

        if (warmupChatInput instanceof HTMLInputElement) {
          warmupChatInput.value = bot.warmup_chat_id || '';
        }
        if (doWarmupBtn instanceof HTMLButtonElement) {
          doWarmupBtn.disabled = !bot.warmup_chat_id;
        }

        if (bot.slug) {
          void refreshMediaCache(bot.slug);
          const limit = getSelectedMetricsLimit();
          void scheduleMetricsRefresh({ slug: bot.slug, limit, silent: true });
        } else {
          renderMediaCachePlaceholder('Configure o slug do bot para visualizar o cache.', { state: 'idle' });
        }

        const origin = window.location.origin.replace(/\/$/, '');
        if (bot.slug) {
          webhookEl.textContent = `${origin}/tg/${bot.slug}/webhook`;
          copyBtn.disabled = false;
        } else {
          webhookEl.textContent = '—';
          copyBtn.disabled = true;
        }
      }

      // metrics: event listeners
      btnRefreshMetrics?.addEventListener('click', () => {
        void onRefreshMetrics();
      });

      // metrics: populate bot select when bots load
      function populateMetricsBotSelect() {
        if (!metricsBotSelect) return;

        const currentValue = metricsBotSelect.value;
        metricsBotSelect.innerHTML = '<option value="">Selecione um bot</option>';

        state.bots.forEach(bot => {
          const option = document.createElement('option');
          option.value = bot.slug || '';
          option.textContent = `${bot.title || bot.slug || 'Bot'} (${bot.slug})`;
          metricsBotSelect.appendChild(option);
        });

        // restore selection
        if (currentValue) {
          metricsBotSelect.value = currentValue;
        }
      }

      // metrics: debounce helper
      function debounce(fn, delay) {
        let timeoutId;
        return function (...args) {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      function debounceAsync(fn, delay) {
        let timeoutId = null;
        let pendingPromise = null;
        let pendingResolve;
        let pendingReject;
        let lastArgs = null;
        let chain = Promise.resolve();

        return function (...args) {
          lastArgs = args;
          if (timeoutId) {
            clearTimeout(timeoutId);
          }
          if (!pendingPromise) {
            pendingPromise = new Promise((resolve, reject) => {
              pendingResolve = resolve;
              pendingReject = reject;
            });
          }
          timeoutId = setTimeout(() => {
            timeoutId = null;
            const currentArgs = lastArgs;
            lastArgs = null;
            const resolve = pendingResolve;
            const reject = pendingReject;
            pendingPromise = null;
            pendingResolve = pendingReject = null;
            const execution = chain.then(() => fn.apply(this, currentArgs));
            chain = execution.catch(() => {});
            execution.then(resolve, reject);
          }, delay);
          return pendingPromise;
        };
      }

      // metrics: filter cache table
      function filterCacheTable() {
        const searchValue = (cacheSearch?.value || '').toLowerCase().trim();
        const typeValue = cacheTypeFilter?.value || '';
        const statusValue = cacheStatusFilter?.value || '';
        
        const filteredItems = cachedCacheItems.filter(item => {
          const keyMatch = !searchValue || (item.media_key || '').toLowerCase().includes(searchValue);
          const typeMatch = !typeValue || item.media_type === typeValue;
          const statusMatch = !statusValue || item.status === statusValue;
          return keyMatch && typeMatch && statusMatch;
        });
        
        renderCacheTable(filteredItems);
      }

      const debouncedFilterCache = debounce(filterCacheTable, 300);

      cacheSearch?.addEventListener('input', debouncedFilterCache);
      cacheTypeFilter?.addEventListener('change', filterCacheTable);
      cacheStatusFilter?.addEventListener('change', filterCacheTable);
      warmupAllBtn?.addEventListener('click', () => {
        void handleWarmupAll();
      });

      saveWarmupBtn?.addEventListener('click', async () => {
        const bot = getCurrentBot();
        if (!bot || !bot.slug) {
          alert('Selecione um bot com slug configurado.');
          return;
        }
        const value = warmupChatInput instanceof HTMLInputElement ? warmupChatInput.value.trim() : '';
        if (!value) {
          alert('Informe o chat ID de warmup.');
          return;
        }
        try {
          await fetchJSON(`/admin/api/bots/${encodeURIComponent(bot.slug)}/warmup-chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ warmup_chat_id: value }),
          });
          bot.warmup_chat_id = value;
          if (doWarmupBtn instanceof HTMLButtonElement) {
            doWarmupBtn.disabled = false;
          }
          showToast('Warmup chat salvo!');
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao salvar warmup chat.';
          alert(message);
        }
      });

      doWarmupBtn?.addEventListener('click', async () => {
        const bot = getCurrentBot();
        if (!bot || !bot.slug) {
          alert('Selecione um bot com slug configurado.');
          return;
        }
        try {
          const response = await fetchJSON(`/admin/api/bots/${encodeURIComponent(bot.slug)}/warmup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({}),
          });
          const lines = Array.isArray(response?.results)
            ? response.results.map((item) => {
                if (item.status === 'warm') {
                  return `✅ ${item.key} → ${item.file_id || 'sem file_id'}`;
                }
                return `❌ ${item.key} → ${item.error || 'erro desconhecido'}`;
              })
            : [];
          alert(`Warmup executado (${response?.count ?? 0} itens)\n${lines.join('\n')}`);
          if (bot.slug) {
            const limit = getSelectedMetricsLimit();
            await Promise.all([
              refreshMediaCache(bot.slug),
              scheduleMetricsRefresh({ slug: bot.slug, limit, silent: true }),
            ]);
          }
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao aquecer mídias.';
          alert(message);
        }
      });

      downsellsAddBtn?.addEventListener('click', () => {
        openDownsellModal();
      });

      downsellsRefreshBtn?.addEventListener('click', () => {
        void loadDownsells();
      });

      downsellsModalClose?.addEventListener('click', () => {
        closeDownsellModal();
      });

      downsellsModal?.addEventListener('click', (event) => {
        const target = event.target;
        if (target === downsellsModal || (target instanceof HTMLElement && target.dataset.dismiss === 'downsells-modal')) {
          closeDownsellModal();
        }
      });

      downsellsSaveBtn?.addEventListener('click', () => {
        void saveDownsell();
      });

      downsellsList?.addEventListener('click', (event) => {
        const button = event.target instanceof HTMLElement ? event.target.closest('button') : null;
        if (!button) {
          return;
        }
        const action = button.dataset.action;
        const id = button.dataset.id;
        if (action === 'edit') {
          if (!id) {
            return;
          }
          const item = downsellsItems.find((entry) => String(entry?.id) === String(id));
          if (item) {
            openDownsellModal(item);
          }
        } else if (action === 'delete') {
          if (!id) {
            return;
          }
          if (confirm('Excluir este downsell?')) {
            void removeDownsell(id);
          }
        }
      });

      dsMediaUploadBtn?.addEventListener('click', () => {
        dsMediaFileInput?.click();
      });

      dsMediaFileInput?.addEventListener('change', async () => {
        const file = dsMediaFileInput.files?.[0];
        if (!file) {
          return;
        }
        try {
          const url = await uploadDownsellMedia(file);
          if (dsMediaUrlInput) {
            dsMediaUrlInput.value = url;
          }
          showToast('Upload concluído!');
        } catch (error) {
          console.error('[downsells] erro no upload', error);
          alert(error instanceof Error ? error.message : 'Erro ao enviar arquivo.');
        } finally {
          dsMediaFileInput.value = '';
        }
      });

      dsMediaPreviewBtn?.addEventListener('click', () => {
        const url = (dsMediaUrlInput?.value || '').trim();
        if (!url) {
          return;
        }
        window.open(url, '_blank', 'noopener');
      });

      void loadDownsells({ silent: true });

      plansLoadBtn?.addEventListener('click', () => {
        void loadPlans();
      });

      plansBotSlugInput?.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          void loadPlans();
        }
      });

      plansBotSlugInput?.addEventListener('input', () => {
        resetPlanForm();
        void loadDownsells({ silent: true });
      });

      plansBotSlugInput?.addEventListener('change', () => {
        void loadDownsells({ silent: true });
      });

      planSaveBtn?.addEventListener('click', () => {
        void savePlan();
      });

      pixPreviewBtn?.addEventListener('click', () => {
        renderPixPreview();
      });

      pixSaveBtn?.addEventListener('click', () => {
        void savePixImage();
      });

      btnPixUpload?.addEventListener('click', () => pixFile?.click());

      pixFile?.addEventListener('change', async (e) => {
        const file = e.target?.files?.[0];
        if (!file) return;
        const fd = new FormData();
        fd.append('file', file);
        const token = getAdminToken();
        try {
          const res = await fetch('/api/uploads/pix-image', {
            method: 'POST',
            headers: token ? { 'Authorization': 'Bearer ' + token } : {},
            body: fd
          });
          const data = await res.json();
          if (!res.ok) {
            alert(data.error || 'Falha no upload');
            return;
          }
          if (pixImageUrlInput) {
            pixImageUrlInput.value = data.url;
          }
          renderPixPreview();
          showToast('Upload concluído!');
        } catch (error) {
          console.error(error);
          alert('Erro ao enviar arquivo.');
        } finally {
          if (pixFile) {
            pixFile.value = '';
          }
        }
      });

      btnOffersSave?.addEventListener('click', async () => {
        const slug = (plansBotSlugInput?.value || '').trim();
        if (!slug) {
          alert('Informe o slug do bot.');
          return;
        }
        try {
          await fetchJSON(`/api/bots/${encodeURIComponent(slug)}/settings`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              pix_image_url: pixImageUrlInput?.value || null,
              offers_text: offersText?.value || null
            }),
          });
          showToast('Texto salvo!');
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao salvar texto.';
          alert(message);
        }
      });

      pixCloseBtn?.addEventListener('click', () => {
        if (pixModal && typeof pixModal.close === 'function') {
          pixModal.close();
        }
      });

      pixCopyBtn?.addEventListener('click', async () => {
        if (!pixCode) {
          return;
        }

        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(pixCode.value);
          } else {
            pixCode.select();
            if (document.execCommand) {
              document.execCommand('copy');
            }
          }
          showToast('Código PIX copiado!');
        } catch (error) {
          console.warn(error);
          alert('Não foi possível copiar automaticamente. Copie manualmente.');
        }
      });

      if (newBotBtn && newBotModal && typeof newBotModal.showModal === 'function') {
        newBotBtn.addEventListener('click', () => {
          if (newBotForm) {
            newBotForm.reset();
          }
          if (nbSetHookInput) {
            nbSetHookInput.checked = true;
          }
          if (nbEmptyInput) {
            nbEmptyInput.checked = true;
          }
          if (nbSecretInput) {
            nbSecretInput.value = '';
          }
          if (nbTokenInput) {
            nbTokenInput.value = '';
          }
          newBotModal.showModal();
          if (nbSlugInput) {
            nbSlugInput.focus();
          }
        });
      } else if (newBotBtn) {
        newBotBtn.addEventListener('click', () => {
          alert('Seu navegador não suporta a abertura do modal de novo bot.');
        });
      }

      nbTestTokenBtn?.addEventListener('click', async () => {
        const token = (nbTokenInput?.value || '').trim();
        if (!token) {
          alert('Informe o token');
          return;
        }
        try {
          const response = await fetch(`https://api.telegram.org/bot${token}/getMe`);
          const data = await response.json().catch(() => null);
          if (data?.ok) {
            const username = data?.result?.username ? `@${data.result.username}` : null;
            alert(username ? `Token OK: ${username}` : 'Token OK');
          } else {
            alert('Token inválido');
          }
        } catch (error) {
          console.warn(error);
          alert('Token inválido');
        }
      });

      nbCreateBtn?.addEventListener('click', async (event) => {
        event.preventDefault();

        const payload = {
          slug: (nbSlugInput?.value || '').trim(),
          token: (nbTokenInput?.value || '').trim(),
          title: (nbTitleInput?.value || '').trim(),
          secret: (nbSecretInput?.value || '').trim(),
          setWebhook: nbSetHookInput ? Boolean(nbSetHookInput.checked) : true,
          createEmptyTemplate: nbEmptyInput ? Boolean(nbEmptyInput.checked) : true,
        };

        if (!payload.slug || !/^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(payload.slug)) {
          alert('Slug inválido');
          return;
        }
        if (!payload.token) {
          alert('Informe o token');
          return;
        }

        const adminToken = getAdminToken();
        if (!adminToken) {
          alert('Informe o token de admin para continuar.');
          return;
        }

        const body = {
          slug: payload.slug,
          token: payload.token,
          title: payload.title || null,
          secret: payload.secret || null,
          setWebhook: payload.setWebhook,
          createEmptyTemplate: payload.createEmptyTemplate,
        };

        try {
          if (nbCreateBtn) {
            nbCreateBtn.disabled = true;
          }
          const res = await fetch('/admin/bots', {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${adminToken}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
          });

          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            if (res.status === 409) {
              alert('Esse slug já está em uso.');
            } else if (err?.error === 'telegram_token_invalid') {
              alert('Token do Telegram inválido.');
            } else if (err?.error === 'failed_to_set_webhook') {
              alert('Não foi possível configurar o webhook automaticamente.');
            } else {
              alert(`Erro ao criar: ${res.status} ${err?.error || ''}`.trim());
            }
            return;
          }

          const bot = await res.json();
          const newBotId = bot && typeof bot.id === 'string' ? bot.id : null;
          newBotModal?.close();
          if (newBotForm) {
            newBotForm.reset();
          }
          await loadBots({ preserveSelection: false, selectBotId: newBotId });
          showToast('Bot criado');
        } catch (error) {
          console.error(error);
          alert('Falha ao criar bot');
        } finally {
          if (nbCreateBtn) {
            nbCreateBtn.disabled = false;
          }
        }
      });

      applyTokenBtn.addEventListener('click', () => {
        ADMIN_TOKEN = tokenInput.value.trim();
        if (!ADMIN_TOKEN) {
          alert('Informe o token de admin para continuar.');
          localStorage.removeItem('admin_token');
          state.bots = [];
          state.cache.clear();
          state.dirty.clear();
          state.currentBotId = null;
          renderTabs();
          updateNoBotsVisibility();
          return;
        }
        localStorage.setItem('admin_token', ADMIN_TOKEN);
        loadBots({ preserveSelection: false });
      });

      tokenInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          applyTokenBtn.click();
        }
      });

      refreshBtn?.addEventListener('click', () => {
        if (!getAdminToken()) {
          alert('Informe o token de admin para continuar.');
          return;
        }
        loadBots();
      });

      window.addEventListener('hashchange', () => {
        const targetId = getBotIdFromHash();
        if (targetId && targetId !== state.currentBotId) {
          void selectBot(targetId);
        }
      });

      window.addEventListener('beforeunload', (event) => {
        if (state.dirty.size) {
          event.preventDefault();
          event.returnValue = '';
        }
      });

      if (getAdminToken()) {
        loadBots();
      } else {
        updateNoBotsVisibility();
      }
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Wizard - Multi-Bot Telegram</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 24px;
      color: #111827;
      display: flex;
      justify-content: center;
    }

    .layout {
      width: 100%;
      max-width: 960px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 25px 70px rgba(17, 24, 39, 0.35);
      padding: 28px 28px 40px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    header.top {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    header.top h1 {
      font-size: 32px;
      margin: 0 0 4px;
    }

    header.top p {
      margin: 0;
      color: #4b5563;
      font-size: 15px;
    }

    .token-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .token-card label {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
    }

    .token-input {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .token-input input {
      flex: 1 1 220px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #cbd5f5;
      font-size: 14px;
    }

    button,
    select,
    textarea,
    input {
      font-family: inherit;
    }

    .mono {
      font-family: 'SFMono-Regular', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
    }

    button {
      border: none;
      border-radius: 8px;
      background: #6366f1;
      color: #ffffff;
      font-weight: 600;
      padding: 10px 16px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    button:hover {
      background: #4f46e5;
    }

    button:disabled {
      background: #c7c9d6;
      cursor: not-allowed;
    }

    #media-cache-table {
      margin-top: 8px;
      font-size: 13px;
      overflow-x: auto;
    }

    #media-cache-table table {
      width: 100%;
      border-collapse: collapse;
      min-width: 420px;
    }

    #media-cache-table th,
    #media-cache-table td {
      text-align: left;
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
      word-break: break-all;
    }

    #media-cache-table th {
      background: #f9fafb;
      font-weight: 600;
      color: #111827;
    }

    #media-cache-table tbody tr:nth-child(even) td {
      background: #f3f4f6;
    }

    #media-cache-table .placeholder {
      color: #6b7280;
      font-style: italic;
      padding: 8px 4px;
    }

    .simple-card {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    main.card {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .muted {
      color: #6b7280;
    }

    .tiny {
      font-size: 12px;
    }

    .text-xs {
      font-size: 12px;
    }

    .opacity-70 {
      opacity: 0.7;
    }

    .mt-2 {
      margin-top: 8px;
    }

    #plans-card {
      margin-top: 24px;
    }

    #plans-card h2 {
      margin: 0;
      font-size: 22px;
      color: #111827;
    }

    #plans-card p.description {
      margin: 0;
      color: #4b5563;
      font-size: 14px;
    }

    #plans-card .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
    }

    #plans-card .form-row .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1 1 220px;
      min-width: 200px;
    }

    #plans-card .form-row .field.grow-2 {
      flex: 2 1 260px;
    }

    #plans-card input {
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 10px 12px;
      font-size: 14px;
      background: #ffffff;
      color: inherit;
    }

    #plans-card input[type='hidden'] {
      display: none;
    }

    #plans-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #plans-list .placeholder {
      border: 1px dashed #cbd5f5;
      border-radius: 10px;
      padding: 12px;
      font-size: 14px;
      color: #6b7280;
      background: #f8fafc;
    }

    #plans-list .plan-item {
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    #plans-list .plan-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #plans-list .plan-info .plan-price {
      color: #6b7280;
      font-size: 13px;
    }

    #plans-list .plan-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    #plans-card .plan-hint {
      font-size: 12px;
      color: #6b7280;
    }

    #plans-card hr {
      border: none;
      border-top: 1px solid #e5e7eb;
      margin: 8px 0 12px;
    }

    #pix-modal {
      max-width: 520px;
      width: 100%;
      padding: 24px;
    }

    #pix-modal h3 {
      margin: 0 0 12px;
      font-size: 20px;
    }

    #pix-modal textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 10px 12px;
      font-size: 13px;
      font-family: 'SFMono-Regular', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      resize: vertical;
      min-height: 90px;
    }

    #pix-modal img {
      max-width: 260px;
      width: 100%;
      height: auto;
      display: block;
      margin: 0 auto 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      padding: 8px;
    }

    #pix-modal .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
    }

    #pix-modal .pix-notice {
      font-size: 12px;
      color: #6b7280;
      margin-top: 12px;
      line-height: 1.5;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
    }

    .card-header h2 {
      margin: 0;
      font-size: 22px;
      color: #111827;
    }

    .card-header p {
      margin: 4px 0 0;
      color: #6b7280;
      font-size: 14px;
    }

    #tabs {
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid #e5e7eb;
    }

    #tabs-scroll {
      display: flex;
      overflow-x: auto;
      gap: 6px;
      padding: 6px 0;
      flex: 1 1 auto;
    }

    #tabs-scroll::-webkit-scrollbar {
      height: 6px;
    }

    #tabs-scroll::-webkit-scrollbar-thumb {
      background: rgba(79, 70, 229, 0.35);
      border-radius: 999px;
    }

    .tab {
      padding: 8px 12px;
      border-radius: 10px;
      background: #f3f4f6;
      cursor: pointer;
      white-space: nowrap;
      user-select: none;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .tab.active {
      background: #111827;
      color: #ffffff;
    }

    .tab .dirty {
      margin-left: 6px;
      color: #f59e0b;
      font-weight: 700;
    }

    #bot-actions {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }

    #bot-actions button {
      padding: 8px 12px;
      border-radius: 8px;
      background: #e5e7eb;
      color: #111827;
      font-size: 16px;
    }

    #bot-actions button:first-child {
      background: #6366f1;
      color: #ffffff;
    }

    #bot-actions button:first-child:hover {
      background: #4f46e5;
    }

    #bot-actions button:hover {
      background: #d1d5db;
    }

    #pane {
      padding-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .hidden {
      display: none !important;
    }

    #no-bots {
      border: 1px dashed #cbd5f5;
      border-radius: 12px;
      padding: 20px;
      color: #4b5563;
      background: #f8fafc;
      text-align: center;
      font-size: 14px;
    }

    #bot-header {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      font-size: 14px;
      color: #1f2937;
    }

    #bot-header > div {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    #bot-header code,
    #bot-header input {
      background: #11182710;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #cbd5f5;
      font-family: 'SFMono-Regular', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      font-size: 13px;
      color: #111827;
    }

    #bot-header input {
      flex: 1 1 auto;
      min-width: 140px;
      border: 1px solid #d1d5db;
      background: #ffffff;
    }

    #bot-header button {
      padding: 6px 10px;
      font-size: 14px;
      background: #e5e7eb;
      color: #1f2937;
    }

    #bot-header button:hover {
      background: #d1d5db;
    }

    .form-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
    }

    select,
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 10px 12px;
      font-size: 14px;
      background: #ffffff;
      color: inherit;
    }

    textarea {
      resize: vertical;
      min-height: 160px;
      line-height: 1.5;
    }

    #media-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #media-empty {
      border: 1px dashed #cbd5f5;
      border-radius: 10px;
      padding: 16px;
      text-align: center;
      color: #6b7280;
      font-size: 14px;
      background: #f8fafc;
    }

    .media-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      border: 1px solid #e5e5f7;
      border-radius: 12px;
      background: #f5f5ff;
    }

    .media-row select.media-type {
      width: 140px;
    }

    .media-row input.media-url {
      flex: 1 1 220px;
      min-width: 180px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }

    .media-file-btn {
      background: #eef2ff;
      border: 1px solid #c7d2fe;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      white-space: nowrap;
      font-size: 14px;
      color: #312e81;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 150px;
    }

    .media-file-btn:hover {
      background: #e0e7ff;
    }

    .dropzone {
      border: 1px dashed #c7d2fe;
      border-radius: 10px;
      padding: 12px;
      color: #4b5563;
      text-align: center;
      margin-top: 4px;
      font-size: 13px;
      transition: all 0.2s ease;
      width: 100%;
      flex-basis: 100%;
      background: #f8fafc;
    }

    .dropzone.dragover {
      background: #eef2ff;
      border-color: #6366f1;
      color: #1f2937;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #1f2937;
      padding: 8px 12px;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .actions {
      display: flex;
      justify-content: flex-end;
    }

    #save-start {
      padding: 12px 20px;
      font-size: 15px;
    }

    /* Repeater de mensagens iniciais */
    .start-msg-item {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
      background: #f9fafb;
    }
    .start-msg-item .msg-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .start-msg-item .msg-header strong {
      font-size: 14px;
      color: #374151;
    }
    .start-msg-item .msg-actions {
      display: flex;
      gap: 6px;
    }
    .start-msg-item .msg-actions button {
      padding: 4px 10px;
      font-size: 13px;
      background: #ffffff;
      border: 1px solid #d1d5db;
      color: #374151;
      border-radius: 6px;
      cursor: pointer;
    }
    .start-msg-item .msg-actions button:hover {
      background: #f3f4f6;
    }
    .start-msg-item .msg-actions button.remove {
      color: #dc2626;
      border-color: #fecaca;
    }
    .start-msg-item .msg-actions button.remove:hover {
      background: #fee2e2;
    }
    .start-msg-item textarea {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-family: inherit;
      resize: vertical;
    }

    dialog {
      border: none;
      border-radius: 12px;
      padding: 0;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 25px 70px rgba(17, 24, 39, 0.35);
    }

    dialog::backdrop {
      background: rgba(15, 23, 42, 0.45);
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 22px 26px 26px;
      min-width: 320px;
    }

    .modal-form h3 {
      margin: 0 0 8px;
      font-size: 20px;
      color: #111827;
    }

    .modal-form label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-weight: 600;
      color: #1f2937;
      font-size: 14px;
    }

    .modal-form > button {
      align-self: flex-start;
    }

    .modal-form input[type='text'],
    .modal-form input[type='password'],
    .modal-form input[type='url'] {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }

    .modal-form menu {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin: 12px 0 0;
      padding: 0;
    }

    .modal-form menu button[value='cancel'] {
      background: #e5e7eb;
      color: #1f2937;
    }

    .modal-form menu button[value='cancel']:hover {
      background: #d1d5db;
    }

    #toast {
      position: fixed;
      top: 24px;
      right: 24px;
      background: #111827;
      color: #ffffff;
      padding: 12px 16px;
      border-radius: 10px;
      box-shadow: 0 15px 45px rgba(17, 24, 39, 0.4);
      font-size: 14px;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      pointer-events: none;
      z-index: 1000;
    }

    #toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .status {
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
    }

    .status.success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .status.info {
      background: #e0f2fe;
      color: #075985;
      border: 1px solid #bae6fd;
    }

    @media (max-width: 720px) {
      body {
        padding: 16px;
      }

      .layout {
        padding: 20px;
      }

      header.top {
        align-items: stretch;
      }

      .card-header {
        flex-direction: column;
        align-items: stretch;
      }

      #bot-header {
        grid-template-columns: 1fr;
      }

      .token-input {
        flex-direction: column;
        align-items: stretch;
      }

      .token-input input,
      .token-input button {
        width: 100%;
      }
    }
    /* Elysia theme overrides */
    :root{
      /* base */
      --bg:#0d1117;
      --card-dark:#121826;
      --on-dark:#e8eef7;
      --on-light:#0b1220;
      --muted-dark:#9fb2c8;
      --muted-light:#5b6b81;
      --primary1:#19c3ff;
      --primary2:#4b7cff;
      --ring: rgba(73,140,255,.45);
      --radius:14px;
      /* modal claro */
      --modal-bg:#ffffff;
      --modal-text:#0b1220;
      --modal-border:#e8edf7;
    }

    /* fundo da p√°gina √© escuro, texto claro por padr√£o */
    body{ background:var(--bg); color:var(--on-dark) }

    /* === SUPERF√çCIES (contraste alto) === */
    /* Card CLARO (padr√£o): fundo branco, texto preto */
    .card{
      background:#ffffff;
      color:var(--on-light);
      border:1px solid #e8edf7;
      border-radius:var(--radius);
    }
    .card .muted{ color:var(--muted-light); }
    /* T√çTULOS/SE√á√ïES: sempre alto contraste */
    .card h1,
    .card h2,
    .card h3,
    .card h4,
    .card h5,
    .card h6{
      color:var(--on-light);
      letter-spacing:-.015em;
    }
    .card.dark h1,
    .card.dark h2,
    .card.dark h3,
    .card.dark h4,
    .card.dark h5,
    .card.dark h6{
      color:var(--on-dark);
    }
    /* Labels e textos auxiliares */
    .card label,
    .card .label{ color:#0f172a; font-weight:600; }
    .card.dark label,
    .card.dark .label{ color:#e2e8f0; }
    .card .muted{ color:#334155; }
    .card .tiny.muted{ color:#475569; font-size:13px; }

    /* Card ESCURO (opcional): use class="card dark" onde quiser escuro */
    .card.dark{
      background:var(--card-dark);
      color:var(--on-dark);
      border:1px solid rgba(255,255,255,.06);
    }
    .card.dark .muted{ color:var(--muted-dark); }

    /* Inputs se adaptam √† superf√≠cie do card onde est√£o */
    .card input,
    .card textarea,
    .card select{
      background:#ffffff;
      color:var(--on-light);
      border:1px solid #d0d7e2;
      border-radius:10px;
      padding:10px;
    }
    /* Placeholders leg√≠veis */
    .card ::placeholder{ color:#64748b; opacity:1 }
    .card.dark ::placeholder{ color:#b6c2d3; opacity:1 }
    /* Desabilitados com contraste */
    .card input[disabled],
    .card textarea[disabled],
    .card select[disabled]{
      background:#f1f5f9;
      color:#475569;
      border-color:#e2e8f0;
    }
    .card.dark input,
    .card.dark textarea,
    .card.dark select{
      background:#0b1220;
      color:var(--on-dark);
      border:1px solid #263246;
    }
    .card input:focus,
    .card textarea:focus,
    .card select:focus{
      outline:none;
      box-shadow:0 0 0 3px var(--ring), 0 0 0 1px #2b3b57;
    }
    .card.dark input:focus,
    .card.dark textarea:focus,
    .card.dark select:focus{
      outline:none;
      box-shadow:0 0 0 3px var(--ring), 0 0 0 1px #2b3b57;
    }
    /* linhas divis√≥rias vis√≠veis */
    .card hr{ border:0; height:1px; background:#e2e8f0; margin:16px 0 }
    .card.dark hr{ background:#273244 }

    /* Bot√µes */
    button{
      background:linear-gradient(135deg,var(--primary1),var(--primary2));
      color:#081018;
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:800;
    }
    button.secondary,
    .btn-secondary{
      background:#eef2f9;
      color:#0b1220;
      border:1px solid #d0d7e2;
    }

    /* Modal CLARO (for√ßa contraste) */
    .modal,
    dialog{
      background:var(--modal-bg)!important;
      color:var(--modal-text)!important;
      border:1px solid var(--modal-border)!important;
      border-radius:20px!important;
      box-shadow:0 20px 70px rgba(2,19,48,.35), 0 2px 8px rgba(2,19,48,.12)!important;
    }
    .modal h3,
    dialog h3{ font-weight:900; color:var(--modal-text)!important }
    dialog label{ color:#334155 }
    dialog input,
    dialog textarea,
    dialog select{
      background:#ffffff;
      color:var(--modal-text);
      border:1px solid #d0d7e2;
      border-radius:10px;
      padding:10px;
    }
    dialog input:focus,
    dialog textarea:focus,
    dialog select:focus{
      outline:none;
      box-shadow:0 0 0 3px rgba(47,128,237,.18), 0 0 0 1px #3b82f6;
      border-color:#3b82f6;
    }
    dialog .secondary{ background:#eef2f9; color:#0b1220; border:1px solid #d0d7e2 }
  </style>
  <!-- High-contrast fixes para o Admin Wizard -->
  <style id="aw-contrast-fixes">
    :root {
      --aw-fg: #111;
      --aw-muted: #444;
      --aw-bg: #fff;
    }

    /* Escopo: apenas elementos dentro do body desta p√°gina */
    #admin-wizard,
    #admin-wizard * {
      text-shadow: none !important;
    }

    /* T√≠tulos, r√≥tulos e textos principais */
    #admin-wizard h1,
    #admin-wizard h2,
    #admin-wizard h3,
    #admin-wizard h4,
    #admin-wizard h5,
    #admin-wizard h6,
    #admin-wizard label,
    #admin-wizard .form-label,
    #admin-wizard legend,
    #admin-wizard .section-title,
    #admin-wizard .field-title,
    #admin-wizard .card-title,
    #admin-wizard .text,
    #admin-wizard .title,
    #admin-wizard .text-body,
    #admin-wizard .subtitle {
      color: var(--aw-fg) !important;
    }

    /* Textos de apoio e placeholders */
    #admin-wizard small,
    #admin-wizard .form-text,
    #admin-wizard .help,
    #admin-wizard .hint,
    #admin-wizard .text-muted {
      color: var(--aw-muted) !important;
    }

    #admin-wizard ::placeholder {
      color: var(--aw-muted) !important;
      opacity: 1;
    }

    /* Inputs e campos com fundo claro */
    #admin-wizard input,
    #admin-wizard textarea,
    #admin-wizard select {
      color: var(--aw-fg) !important;
      background: var(--aw-bg) !important;
    }

    #admin-wizard .input-group-text {
      color: var(--aw-fg) !important;
      background: var(--aw-bg) !important;
    }

    /* Cards, pain√©is e modais */
    #admin-wizard .card,
    #admin-wizard .panel,
    #admin-wizard .modal-content {
      background: var(--aw-bg) !important;
      color: var(--aw-fg) !important;
    }

    #admin-wizard .modal-header,
    #admin-wizard .modal-body,
    #admin-wizard .modal-footer {
      background: var(--aw-bg) !important;
      color: var(--aw-fg) !important;
      border-color: #e5e7eb !important;
    }

    /* ====== Lista de planos ====== */
    /* Garante legibilidade do nome e do pre√ßo do plano */
    #admin-wizard #plans-list .plan-info,
    #admin-wizard #plans-list .plan-info * {
      color: var(--aw-fg) !important;   /* preto */
      opacity: 1 !important;            /* sem desbotar */
      text-shadow: none !important;
      filter: none !important;
    }
    /* Pre√ßo e status (ex.: "R$ 9,90 ‚Ä¢ ativo") */
    #admin-wizard #plans-list .plan-info .plan-price {
      color: var(--aw-fg) !important;
      opacity: 1 !important;
    }
    /* Nome do plano em leve destaque sem perder contraste */
    #admin-wizard #plans-list .plan-info > div:first-child {
      color: var(--aw-fg) !important;
      font-weight: 600; /* opcional, melhora leitura */
    }
    /* N√£o interferir nos bot√µes da linha */
    #admin-wizard #plans-list .plan-actions .btn { opacity: 1 !important; }

    /* ===== Planos por bot: for√ßa o nome do plano a ficar vis√≠vel ===== */
    /* Muitos templates usam text-muted/opacidade para o t√≠tulo do item. */
    #admin-wizard .list-group-item {
      color: var(--aw-fg) !important;
    }
    /* Qualquer texto do item que n√£o seja bot√£o deve ficar preto e 100% opaco */
    #admin-wizard .list-group-item :not(.btn) {
      color: var(--aw-fg) !important;
      opacity: 1 !important;
      filter: none !important;
    }
    /* Coberturas comuns para nomes/t√≠tulos */
    #admin-wizard .list-group-item .plan-name,
    #admin-wizard .list-group-item .plan-title,
    #admin-wizard .list-group-item .title,
    #admin-wizard .list-group-item .name,
    #admin-wizard .list-group-item strong,
    #admin-wizard .list-group-item b {
      color: var(--aw-fg) !important;
      opacity: 1 !important;
    }
    /* Classes de ‚Äútexto fraco‚Äù muito usadas em UI libs */
    #admin-wizard .list-group-item .text-muted,
    #admin-wizard .list-group-item .text-secondary,
    #admin-wizard .list-group-item [class*="text-gray"],
    #admin-wizard .list-group-item [class*="text-slate"] {
      color: var(--aw-fg) !important;
      opacity: 1 !important;
    }
    /* Itens marcados como disabled devem continuar leg√≠veis */
    #admin-wizard .list-group-item.disabled,
    #admin-wizard .list-group-item [aria-disabled="true"] {
      opacity: 1 !important;
      color: var(--aw-fg) !important;
    }
    /* N√£o mexer nos bot√µes (mant√©m contraste original do tema) */
    #admin-wizard .list-group-item .btn {
      opacity: 1 !important;
    }
  </style>
</head>
<body id="admin-wizard">
  <div class="layout">
    <header class="top">
      <div>
        <h1>ü§ñ Admin Wizard</h1>
        <p>Gerencie m√∫ltiplos bots do Telegram sem precisar de c√≥digo.</p>
      </div>
      <div class="token-card">
        <label for="admin-token">Admin Token</label>
        <div class="token-input">
          <input id="admin-token" type="password" placeholder="Cole aqui o ADMIN_API_TOKEN" autocomplete="off">
          <button id="apply-token" type="button">Usar token</button>
        </div>
        <small style="color:#6b7280;">O token fica salvo apenas neste navegador.</small>
      </div>
    </header>

    <main class="card">
      <div class="card-header">
        <div>
          <h2>Templates /start</h2>
          <p>Escolha um bot para editar mensagem inicial, m√≠dias e parse mode.</p>
        </div>
      </div>

      <div id="tabs">
        <div id="tabs-scroll"></div>
        <div id="bot-actions">
          <button id="btn-new-bot" type="button">+ Novo bot</button>
          <button id="btn-refresh-bots" type="button" title="Recarregar bots">‚Üª</button>
        </div>
      </div>

      <div id="no-bots" class="hidden">
        Nenhum bot encontrado. Informe o token de admin e clique em ‚Üª para carregar os bots cadastrados.
      </div>

      <div id="pane" class="hidden">
        <div id="bot-header" class="card-section">
          <div>Bot ID: <code id="hdr-bot-id"></code></div>
          <div>Slug: <code id="hdr-bot-slug"></code></div>
          <div>
            <span>Token:</span>
            <input id="hdr-bot-token" type="password" readonly class="mono" value="">
            <button id="reveal-token" type="button" title="Mostrar token">üëÅ</button>
          </div>
          <div>
            <span>Webhook:</span>
            <code id="hdr-webhook" class="mono"></code>
            <button id="copy-webhook" type="button">Copiar</button>
          </div>
          <div>
            <span>Warmup chat ID:</span>
            <input id="warmup-chat-id" type="text" placeholder="-1001234567890" class="mono" />
            <button id="save-warmup" type="button">Salvar</button>
            <button id="do-warmup" type="button">Aquecer agora</button>
          </div>
        </div>

        <div class="form-section">
          <div style="font-weight:600; color:#1f2937;">Cache de m√≠dias (diagn√≥stico)</div>
          <div id="media-cache-table">
            <div class="placeholder">Selecione um bot para visualizar o cache.</div>
          </div>
          <div style="margin-top:16px; display:flex; flex-direction:column; gap:8px;">
            <button id="btn-metrics" type="button" class="btn-secondary">Ver m√©tricas de envio (√∫ltimos 100)</button>
            <div id="metrics-box"></div>
          </div>
        </div>

        <div class="form-section">
          <label for="parse-mode">Parse Mode</label>
          <select id="parse-mode">
            <option value="Markdown">Markdown</option>
            <option value="HTML">HTML</option>
          </select>
        </div>

        <div class="form-section">
          <label>Mensagens iniciais (/start)</label>
          <div id="start-messages-list" style="display: flex; flex-direction: column; gap: 12px; margin-top: 8px;"></div>
          <div style="margin-top: 12px; display: flex; align-items: center; gap: 12px;">
            <button type="button" id="add-start-message" class="btn-secondary">+ Adicionar mensagem /start</button>
            <small style="color: #6b7280;">M√°x. 3 mensagens. Ser√£o enviadas ap√≥s as m√≠dias e antes dos planos.</small>
          </div>
          <!-- Campo legado mantido oculto para retrocompatibilidade -->
          <textarea id="start-text" style="display: none;"></textarea>
        </div>

        <div class="form-section">
          <div style="display:flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
            <label style="margin:0;">M√≠dias (foto, v√≠deo ou √°udio)</label>
            <button id="add-media" type="button" class="btn-secondary">‚ûï Adicionar m√≠dia</button>
          </div>
          <div id="media-empty">Nenhuma m√≠dia adicionada.</div>
          <div id="media-list"></div>
        </div>

        <div class="actions">
          <button id="save-start" type="button">Salvar Template /start</button>
        </div>

        <div id="status" class="status hidden"></div>
      </div>
    </main>

    <section id="plans-card" class="simple-card">
      <div>
        <h2>Planos por bot</h2>
        <p class="description">Cadastre planos (nome e pre√ßo) por <strong>slug</strong> de bot e gere pagamentos PIX instant√¢neos para testes.</p>
      </div>
      <div class="form-row">
        <div class="field">
          <label for="plans-bot-slug">Bot slug</label>
          <input id="plans-bot-slug" type="text" placeholder="ex.: hadrielle-maria" autocomplete="off" />
        </div>
        <button id="btn-load-plans" type="button">Carregar planos</button>
      </div>
      <div id="plans-list">
        <div class="placeholder">Informe o slug do bot e clique em "Carregar planos".</div>
      </div>
      <hr />
      <h3>Imagem para o PIX</h3>
      <p class="muted tiny">URL p√∫blica (ex.: do seu R2). Esta imagem ser√° enviada no Telegram ao gerar o PIX.</p>
      <div class="form-row" style="gap:12px; align-items:flex-end; flex-wrap:wrap;">
        <div class="field" style="flex:1 1 240px;">
          <label for="pix-img-url">URL da imagem</label>
          <input id="pix-img-url" type="url" placeholder="https://.../uploads/pix-help.png" autocomplete="off" />
        </div>
        <input type="file" id="pix-img-file" accept="image/*" style="display:none" />
        <button id="btn-pix-upload" type="button" class="btn-secondary">Enviar arquivo‚Ä¶</button>
        <button id="btn-pix-preview" type="button" class="btn-secondary">Pr√©-visualizar</button>
        <button id="btn-pix-save" type="button">Salvar imagem</button>
      </div>
      <div id="pix-img-preview" class="mt-2"></div>
      <hr />
      <h3>Texto que acompanha as ofertas (/start)</h3>
      <p class="muted tiny">Este texto aparece acima dos bot√µes dos planos.</p>
      <div class="form-row" style="gap:12px; flex-wrap:wrap;">
        <textarea id="offers-text" rows="3" style="flex:1 1 300px; min-width:200px" placeholder="Escolha uma oferta abaixo:"></textarea>
        <div style="display:flex; flex-direction:column; gap:8px">
          <button id="btn-offers-save" type="button">Salvar texto</button>
        </div>
      </div>
      <hr />
      <h3>Cadastro de plano</h3>
      <div class="form-row">
        <input type="hidden" id="plan-id" />
        <div class="field grow-2">
          <label for="plan-name">Nome do plano</label>
          <input id="plan-name" type="text" placeholder="ex.: 1 Semana" autocomplete="off" />
        </div>
        <div class="field">
          <label for="plan-price">Pre√ßo (R$)</label>
          <input id="plan-price" type="text" placeholder="ex.: 9,90" inputmode="decimal" autocomplete="off" />
        </div>
        <button id="btn-save-plan" type="button">Salvar plano</button>
      </div>
      <p class="plan-hint">* Valores s√£o convertidos para centavos; m√≠nimo R$ 0,50.</p>
    </section>

    <section id="downsells-card" class="simple-card">
      <div>
        <h2>Downsells por bot</h2>
        <p class="description">Crie ofertas para enviar automaticamente <strong>ap√≥s /start</strong> ou <strong>ap√≥s gerar o PIX</strong> com um atraso entre 5 e 60 minutos.</p>
      </div>
      <div class="form-row">
        <div class="field">
          <label for="downs-bot-slug">Bot slug</label>
          <input id="downs-bot-slug" type="text" placeholder="ex.: hadrielle-maria" autocomplete="off" />
        </div>
        <button id="btn-load-downs" type="button">Carregar downsells</button>
      </div>
      <div id="downs-list">
        <div class="placeholder">Informe o slug e clique em "Carregar downsells".</div>
      </div>
      <hr />
      <h3>Novo/Editar Downsell</h3>
      <div class="form-row" style="gap:12px; flex-wrap:wrap;">
        <input id="ds-id" type="hidden" />
        <div class="field" style="max-width:220px">
          <label for="ds-trigger">Disparar</label>
          <select id="ds-trigger">
            <option value="after_start">Ap√≥s /start</option>
            <option value="after_pix">Ap√≥s gerar PIX</option>
          </select>
        </div>
        <div class="field" style="max-width:180px">
          <label for="ds-delay">Delay (min)</label>
          <input id="ds-delay" type="number" min="5" max="60" value="10" />
        </div>
        <div class="field" style="min-width:240px; flex:1">
          <label for="ds-title">Nome do plano</label>
          <input id="ds-title" type="text" placeholder="ex.: Galeria Completa" />
        </div>
        <div class="field" style="max-width:180px">
          <label for="ds-price">Pre√ßo (R$)</label>
          <input id="ds-price" type="number" step="0.01" min="0.50" placeholder="ex.: 9,90" />
        </div>
      </div>
      <div class="form-row" style="gap:12px; flex-wrap:wrap;">
        <div class="field" style="min-width:280px; flex:1">
          <label for="ds-message">Mensagem (opcional)</label>
          <textarea id="ds-message" rows="2" placeholder="Copy do downsell..."></textarea>
        </div>
      </div>
      <div class="form-row" style="gap:12px; flex-wrap:wrap;">
        <div class="field">
          <label>M√≠dia 1 (opcional)</label>
          <div style="display:flex; gap:8px; align-items:center">
            <select id="ds-media1-type" style="max-width:150px">
              <option value="">-- tipo --</option>
              <option value="photo">Imagem</option>
              <option value="video">V√≠deo</option>
              <option value="audio">√Åudio</option>
            </select>
            <input id="ds-media1-url" type="url" placeholder="URL https://..." style="flex:1" />
            <input type="file" id="ds-media1-file" accept="image/*,video/*,audio/*" style="display:none" />
            <button id="btn-ds-media1-upload" type="button" class="btn-secondary">Enviar arquivo‚Ä¶</button>
          </div>
        </div>
        <div class="field">
          <label>M√≠dia 2 (opcional)</label>
          <div style="display:flex; gap:8px; align-items:center">
            <select id="ds-media2-type" style="max-width:150px">
              <option value="">-- tipo --</option>
              <option value="photo">Imagem</option>
              <option value="video">V√≠deo</option>
              <option value="audio">√Åudio</option>
            </select>
            <input id="ds-media2-url" type="url" placeholder="URL https://..." style="flex:1" />
            <input type="file" id="ds-media2-file" accept="image/*,video/*,audio/*" style="display:none" />
            <button id="btn-ds-media2-upload" type="button" class="btn-secondary">Enviar arquivo‚Ä¶</button>
          </div>
        </div>
      </div>
      <div class="form-row">
        <button id="btn-ds-save" type="button">Salvar Downsell</button>
        <button id="btn-ds-reset" type="button" class="btn-secondary">Limpar formul√°rio</button>
      </div>
    </section>
  </div>

  <dialog id="pix-modal">
    <h3 id="pix-title">Pagamento PIX</h3>
    <div>
      <img id="pix-qr" alt="QR Code PIX" src="" />
      <textarea id="pix-code" readonly placeholder="Copia e cola do PIX"></textarea>
      <div id="pix-notice"
           class="pix-notice"
           data-default="<strong>Entrega garantida <span style='background:none;color:#22c55e;-webkit-text-fill-color:#22c55e'>‚úÖ</span></strong>"
           style="text-align:center;font-weight:900;font-size:16px;background:linear-gradient(135deg,#19c3ff,#4b7cff);-webkit-background-clip:text;color:transparent">
        Entrega garantida <span style="background:none;color:#22c55e;-webkit-text-fill-color:#22c55e">‚úÖ</span>
      </div>
    </div>
    <div class="modal-actions">
      <button type="button" id="btn-copy-code" class="btn-secondary">Copiar c√≥digo</button>
      <button type="button" id="btn-close-pix">Fechar</button>
    </div>
  </dialog>

  <dialog id="new-bot-modal">
    <form method="dialog" id="new-bot-form" class="modal-form">
      <h3>Novo bot</h3>
      <label>Slug*
        <input id="nb-slug" required pattern="^[a-z0-9]+(?:-[a-z0-9]+)*$" />
      </label>
      <label>Token do Telegram*
        <input id="nb-token" required type="password" autocomplete="off" />
      </label>
      <button type="button" id="nb-test-token">Testar token</button>
      <label>Nome/T√≠tulo
        <input id="nb-title" />
      </label>
      <label>Secret webhook
        <input id="nb-secret" placeholder="(opcional)" />
      </label>
      <label><input type="checkbox" id="nb-sethook" checked /> Setar webhook automaticamente</label>
      <label><input type="checkbox" id="nb-empty" checked /> Criar template /start vazio</label>
      <menu>
        <button value="cancel">Cancelar</button>
        <button id="nb-create" value="default">Criar</button>
      </menu>
    </form>
  </dialog>

  <div id="toast" role="status" aria-live="polite"></div>

  <script>
    (() => {
      const tokenInput = document.getElementById('admin-token');
      const applyTokenBtn = document.getElementById('apply-token');
      const refreshBtn = document.getElementById('btn-refresh-bots');
      const newBotBtn = document.getElementById('btn-new-bot');
      const newBotModal = document.getElementById('new-bot-modal');
      const newBotForm = document.getElementById('new-bot-form');
      const paneEl = document.getElementById('pane');
      const noBotsEl = document.getElementById('no-bots');
      const tabsScroll = document.getElementById('tabs-scroll');
      const toastEl = document.getElementById('toast');
      const warmupChatInput = document.getElementById('warmup-chat-id');
      const saveWarmupBtn = document.getElementById('save-warmup');
      const doWarmupBtn = document.getElementById('do-warmup');
      const mediaCacheTable = document.getElementById('media-cache-table');
      const metricsBtn = document.getElementById('btn-metrics');
      const metricsBox = document.getElementById('metrics-box');
      let mediaCacheRequestId = 0;
      const nbSlugInput = document.getElementById('nb-slug');
      const nbTokenInput = document.getElementById('nb-token');
      const nbTitleInput = document.getElementById('nb-title');
      const nbSecretInput = document.getElementById('nb-secret');
      const nbSetHookInput = document.getElementById('nb-sethook');
      const nbEmptyInput = document.getElementById('nb-empty');
      const nbTestTokenBtn = document.getElementById('nb-test-token');
      const nbCreateBtn = document.getElementById('nb-create');
      const plansBotSlugInput = document.getElementById('plans-bot-slug');
      const plansList = document.getElementById('plans-list');
      const plansLoadBtn = document.getElementById('btn-load-plans');
      const planIdInput = document.getElementById('plan-id');
      const planNameInput = document.getElementById('plan-name');
      const planPriceInput = document.getElementById('plan-price');
      const planSaveBtn = document.getElementById('btn-save-plan');
      const pixImageUrlInput = document.getElementById('pix-img-url');
      const pixPreviewBtn = document.getElementById('btn-pix-preview');
      const pixSaveBtn = document.getElementById('btn-pix-save');
      const pixPreviewBox = document.getElementById('pix-img-preview');
      const pixModal = document.getElementById('pix-modal');
      const pixTitle = document.getElementById('pix-title');
      const pixQr = document.getElementById('pix-qr');
      const pixCode = document.getElementById('pix-code');
      const pixNotice = document.getElementById('pix-notice');
      const pixCopyBtn = document.getElementById('btn-copy-code');
      const pixCloseBtn = document.getElementById('btn-close-pix');
      const pixNoticeDefault = pixNotice ? pixNotice.innerHTML : '';
      const pixFile = document.getElementById('pix-img-file');
      const btnPixUpload = document.getElementById('btn-pix-upload');
      const offersText = document.getElementById('offers-text');
      const btnOffersSave = document.getElementById('btn-offers-save');

      renderPixPreview();

      let ADMIN_TOKEN = localStorage.getItem('admin_token') || '';
      if (ADMIN_TOKEN) {
        tokenInput.value = ADMIN_TOKEN;
      }

      const state = {
        bots: [],
        currentBotId: null,
        dirty: new Set(),
        cache: new Map(),
      };

      let toastTimer = null;

      function getAdminToken() {
        return (ADMIN_TOKEN || '').trim();
      }

      function showToast(message) {
        if (!message) return;
        if (!toastEl) {
          alert(message);
          return;
        }
        toastEl.textContent = message;
        toastEl.classList.add('show');
        if (toastTimer) {
          clearTimeout(toastTimer);
        }
        toastTimer = setTimeout(() => {
          toastEl.classList.remove('show');
        }, 3000);
      }

      function escapeHtml(value) {
        return String(value ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function priceToCents(value) {
        if (value === null || value === undefined) {
          return Number.NaN;
        }
        const normalized = String(value).trim().replace(/\./g, '').replace(',', '.');
        const number = Number(normalized);
        return Number.isFinite(number) ? Math.round(number * 100) : Number.NaN;
      }

      function centsToBRL(cents) {
        const number = Number(cents);
        if (!Number.isFinite(number)) {
          return 'R$¬†0,00';
        }
        return (number / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      }

      function renderMediaCachePlaceholder(message) {
        if (!mediaCacheTable) {
          return;
        }
        mediaCacheTable.innerHTML = '';
        const placeholder = document.createElement('div');
        placeholder.className = 'placeholder';
        placeholder.textContent = message;
        mediaCacheTable.appendChild(placeholder);
      }

      function setPlansPlaceholder(message) {
        if (!plansList) {
          return;
        }
        const placeholder = document.createElement('div');
        placeholder.className = 'placeholder';
        placeholder.textContent = message;
        plansList.innerHTML = '';
        plansList.appendChild(placeholder);
      }

      function resetPlanForm() {
        if (planIdInput) {
          planIdInput.value = '';
        }
        if (planNameInput) {
          planNameInput.value = '';
        }
        if (planPriceInput) {
          planPriceInput.value = '';
        }
      }

      function fillPlanForm(plan) {
        if (!plan) {
          return;
        }
        if (planIdInput) {
          planIdInput.value = plan.id != null ? String(plan.id) : '';
        }
        if (planNameInput) {
          planNameInput.value = typeof plan.plan_name === 'string' ? plan.plan_name : '';
        }
        if (planPriceInput) {
          const cents = Number(plan.price_cents);
          planPriceInput.value = Number.isFinite(cents)
            ? (cents / 100).toFixed(2).replace('.', ',')
            : '';
        }
        planNameInput?.focus();
      }

      function renderPixPreview() {
        if (!pixPreviewBox) {
          return;
        }

        const url = (pixImageUrlInput?.value || '').trim();
        pixPreviewBox.innerHTML = '';

        if (!url) {
          const empty = document.createElement('span');
          empty.className = 'muted tiny';
          empty.textContent = 'Nenhuma imagem configurada.';
          pixPreviewBox.appendChild(empty);
          return;
        }

        const img = document.createElement('img');
        img.src = url;
        img.alt = 'Imagem do PIX';
        img.style.maxWidth = '420px';
        img.style.borderRadius = '12px';
        img.style.border = '1px solid #e5e7eb';
        img.style.boxShadow = '0 12px 24px rgba(15, 23, 42, 0.18)';
        img.loading = 'lazy';
        pixPreviewBox.appendChild(img);
      }

      async function loadPixSettings(slug) {
        if (!pixImageUrlInput) {
          return;
        }

        try {
          const settings = await fetchJSON(`/api/bots/${encodeURIComponent(slug)}/settings`);
          const value = typeof settings?.pix_image_url === 'string' ? settings.pix_image_url : '';
          pixImageUrlInput.value = value;
          if (offersText) {
            offersText.value = typeof settings?.offers_text === 'string' ? settings.offers_text : '';
          }
          renderPixPreview();
        } catch (error) {
          console.warn('[pix] falha ao carregar imagem', error);
          pixImageUrlInput.value = '';
          if (offersText) {
            offersText.value = '';
          }
          renderPixPreview();
        }
      }

      async function loadPlans(options = {}) {
        if (!plansList) {
          return;
        }

        const { autoload = false } = options;
        const slug = (plansBotSlugInput?.value || '').trim();

        if (!slug) {
          if (!autoload) {
            alert('Informe o slug do bot.');
          }
          setPlansPlaceholder('Informe o slug do bot para listar planos.');
          return;
        }

        if (!getAdminToken()) {
          if (!autoload) {
            alert('Informe o token de admin para continuar.');
          }
          setPlansPlaceholder('Informe o token de admin para listar planos.');
          return;
        }

        setPlansPlaceholder('Carregando planos...');

        await loadPixSettings(slug);

        try {
          const data = await fetchJSON(`/api/bots/${encodeURIComponent(slug)}/plans`);
          const items = Array.isArray(data?.items) ? data.items : [];

          plansList.innerHTML = '';

          if (!items.length) {
            setPlansPlaceholder('Nenhum plano cadastrado para este bot.');
            return;
          }

          const fragment = document.createDocumentFragment();

          items.forEach((item) => {
            const row = document.createElement('div');
            row.className = 'plan-item';

            const info = document.createElement('div');
            info.className = 'plan-info';

            const title = document.createElement('div');
            title.textContent = typeof item.plan_name === 'string' ? item.plan_name : '';

            const price = document.createElement('div');
            price.className = 'plan-price';
            const statusLabel = item.is_active ? 'ativo' : 'inativo';
            price.textContent = `${centsToBRL(item.price_cents)} ‚Ä¢ ${statusLabel}`;

            info.appendChild(title);
            info.appendChild(price);

            const actions = document.createElement('div');
            actions.className = 'plan-actions';

            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'btn-secondary';
            editBtn.textContent = 'Editar';
            editBtn.addEventListener('click', () => fillPlanForm(item));

            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn-secondary';
            deleteBtn.textContent = 'Excluir';
            deleteBtn.addEventListener('click', () => removePlan(item));

            const pixBtn = document.createElement('button');
            pixBtn.type = 'button';
            pixBtn.textContent = 'Gerar PIX';
            pixBtn.disabled = !item.is_active;
            if (!item.is_active) {
              pixBtn.title = 'Plano inativo';
            }
            pixBtn.addEventListener('click', () => generatePlanPix(item));

            actions.append(editBtn, deleteBtn, pixBtn);

            row.append(info, actions);
            fragment.appendChild(row);
          });

          plansList.appendChild(fragment);
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao carregar planos.';
          setPlansPlaceholder(message);
          showToast(message);
        }
      }

      async function savePixImage() {
        const slug = (plansBotSlugInput?.value || '').trim();
        if (!slug) {
          alert('Informe o slug do bot.');
          return;
        }

        const url = (pixImageUrlInput?.value || '').trim();

        try {
          await fetchJSON(`/api/bots/${encodeURIComponent(slug)}/settings`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              pix_image_url: url || null,
              offers_text: offersText?.value || null
            }),
          });
          renderPixPreview();
          showToast('Imagem do PIX salva!');
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao salvar imagem do PIX.';
          alert(message);
        }
      }

      async function savePlan() {
        const slug = (plansBotSlugInput?.value || '').trim();
        const name = (planNameInput?.value || '').trim();
        const cents = priceToCents(planPriceInput?.value ?? '');
        const currentId = planIdInput?.value ? Number(planIdInput.value) : null;

        if (!slug || !name || !Number.isFinite(cents)) {
          alert('Preencha slug, nome e pre√ßo v√°lidos.');
          return;
        }

        if (cents < 50) {
          alert('Valor m√≠nimo √© R$ 0,50.');
          return;
        }

        const payload = {
          plan_name: name,
          price_cents: cents,
          is_active: true,
        };

        if (Number.isFinite(currentId) && currentId) {
          payload.id = currentId;
        }

        try {
          await fetchJSON(`/api/bots/${encodeURIComponent(slug)}/plans`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          resetPlanForm();
          showToast(currentId ? 'Plano atualizado.' : 'Plano criado.');
          await loadPlans({ autoload: true });
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao salvar plano.';
          alert(message);
        }
      }

      async function removePlan(plan) {
        if (!plan) {
          return;
        }

        const slug = typeof plan.bot_slug === 'string' ? plan.bot_slug : (plansBotSlugInput?.value || '').trim();
        if (!slug) {
          alert('N√£o foi poss√≠vel identificar o bot do plano.');
          return;
        }

        if (!confirm(`Excluir plano "${plan.plan_name}"?`)) {
          return;
        }

        try {
          await fetchJSON(`/api/bots/${encodeURIComponent(slug)}/plans/${plan.id}`, {
            method: 'DELETE',
          });
          showToast('Plano removido.');
          await loadPlans({ autoload: true });
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao excluir plano.';
          alert(message);
        }
      }

      async function generatePlanPix(plan) {
        if (!plan) {
          return;
        }

        const extra = window.prompt('Opcional: informe "telegram_id,payload_id" ou deixe vazio', '');
        let telegramId = null;
        let payloadId = null;

        if (extra && typeof extra === 'string') {
          const trimmed = extra.trim();
          if (trimmed.includes(',')) {
            const parts = trimmed.split(',');
            const maybeTelegram = Number(parts[0].trim());
            telegramId = Number.isFinite(maybeTelegram) ? maybeTelegram : null;
            const maybePayload = parts[1] ? parts[1].trim() : '';
            payloadId = maybePayload || null;
          } else if (trimmed.length) {
            const maybeTelegram = Number(trimmed);
            if (Number.isFinite(maybeTelegram)) {
              telegramId = maybeTelegram;
            } else {
              payloadId = trimmed;
            }
          }
        }

        const body = { plan_id: plan.id };
        if (telegramId !== null) {
          body.telegram_id = telegramId;
        }
        if (payloadId) {
          body.payload_id = payloadId;
        }

        try {
          const data = await fetchJSON('/api/payments/pushinpay/cash-in/by-plan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });

          if (pixTitle) {
            pixTitle.textContent = `${plan.plan_name} ‚Äî ${centsToBRL(plan.price_cents)}`;
          }
          if (pixQr) {
            pixQr.src = typeof data.qr_code_base64 === 'string' ? data.qr_code_base64 : '';
            pixQr.style.display = pixQr.src ? 'block' : 'none';
          }
          if (pixCode) {
            pixCode.value = typeof data.qr_code === 'string' ? data.qr_code : '';
          }
          if (pixNotice) {
            const fallback = pixNoticeDefault || pixNotice.getAttribute('data-default') || pixNotice.innerHTML;
            pixNotice.innerHTML = typeof data.notice_html === 'string' && data.notice_html
              ? data.notice_html
              : fallback;
          }

          if (pixModal && typeof pixModal.showModal === 'function') {
            pixModal.showModal();
          } else {
            alert('Seu navegador n√£o suporta o modal. C√≥digo PIX: ' + (pixCode ? pixCode.value : ''));
          }
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao gerar PIX.';
          alert(message);
        }
      }

      async function refreshMediaCache(slug) {
        if (!mediaCacheTable) {
          return;
        }
        if (!slug) {
          renderMediaCachePlaceholder('Configure o slug do bot para visualizar o cache.');
          return;
        }

        const requestId = ++mediaCacheRequestId;
        renderMediaCachePlaceholder('Carregando cache‚Ä¶');

        try {
          const data = await fetchJSON(`/admin/api/bots/${encodeURIComponent(slug)}/media-cache`);
          if (requestId !== mediaCacheRequestId) {
            return;
          }
          const items = Array.isArray(data?.items) ? data.items : [];
          if (items.length === 0) {
            renderMediaCachePlaceholder('Nenhum item no cache ainda.');
            return;
          }

          const table = document.createElement('table');
          const thead = document.createElement('thead');
          const headRow = document.createElement('tr');
          ['key', 'type', 'status', 'file_id', 'last_warmed'].forEach((label) => {
            const th = document.createElement('th');
            th.textContent = label;
            headRow.appendChild(th);
          });
          thead.appendChild(headRow);
          table.appendChild(thead);

          const tbody = document.createElement('tbody');
          items.forEach((item) => {
            const row = document.createElement('tr');

            const keyCell = document.createElement('td');
            keyCell.textContent = item.media_key || '';
            row.appendChild(keyCell);

            const typeCell = document.createElement('td');
            typeCell.textContent = item.media_type || '';
            row.appendChild(typeCell);

            const statusCell = document.createElement('td');
            statusCell.textContent = item.status || '';
            row.appendChild(statusCell);

            const fileCell = document.createElement('td');
            fileCell.textContent = item.file_id || '';
            row.appendChild(fileCell);

            const warmedCell = document.createElement('td');
            const warmedValue = item.last_warmed_at ? String(item.last_warmed_at) : '';
            warmedCell.textContent = warmedValue;
            row.appendChild(warmedCell);

            tbody.appendChild(row);
          });

          table.appendChild(tbody);
          mediaCacheTable.innerHTML = '';
          mediaCacheTable.appendChild(table);
        } catch (error) {
          if (requestId !== mediaCacheRequestId) {
            return;
          }
          const message = error instanceof Error ? error.message : 'Erro ao carregar cache.';
          renderMediaCachePlaceholder(message);
        }
      }

      metricsBtn?.addEventListener('click', loadMetrics);

      async function loadMetrics() {
        if (!metricsBox) {
          return;
        }
        metricsBtn?.setAttribute('disabled', 'disabled');
        metricsBox.innerHTML = '<div class="placeholder">Carregando m√©tricas‚Ä¶</div>';
        try {
          const [listData, statsData] = await Promise.all([
            fetchJSON('/admin/api/metrics/telegram-sends?limit=100'),
            fetchJSON('/admin/api/metrics/telegram-sends/stats'),
          ]);
          const items = Array.isArray(listData?.items) ? listData.items : [];
          const stats = statsData?.stats || {};

          const routeStats = stats.routes || {};
          const routesHtml = Object.keys(routeStats).length
            ? `<ul>${Object.keys(routeStats)
                .map((route) => {
                  const info = routeStats[route] || {};
                  const count = info.count ?? 0;
                  const p50 = info.p50_ms ?? '-';
                  const p95 = info.p95_ms ?? '-';
                  const p99 = info.p99_ms ?? '-';
                  return `<li><strong>${escapeHtml(route)}</strong>: count=${escapeHtml(count)} p50=${escapeHtml(p50)}ms p95=${escapeHtml(p95)}ms p99=${escapeHtml(p99)}ms</li>`;
                })
                .join('')}</ul>`
            : '<div class="placeholder">Sem m√©tricas por rota ainda.</div>';

          const rows = items
            .map((item) => {
              return `<tr>
                <td>${escapeHtml(item.ts)}</td>
                <td>${escapeHtml(item.bot_slug)}</td>
                <td>${escapeHtml(item.chat_id)}</td>
                <td>${escapeHtml(item.media_key || '')}</td>
                <td>${escapeHtml(item.route)}</td>
                <td>${item.ok ? 'ok' : 'erro'}</td>
                <td>${escapeHtml(item.tg_ms)}ms</td>
                <td>${escapeHtml(item.gapGlobal_ms)}ms</td>
                <td>${escapeHtml(item.gapChat_ms)}ms</td>
                <td>${escapeHtml(item.error || '')}</td>
              </tr>`;
            })
            .join('');

          const tableHtml = items.length
            ? `<div style="overflow:auto; max-height:320px; border:1px solid #e5e7eb; border-radius:8px;">
                <table class="table" style="width:100%; min-width:720px; border-collapse:collapse;">
                  <thead>
                    <tr>
                      <th>ts</th><th>bot</th><th>chat</th><th>key</th><th>rota</th>
                      <th>status</th><th>tg_ms</th><th>gapGlobal</th><th>gapChat</th><th>erro</th>
                    </tr>
                  </thead>
                  <tbody>${rows}</tbody>
                </table>
              </div>`
            : '<div class="placeholder">Nenhum envio registrado ainda.</div>';

          metricsBox.innerHTML = `
            <div><strong>Resumo:</strong> total=${escapeHtml(stats.total ?? 0)}</div>
            ${routesHtml}
            ${tableHtml}
          `;
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Falha ao carregar m√©tricas.';
          metricsBox.innerHTML = `<div class="placeholder">${escapeHtml(message)}</div>`;
          showToast(message);
        } finally {
          metricsBtn?.removeAttribute('disabled');
        }
      }

      async function fetchJSON(url, opts = {}) {
        const headers = new Headers(opts.headers || {});
        const token = getAdminToken();
        if (!token) {
          throw new Error('Informe o token de admin para continuar.');
        }
        if (!headers.has('Authorization')) {
          headers.set('Authorization', `Bearer ${token}`);
        }
        const response = await fetch(url, { ...opts, headers });
        const text = await response.text();
        let data = null;
        if (text) {
          try {
            data = JSON.parse(text);
          } catch (err) {
            data = text;
          }
        }
        if (!response.ok) {
          const message = typeof data === 'object' && data !== null && 'error' in data
            ? data.error
            : data || response.statusText || 'Erro desconhecido';
          throw new Error(typeof message === 'string' ? message : 'Erro ao carregar dados');
        }
        return data;
      }

      function updateNoBotsVisibility() {
        const hasBots = state.bots.length > 0;
        if (!hasBots) {
          state.currentBotId = null;
        }
        noBotsEl.classList.toggle('hidden', hasBots);
        paneEl.classList.toggle('hidden', !hasBots || !state.currentBotId);
        if (!hasBots || !state.currentBotId) {
          renderMediaCachePlaceholder('Selecione um bot para visualizar o cache.');
          if (plansBotSlugInput) {
            plansBotSlugInput.value = '';
          }
          if (plansList) {
            setPlansPlaceholder('Informe o slug do bot e clique em "Carregar planos".');
          }
        }
      }

      function deepClone(value) {
        return value == null ? value : JSON.parse(JSON.stringify(value));
      }

      function getCurrentBot() {
        if (!state.currentBotId) {
          return null;
        }
        return state.bots.find((bot) => bot.id === state.currentBotId) || null;
      }

      function getBotIdFromHash() {
        const match = new URL(window.location.href).hash.match(/bot=([a-f0-9-]+)/i);
        return match ? match[1] : null;
      }

      async function loadBots({ preserveSelection = true, selectBotId = null } = {}) {
        try {
          const bots = await fetchJSON('/admin/bots');
          const previousId = preserveSelection ? state.currentBotId : null;
          state.bots = Array.isArray(bots) ? bots : [];

          const ids = new Set(state.bots.map((b) => b.id));
          Array.from(state.cache.keys()).forEach((key) => {
            if (!ids.has(key)) {
              state.cache.delete(key);
            }
          });
          Array.from(state.dirty).forEach((key) => {
            if (!ids.has(key)) {
              state.dirty.delete(key);
            }
          });

          let targetId = null;
          if (typeof selectBotId === 'string' && ids.has(selectBotId)) {
            targetId = selectBotId;
          }
          if (!targetId) {
            const hashId = getBotIdFromHash();
            if (hashId && ids.has(hashId)) {
              targetId = hashId;
            }
          }
          if (!targetId && previousId && ids.has(previousId)) {
            targetId = previousId;
          }
          if (!targetId && state.bots[0]) {
            targetId = state.bots[0].id;
          }

          renderTabs();
          updateNoBotsVisibility();

          if (targetId) {
            await selectBot(targetId);
          }
        } catch (err) {
          alert(err instanceof Error ? err.message : 'Erro ao carregar bots.');
          state.bots = [];
          renderTabs();
          updateNoBotsVisibility();
        }
      }

      function renderTabs() {
        tabsScroll.innerHTML = '';
        state.bots.forEach((bot) => {
          const tab = document.createElement('div');
          tab.className = 'tab' + (bot.id === state.currentBotId ? ' active' : '');
          tab.dataset.id = bot.id;
          const label = bot.slug || bot.name || bot.id.slice(0, 8);
          tab.textContent = label;
          if (state.dirty.has(bot.id)) {
            const badge = document.createElement('span');
            badge.className = 'dirty';
            badge.textContent = '*';
            tab.appendChild(badge);
          }
          tab.onclick = () => selectBot(bot.id);
          tabsScroll.appendChild(tab);
        });
      }

      async function selectBot(botId) {
        const targetBot = state.bots.find((bot) => bot.id === botId);
        if (!targetBot) {
          return;
        }
        if (state.currentBotId === botId) {
          history.replaceState(null, '', `#bot=${botId}`);
          updateNoBotsVisibility();
          return;
        }

        if (state.currentBotId && state.dirty.has(state.currentBotId)) {
          state.cache.set(state.currentBotId, pane.read());
        }

        state.currentBotId = botId;
        if (plansBotSlugInput) {
          plansBotSlugInput.value = targetBot.slug || '';
        }
        resetPlanForm();
        if (targetBot.slug) {
          void loadPlans({ autoload: true });
        } else if (plansList) {
          setPlansPlaceholder('Informe o slug do bot e clique em "Carregar planos".');
        }
        history.replaceState(null, '', `#bot=${botId}`);
        renderTabs();
        updateNoBotsVisibility();
        await loadBotPane(botId);
      }

      async function loadBotPane(botId) {
        try {
          let data = state.cache.get(botId);
          if (!data) {
            const fresh = await fetchJSON(`/admin/bots/${botId}/templates/start`);
            data = normalizeTemplate(fresh);
            state.cache.set(botId, deepClone(data));
          }
          const keepDirty = state.dirty.has(botId);
          pane.fill(botId, normalizeTemplate(data), { keepDirty });
          paneEl.classList.remove('hidden');
        } catch (err) {
          alert(err instanceof Error ? err.message : 'Erro ao carregar template.');
        }
      }

      function normalizeTemplate(raw) {
        const fallback = { parse_mode: 'Markdown', text: '', start_messages: [], medias: [] };
        if (!raw || typeof raw !== 'object') {
          return fallback;
        }
        const parseMode = typeof raw.parse_mode === 'string' ? raw.parse_mode : fallback.parse_mode;
        const text = typeof raw.text === 'string' ? raw.text : fallback.text;
        
        // Normaliza start_messages: prefer√™ncia pelo array, fallback para text
        let startMessages = [];
        if (Array.isArray(raw.start_messages) && raw.start_messages.length > 0) {
          startMessages = raw.start_messages.map(s => String(s)).filter(Boolean);
        } else if (text) {
          startMessages = [text];
        }
        
        const list = Array.isArray(raw.medias)
          ? raw.medias
          : Array.isArray(raw.media)
          ? raw.media.map((item) => ({ type: item.type, url: item.media }))
          : [];
        const medias = list
          .filter((item) => item && typeof item === 'object')
          .map((item) => ({
            type: item.type === 'video' || item.type === 'audio' ? item.type : 'photo',
            url: typeof item.url === 'string' ? item.url : typeof item.media === 'string' ? item.media : '',
          }));
        return { parse_mode: parseMode, text, start_messages: startMessages, medias };
      }

      const pane = (() => {
        const parseSel = document.getElementById('parse-mode');
        const textArea = document.getElementById('start-text');
        const mediaList = document.getElementById('media-list');
        const mediaEmpty = document.getElementById('media-empty');
        const addMediaBtn = document.getElementById('add-media');
        const saveBtn = document.getElementById('save-start');
        const statusEl = document.getElementById('status');
        const revealTokenBtn = document.getElementById('reveal-token');
        const copyWebhookBtn = document.getElementById('copy-webhook');
        const tokenField = document.getElementById('hdr-bot-token');
        
        // Start messages repeater
        const startMessagesList = document.getElementById('start-messages-list');
        const addStartMessageBtn = document.getElementById('add-start-message');

        function clearStatus() {
          statusEl.textContent = '';
          statusEl.className = 'status hidden';
        }

        function showStatus(type, message) {
          statusEl.textContent = message;
          statusEl.className = `status ${type}`;
        }

        // Start messages repeater functions
        function getStartMessagesValues() {
          return Array.from(startMessagesList.querySelectorAll('.start-msg-text'))
            .map(textarea => textarea.value.trim())
            .filter(Boolean)
            .slice(0, 3);
        }

        function refreshAddMessageButton() {
          const count = startMessagesList.querySelectorAll('.start-msg-item').length;
          addStartMessageBtn.disabled = count >= 3;
        }

        function createStartMessageItem(value = '') {
          const wrapper = document.createElement('div');
          wrapper.className = 'start-msg-item';
          wrapper.innerHTML = `
            <div class="msg-header">
              <strong>Mensagem /start</strong>
              <div class="msg-actions">
                <button type="button" class="up" title="Mover para cima">‚Üë</button>
                <button type="button" class="down" title="Mover para baixo">‚Üì</button>
                <button type="button" class="remove" title="Remover">Excluir</button>
              </div>
            </div>
            <textarea class="start-msg-text" placeholder="Texto em Markdown/HTML conforme Parse Mode selecionado"></textarea>
          `;
          
          const textarea = wrapper.querySelector('.start-msg-text');
          textarea.value = value || '';
          textarea.addEventListener('input', () => notifyChange());
          
          wrapper.querySelector('.remove').addEventListener('click', () => {
            wrapper.remove();
            refreshAddMessageButton();
            notifyChange();
          });
          
          wrapper.querySelector('.up').addEventListener('click', () => {
            if (wrapper.previousElementSibling) {
              startMessagesList.insertBefore(wrapper, wrapper.previousElementSibling);
              notifyChange();
            }
          });
          
          wrapper.querySelector('.down').addEventListener('click', () => {
            if (wrapper.nextElementSibling) {
              startMessagesList.insertBefore(wrapper.nextElementSibling, wrapper);
              notifyChange();
            }
          });
          
          return wrapper;
        }

        addStartMessageBtn.addEventListener('click', () => {
          if (startMessagesList.querySelectorAll('.start-msg-item').length >= 3) return;
          startMessagesList.appendChild(createStartMessageItem(''));
          refreshAddMessageButton();
          notifyChange();
        });

        function updateMediaEmptyState() {
          const hasRows = mediaList.querySelector('.media-row');
          mediaEmpty.classList.toggle('hidden', Boolean(hasRows));
        }

        function serializeRow(row) {
          const typeSel = row.querySelector('.media-type');
          const urlInput = row.querySelector('.media-url');
          return {
            type: (typeSel?.value || 'photo'),
            url: (urlInput?.value || '').trim(),
          };
        }

        function notifyChange() {
          if (!state.currentBotId) return;
          clearStatus();
          state.dirty.add(state.currentBotId);
          state.cache.set(state.currentBotId, read());
          renderTabs();
        }

        function attachUpload(row) {
          const removeBtn = row.querySelector('.media-del');
          const fileInput = row.querySelector('.media-file');
          const urlInput = row.querySelector('.media-url');
          const typeSelect = row.querySelector('.media-type');
          const dropzone = row.querySelector('.dropzone');

          if (removeBtn) {
            removeBtn.addEventListener('click', () => {
              row.remove();
              updateMediaEmptyState();
              notifyChange();
            });
          }

          if (urlInput) {
            urlInput.addEventListener('input', () => notifyChange());
          }

          if (typeSelect) {
            typeSelect.addEventListener('change', () => notifyChange());
          }

          async function uploadFile(file) {
            if (!file) return;
            if (!/^(image|video|audio)\//.test(file.type || '')) {
              alert('Tipo de arquivo n√£o suportado. Selecione imagem, v√≠deo ou √°udio.');
              return;
            }
            if (file.size > 20 * 1024 * 1024) {
              alert('Arquivo maior que 20MB. Selecione um arquivo menor.');
              return;
            }

            const formData = new FormData();
            formData.append('file', file);

            const buttonLabel = row.querySelector('.media-file-btn span');
            const originalLabel = buttonLabel ? buttonLabel.textContent : '';
            if (buttonLabel) {
              buttonLabel.textContent = 'Enviando‚Ä¶';
            }

            try {
              const headers = new Headers();
              const token = getAdminToken();
              if (token) {
                headers.set('Authorization', `Bearer ${token}`);
              }
              const response = await fetch('/api/admin/upload', {
                method: 'POST',
                body: formData,
                headers,
              });
              const data = await response.json().catch(() => ({}));
              if (!response.ok || !data?.ok || !data?.url) {
                const reason = data?.error || response.statusText || 'Falha no upload.';
                alert(`Erro no upload: ${reason}`);
                return;
              }
              if (urlInput) {
                urlInput.value = data.url;
              }
              notifyChange();
            } catch (error) {
              console.error(error);
              alert('Erro ao enviar arquivo.');
            } finally {
              if (buttonLabel) {
                buttonLabel.textContent = originalLabel || 'Enviar arquivo‚Ä¶';
              }
              if (fileInput) {
                fileInput.value = '';
              }
            }
          }

          if (fileInput) {
            fileInput.addEventListener('change', (event) => {
              const file = event?.target?.files?.[0];
              void uploadFile(file);
            });
          }

          if (dropzone) {
            dropzone.addEventListener('dragover', (event) => {
              event.preventDefault();
              dropzone.classList.add('dragover');
            });
            dropzone.addEventListener('dragleave', () => {
              dropzone.classList.remove('dragover');
            });
            dropzone.addEventListener('drop', (event) => {
              event.preventDefault();
              dropzone.classList.remove('dragover');
              const file = event?.dataTransfer?.files?.[0];
              void uploadFile(file);
            });
          }
        }

        function addMediaRow(initial) {
          const row = document.createElement('div');
          row.className = 'media-row';
          row.innerHTML = `
            <select class="media-type">
              <option value="photo">Foto</option>
              <option value="video">V√≠deo</option>
              <option value="audio">√Åudio</option>
            </select>
            <input type="url" class="media-url" placeholder="https://...">
            <label class="media-file-btn">
              <input type="file" class="media-file" accept="image/*,video/*,audio/*" hidden>
              <span>Enviar arquivo‚Ä¶</span>
            </label>
            <button type="button" class="btn-secondary media-del" title="Remover">üóëÔ∏è</button>
            <div class="dropzone">Arraste e solte aqui ou clique em ‚ÄúEnviar arquivo‚Ä¶‚Äù</div>
          `;

          mediaList.appendChild(row);
          if (initial && typeof initial === 'object') {
            const typeSel = row.querySelector('.media-type');
            const urlInput = row.querySelector('.media-url');
            if (typeSel && initial.type) {
              typeSel.value = initial.type;
            }
            if (urlInput && initial.url) {
              urlInput.value = initial.url;
            }
          }

          attachUpload(row);
          updateMediaEmptyState();
          return row;
        }

        addMediaBtn.addEventListener('click', () => {
          addMediaRow();
          notifyChange();
        });

        parseSel.addEventListener('change', () => notifyChange());
        textArea.addEventListener('input', () => notifyChange());

        revealTokenBtn.addEventListener('click', () => {
          if (!tokenField.value) return;
          const isPassword = tokenField.type === 'password';
          tokenField.type = isPassword ? 'text' : 'password';
          revealTokenBtn.textContent = isPassword ? 'üôà' : 'üëÅ';
        });

        copyWebhookBtn.addEventListener('click', async () => {
          const webhook = document.getElementById('hdr-webhook').textContent || '';
          if (!webhook || webhook === '‚Äî') {
            return;
          }
          try {
            await navigator.clipboard.writeText(webhook);
            showStatus('info', 'Webhook copiado para a √°rea de transfer√™ncia.');
            setTimeout(clearStatus, 2500);
          } catch (err) {
            console.warn(err);
            window.prompt('Copie o webhook manualmente:', webhook);
          }
        });

        saveBtn.addEventListener('click', async () => {
          if (!state.currentBotId) return;
          try {
            showStatus('info', 'Salvando‚Ä¶');
            const botId = state.currentBotId;
            const payload = read();
            const body = {
              parse_mode: payload.parse_mode,
              text: payload.text,
              start_messages: payload.start_messages || [],
              media: payload.medias.map((item) => ({ type: item.type, media: item.url })),
            };
            await fetchJSON(`/admin/bots/${botId}/templates/start`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body),
            });
            state.cache.set(botId, deepClone(payload));
            state.dirty.delete(botId);
            renderTabs();
            showStatus('success', 'Template /start salvo com sucesso!');
            setTimeout(clearStatus, 3500);
          } catch (err) {
            showStatus('error', err instanceof Error ? err.message : 'Erro ao salvar template.');
          }
        });

        function fill(botId, data, options = {}) {
          const normalized = normalizeTemplate(data);
          clearStatus();
          parseSel.value = normalized.parse_mode || 'Markdown';
          textArea.value = normalized.text || '';

          // Populate start messages repeater
          startMessagesList.innerHTML = '';
          const messages = Array.isArray(normalized.start_messages) && normalized.start_messages.length > 0
            ? normalized.start_messages
            : (normalized.text ? [normalized.text] : ['']);
          messages.slice(0, 3).forEach(msg => {
            startMessagesList.appendChild(createStartMessageItem(msg));
          });
          refreshAddMessageButton();

          mediaList.innerHTML = '';
          (normalized.medias || []).forEach((item) => addMediaRow(item));
          updateMediaEmptyState();

          fillBotHeader(botId);

          if (!options.keepDirty) {
            state.dirty.delete(botId);
          }
          renderTabs();
        }

        function read() {
          const medias = Array.from(mediaList.querySelectorAll('.media-row'))
            .map((row) => serializeRow(row))
            .filter((item) => item.url);
          const startMessages = getStartMessagesValues();
          return {
            parse_mode: parseSel.value || 'Markdown',
            text: startMessages[0] || '',
            start_messages: startMessages,
            medias,
          };
        }

        return { fill, read, showStatus, clearStatus };
      })();

      function fillBotHeader(botId) {
        const bot = state.bots.find((b) => b.id === botId);
        if (!bot) return;
        const idEl = document.getElementById('hdr-bot-id');
        const slugEl = document.getElementById('hdr-bot-slug');
        const tokenEl = document.getElementById('hdr-bot-token');
        const webhookEl = document.getElementById('hdr-webhook');
        const copyBtn = document.getElementById('copy-webhook');
        const revealBtn = document.getElementById('reveal-token');

        idEl.textContent = bot.id;
        slugEl.textContent = bot.slug || '(sem slug)';
        tokenEl.type = 'password';
        revealBtn.textContent = 'üëÅ';
        if (bot.token) {
          tokenEl.value = bot.token;
        } else {
          tokenEl.value = '*****';
        }

        if (warmupChatInput instanceof HTMLInputElement) {
          warmupChatInput.value = bot.warmup_chat_id || '';
        }
        if (doWarmupBtn instanceof HTMLButtonElement) {
          doWarmupBtn.disabled = !bot.warmup_chat_id;
        }

        if (bot.slug) {
          void refreshMediaCache(bot.slug);
        } else {
          renderMediaCachePlaceholder('Configure o slug do bot para visualizar o cache.');
        }

        const origin = window.location.origin.replace(/\/$/, '');
        if (bot.slug) {
          webhookEl.textContent = `${origin}/tg/${bot.slug}/webhook`;
          copyBtn.disabled = false;
        } else {
          webhookEl.textContent = '‚Äî';
          copyBtn.disabled = true;
        }
      }

      saveWarmupBtn?.addEventListener('click', async () => {
        const bot = getCurrentBot();
        if (!bot || !bot.slug) {
          alert('Selecione um bot com slug configurado.');
          return;
        }
        const value = warmupChatInput instanceof HTMLInputElement ? warmupChatInput.value.trim() : '';
        if (!value) {
          alert('Informe o chat ID de warmup.');
          return;
        }
        try {
          await fetchJSON(`/admin/api/bots/${encodeURIComponent(bot.slug)}/warmup-chat`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ warmup_chat_id: value }),
          });
          bot.warmup_chat_id = value;
          if (doWarmupBtn instanceof HTMLButtonElement) {
            doWarmupBtn.disabled = false;
          }
          showToast('Warmup chat salvo!');
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao salvar warmup chat.';
          alert(message);
        }
      });

      doWarmupBtn?.addEventListener('click', async () => {
        const bot = getCurrentBot();
        if (!bot || !bot.slug) {
          alert('Selecione um bot com slug configurado.');
          return;
        }
        try {
          const response = await fetchJSON(`/admin/api/bots/${encodeURIComponent(bot.slug)}/warmup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({}),
          });
          const lines = Array.isArray(response?.results)
            ? response.results.map((item) => {
                if (item.status === 'warm') {
                  return `‚úÖ ${item.key} ‚Üí ${item.file_id || 'sem file_id'}`;
                }
                return `‚ùå ${item.key} ‚Üí ${item.error || 'erro desconhecido'}`;
              })
            : [];
          alert(`Warmup executado (${response?.count ?? 0} itens)\n${lines.join('\n')}`);
          if (bot.slug) {
            await refreshMediaCache(bot.slug);
          }
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao aquecer m√≠dias.';
          alert(message);
        }
      });

      plansLoadBtn?.addEventListener('click', () => {
        void loadPlans();
      });

      plansBotSlugInput?.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          void loadPlans();
        }
      });

      plansBotSlugInput?.addEventListener('input', () => {
        resetPlanForm();
      });

      planSaveBtn?.addEventListener('click', () => {
        void savePlan();
      });

      pixPreviewBtn?.addEventListener('click', () => {
        renderPixPreview();
      });

      pixSaveBtn?.addEventListener('click', () => {
        void savePixImage();
      });

      btnPixUpload?.addEventListener('click', () => pixFile?.click());

      pixFile?.addEventListener('change', async (e) => {
        const file = e.target?.files?.[0];
        if (!file) return;
        const fd = new FormData();
        fd.append('file', file);
        const token = getAdminToken();
        try {
          const res = await fetch('/api/uploads/pix-image', {
            method: 'POST',
            headers: token ? { 'Authorization': 'Bearer ' + token } : {},
            body: fd
          });
          const data = await res.json();
          if (!res.ok) {
            alert(data.error || 'Falha no upload');
            return;
          }
          if (pixImageUrlInput) {
            pixImageUrlInput.value = data.url;
          }
          renderPixPreview();
          showToast('Upload conclu√≠do!');
        } catch (error) {
          console.error(error);
          alert('Erro ao enviar arquivo.');
        } finally {
          if (pixFile) {
            pixFile.value = '';
          }
        }
      });

      btnOffersSave?.addEventListener('click', async () => {
        const slug = (plansBotSlugInput?.value || '').trim();
        if (!slug) {
          alert('Informe o slug do bot.');
          return;
        }
        try {
          await fetchJSON(`/api/bots/${encodeURIComponent(slug)}/settings`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              pix_image_url: pixImageUrlInput?.value || null,
              offers_text: offersText?.value || null
            }),
          });
          showToast('Texto salvo!');
        } catch (error) {
          const message = error instanceof Error ? error.message : 'Erro ao salvar texto.';
          alert(message);
        }
      });

      pixCloseBtn?.addEventListener('click', () => {
        if (pixModal && typeof pixModal.close === 'function') {
          pixModal.close();
        }
      });

      pixCopyBtn?.addEventListener('click', async () => {
        if (!pixCode) {
          return;
        }

        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(pixCode.value);
          } else {
            pixCode.select();
            if (document.execCommand) {
              document.execCommand('copy');
            }
          }
          showToast('C√≥digo PIX copiado!');
        } catch (error) {
          console.warn(error);
          alert('N√£o foi poss√≠vel copiar automaticamente. Copie manualmente.');
        }
      });

      if (newBotBtn && newBotModal && typeof newBotModal.showModal === 'function') {
        newBotBtn.addEventListener('click', () => {
          if (newBotForm) {
            newBotForm.reset();
          }
          if (nbSetHookInput) {
            nbSetHookInput.checked = true;
          }
          if (nbEmptyInput) {
            nbEmptyInput.checked = true;
          }
          if (nbSecretInput) {
            nbSecretInput.value = '';
          }
          if (nbTokenInput) {
            nbTokenInput.value = '';
          }
          newBotModal.showModal();
          if (nbSlugInput) {
            nbSlugInput.focus();
          }
        });
      } else if (newBotBtn) {
        newBotBtn.addEventListener('click', () => {
          alert('Seu navegador n√£o suporta a abertura do modal de novo bot.');
        });
      }

      nbTestTokenBtn?.addEventListener('click', async () => {
        const token = (nbTokenInput?.value || '').trim();
        if (!token) {
          alert('Informe o token');
          return;
        }
        try {
          const response = await fetch(`https://api.telegram.org/bot${token}/getMe`);
          const data = await response.json().catch(() => null);
          if (data?.ok) {
            const username = data?.result?.username ? `@${data.result.username}` : null;
            alert(username ? `Token OK: ${username}` : 'Token OK');
          } else {
            alert('Token inv√°lido');
          }
        } catch (error) {
          console.warn(error);
          alert('Token inv√°lido');
        }
      });

      nbCreateBtn?.addEventListener('click', async (event) => {
        event.preventDefault();

        const payload = {
          slug: (nbSlugInput?.value || '').trim(),
          token: (nbTokenInput?.value || '').trim(),
          title: (nbTitleInput?.value || '').trim(),
          secret: (nbSecretInput?.value || '').trim(),
          setWebhook: nbSetHookInput ? Boolean(nbSetHookInput.checked) : true,
          createEmptyTemplate: nbEmptyInput ? Boolean(nbEmptyInput.checked) : true,
        };

        if (!payload.slug || !/^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(payload.slug)) {
          alert('Slug inv√°lido');
          return;
        }
        if (!payload.token) {
          alert('Informe o token');
          return;
        }

        const adminToken = getAdminToken();
        if (!adminToken) {
          alert('Informe o token de admin para continuar.');
          return;
        }

        const body = {
          slug: payload.slug,
          token: payload.token,
          title: payload.title || null,
          secret: payload.secret || null,
          setWebhook: payload.setWebhook,
          createEmptyTemplate: payload.createEmptyTemplate,
        };

        try {
          if (nbCreateBtn) {
            nbCreateBtn.disabled = true;
          }
          const res = await fetch('/admin/bots', {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${adminToken}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
          });

          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            if (res.status === 409) {
              alert('Esse slug j√° est√° em uso.');
            } else if (err?.error === 'telegram_token_invalid') {
              alert('Token do Telegram inv√°lido.');
            } else if (err?.error === 'failed_to_set_webhook') {
              alert('N√£o foi poss√≠vel configurar o webhook automaticamente.');
            } else {
              alert(`Erro ao criar: ${res.status} ${err?.error || ''}`.trim());
            }
            return;
          }

          const bot = await res.json();
          const newBotId = bot && typeof bot.id === 'string' ? bot.id : null;
          newBotModal?.close();
          if (newBotForm) {
            newBotForm.reset();
          }
          await loadBots({ preserveSelection: false, selectBotId: newBotId });
          showToast('Bot criado');
        } catch (error) {
          console.error(error);
          alert('Falha ao criar bot');
        } finally {
          if (nbCreateBtn) {
            nbCreateBtn.disabled = false;
          }
        }
      });

      applyTokenBtn.addEventListener('click', () => {
        ADMIN_TOKEN = tokenInput.value.trim();
        if (!ADMIN_TOKEN) {
          alert('Informe o token de admin para continuar.');
          localStorage.removeItem('admin_token');
          state.bots = [];
          state.cache.clear();
          state.dirty.clear();
          state.currentBotId = null;
          renderTabs();
          updateNoBotsVisibility();
          return;
        }
        localStorage.setItem('admin_token', ADMIN_TOKEN);
        loadBots({ preserveSelection: false });
      });

      tokenInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          applyTokenBtn.click();
        }
      });

      refreshBtn?.addEventListener('click', () => {
        if (!getAdminToken()) {
          alert('Informe o token de admin para continuar.');
          return;
        }
        loadBots();
      });

      window.addEventListener('hashchange', () => {
        const targetId = getBotIdFromHash();
        if (targetId && targetId !== state.currentBotId) {
          void selectBot(targetId);
        }
      });

      window.addEventListener('beforeunload', (event) => {
        if (state.dirty.size) {
          event.preventDefault();
          event.returnValue = '';
        }
      });

      if (getAdminToken()) {
        loadBots();
      } else {
        updateNoBotsVisibility();
      }
    })();

  // ==== Downsells UI ====
  const downsBotSlug = document.getElementById('downs-bot-slug');
  const btnLoadDowns = document.getElementById('btn-load-downs');
  const downsList = document.getElementById('downs-list');
  const dsId = document.getElementById('ds-id');
  const dsTrigger = document.getElementById('ds-trigger');
  const dsDelay = document.getElementById('ds-delay');
  const dsTitle = document.getElementById('ds-title');
  const dsPrice = document.getElementById('ds-price');
  const dsMessage = document.getElementById('ds-message');
  const dsMedia1Type = document.getElementById('ds-media1-type');
  const dsMedia1Url = document.getElementById('ds-media1-url');
  const dsMedia1File = document.getElementById('ds-media1-file');
  const btnDsMedia1Upload = document.getElementById('btn-ds-media1-upload');
  const dsMedia2Type = document.getElementById('ds-media2-type');
  const dsMedia2Url = document.getElementById('ds-media2-url');
  const dsMedia2File = document.getElementById('ds-media2-file');
  const btnDsMedia2Upload = document.getElementById('btn-ds-media2-upload');
  const btnDsSave = document.getElementById('btn-ds-save');
  const btnDsReset = document.getElementById('btn-ds-reset');

  function cents(n){ return Math.round(Number(n)*100); }
  function brl(c){ return (c/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
  function adminHeaders(){ const h=new Headers(); const t=getAdminToken(); if(t) h.set('Authorization',`Bearer ${t}`); h.set('Content-Type','application/json'); return h; }
  function fillDownsellForm(item){
    dsId.value = item?.id ?? '';
    dsTrigger.value = item?.trigger_kind ?? 'after_start';
    dsDelay.value = item?.delay_minutes ?? 10;
    dsTitle.value = item?.title ?? '';
    dsPrice.value = item ? (item.price_cents/100).toFixed(2) : '';
    dsMessage.value = item?.message_text ?? '';
    dsMedia1Type.value = item?.media1_type ?? '';
    dsMedia1Url.value = item?.media1_url ?? '';
    dsMedia2Type.value = item?.media2_type ?? '';
    dsMedia2Url.value = item?.media2_url ?? '';
  }
  function renderDownsells(items){
    if(!items || items.length===0){
      downsList.innerHTML = '<div class="placeholder">Nenhum downsell ainda.</div>';
      return;
    }
    downsList.innerHTML = items.map(it => {
      return `<div class="card-section" style="display:flex; justify-content:space-between; gap:12px; align-items:center">
        <div style="flex:1">
          <div><strong>${it.title}</strong> ‚Äî ${brl(it.price_cents)}</div>
          <div class="muted tiny">${it.trigger_kind} ‚Ä¢ delay ${it.delay_minutes}min ‚Ä¢ ativo: ${it.is_active ? 'sim' : 'n√£o'}</div>
        </div>
        <div style="display:flex; gap:8px">
          <button type="button" data-act="edit" data-id="${it.id}">Editar</button>
          <button type="button" class="btn-secondary" data-act="test" data-id="${it.id}">Enviar teste</button>
          <button type="button" class="btn-secondary" data-act="delete" data-id="${it.id}">Excluir</button>
        </div>
      </div>`
    }).join('');
  }
  btnLoadDowns?.addEventListener('click', async () => {
    const slug = (downsBotSlug.value||'').trim();
    if(!slug){ alert('Informe o bot slug'); return; }
    const resp = await fetch(`/admin/api/downsells?bot_slug=${encodeURIComponent(slug)}`,{ headers: adminHeaders() });
    const data = await resp.json().catch(()=>({}));
    if(!resp.ok || !data?.ok){ alert('Falha ao carregar downsells'); return; }
    renderDownsells(data.items||[]);
  });
  downsList?.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button'); if(!btn) return;
    const id = Number(btn.getAttribute('data-id'));
    const act = btn.getAttribute('data-act');
    const slug = (downsBotSlug.value||'').trim();
    if(act==='edit'){
      const resp = await fetch(`/admin/api/downsells?bot_slug=${encodeURIComponent(slug)}`,{ headers: adminHeaders() });
      const data = await resp.json().catch(()=>({}));
      const item = (data.items||[]).find(x=>x.id===id);
      if(item) fillDownsellForm(item);
      window.scrollTo({top: document.getElementById('downsells-card').offsetTop - 16, behavior:'smooth'});
    } else if(act==='delete'){
      if(!confirm('Excluir este downsell?')) return;
      const resp = await fetch(`/admin/api/downsells/${id}?bot_slug=${encodeURIComponent(slug)}`,{ method:'DELETE', headers: adminHeaders() });
      const data = await resp.json().catch(()=>({}));
      if(!resp.ok || !data?.ok){ alert('Falha ao excluir'); return; }
      btnLoadDowns.click();
    } else if(act==='test'){
      const tg = prompt('Informe o Telegram ID para envio de teste:');
      if(!tg) return;
      const body = { downsell_id:id, bot_slug: slug, telegram_id: Number(tg) };
      const resp = await fetch('/admin/api/downsells/test-send',{ method:'POST', headers: adminHeaders(), body: JSON.stringify(body) });
      const data = await resp.json().catch(()=>({}));
      if(!resp.ok || !data?.ok){ alert('Falha ao agendar teste'); return; }
      alert('Agendado para agora. O worker enviar√° em at√© 1 minuto.');
    }
  });
  document.getElementById('btn-ds-save')?.addEventListener('click', async ()=>{
    const slug = (downsBotSlug.value||'').trim();
    if(!slug){ alert('Informe o bot slug'); return; }
    const price = cents(dsPrice.value);
    const body = {
      id: dsId.value ? Number(dsId.value) : undefined,
      bot_slug: slug,
      trigger_kind: dsTrigger.value,
      delay_minutes: Number(dsDelay.value),
      title: dsTitle.value,
      price_cents: price,
      message_text: dsMessage.value || null,
      media1_url: dsMedia1Url.value || null,
      media1_type: dsMedia1Type.value || null,
      media2_url: dsMedia2Url.value || null,
      media2_type: dsMedia2Type.value || null,
      is_active: true,
    };
    const resp = await fetch('/admin/api/downsells/upsert',{ method:'POST', headers: adminHeaders(), body: JSON.stringify(body) });
    const data = await resp.json().catch(()=>({}));
    if(!resp.ok || !data?.ok){ alert('Falha ao salvar'); return; }
    fillDownsellForm(null);
    btnLoadDowns.click();
  });
  document.getElementById('btn-ds-reset')?.addEventListener('click', ()=> fillDownsellForm(null));
  document.getElementById('btn-ds-media1-upload')?.addEventListener('click', ()=>{ document.getElementById('ds-media1-file').click(); });
  document.getElementById('ds-media1-file')?.addEventListener('change', async ()=>{
    const file = (document.getElementById('ds-media1-file') as HTMLInputElement).files?.[0]; if(!file) return;
    const formData = new FormData(); formData.append('file', file, file.name);
    const headers=new Headers(); const t=getAdminToken(); if(t) headers.set('Authorization',`Bearer ${t}`);
    const resp = await fetch('/api/admin/upload',{ method:'POST', body: formData, headers });
    const data = await resp.json().catch(()=>({}));
    if(!resp.ok || !data?.ok || !data?.url){ alert('Falha no upload'); return; }
    (document.getElementById('ds-media1-url') as HTMLInputElement).value = data.url;
  });
  document.getElementById('btn-ds-media2-upload')?.addEventListener('click', ()=>{ document.getElementById('ds-media2-file').click(); });
  document.getElementById('ds-media2-file')?.addEventListener('change', async ()=>{
    const file = (document.getElementById('ds-media2-file') as HTMLInputElement).files?.[0]; if(!file) return;
    const formData = new FormData(); formData.append('file', file, file.name);
    const headers=new Headers(); const t=getAdminToken(); if(t) headers.set('Authorization',`Bearer ${t}`);
    const resp = await fetch('/api/admin/upload',{ method:'POST', body: formData, headers });
    const data = await resp.json().catch(()=>({}));
    if(!resp.ok || !data?.ok || !data?.url){ alert('Falha no upload'); return; }
    (document.getElementById('ds-media2-url') as HTMLInputElement).value = data.url;
  });
  </script>
</body>
</html>
